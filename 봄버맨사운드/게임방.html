<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ê²Œì„ ì¤€ë¹„</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff" as="font" type="font/woff" crossorigin>
    <style>
        /* [ìˆ˜ì •] 1. ëŒ€ê¸°ì‹¤ í…Œë§ˆ :root */
        :root {
            --bg-color: #FFFBEB; /* ë”°ëœ»í•œ í¬ë¦¼ìƒ‰ ë°°ê²½ */
            --primary-color: #FF6B6B; /* í™œê¸°ì°¬ ì½”ë„ìƒ‰ */
            --secondary-color: #4ECDC4; /* ìƒì¾Œí•œ í‹¸(teal)ìƒ‰ */
            --accent-color: #FFD93D; /* ë°ì€ ë…¸ë€ìƒ‰ */
            --text-color-dark: #574141; /* ì–´ë‘ìš´ ê°ˆìƒ‰ */
            --text-color-light: #ffffff;
            --danger-color: #F76363;
            --panel-bg: #FFFFFF;
            --panel-border: #F0EAD2; /* ì—°í•œ ë² ì´ì§€ìƒ‰ í…Œë‘ë¦¬ */
            --panel-shadow: #E4DCCF; /* íŒ¨ë„ ê·¸ë¦¼ì */
            --font-main: 'GmarketSans', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-main);
            background-color: var(--bg-color); /* [ìˆ˜ì •] */
            color: var(--text-color-dark); /* [ìˆ˜ì •] */
            -webkit-user-select: none; user-select: none;
            touch-action: manipulation;
        }

        /* [ìˆ˜ì •] 2. ëŒ€ê¸°ì‹¤ : ì•„ì¼€ì´ë“œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .menu-btn {
            width: 100%; padding: 16px; font-size: 1.25em; font-weight: 900;
            font-family: var(--font-main);
            border-radius: 16px; border: none; cursor: pointer;
            transition: all 0.1s ease-out;
            border-bottom: 5px solid; /* 3D íš¨ê³¼ë¥¼ ìœ„í•œ ì•„ë˜ìª½ í…Œë‘ë¦¬ */
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
        }
        .menu-btn:active { transform: translateY(3px); border-bottom-width: 2px; }
        
        .menu-btn.primary {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border-bottom-color: #C04A4A; /* ê¸°ë³¸ ìƒ‰ìƒì˜ ì–´ë‘ìš´ ë²„ì „ */
        }
        .menu-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-color-light);
            border-bottom-color: #379A93;
        }
        .menu-btn.accent {
            background-color: var(--accent-color);
            color: var(--text-color-dark);
            border-bottom-color: #D1B030;
            text-shadow: none;
        }
         .menu-btn.light {
            background-color: #F8F9FA;
            color: var(--text-color-dark);
            border-bottom-color: #BDBDBD;
        }
        .menu-btn:disabled {
            background-color: #BDBDBD !important;
            color: #757575 !important;
            border-bottom-color: #8D8D8D !important;
            cursor: not-allowed;
            transform: none;
        }

        /* [ìˆ˜ì •] 3. ë ˆì´ì•„ì›ƒ ë° í—¤ë” (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
        .game-lobby-container { display: flex; flex-direction: column; width: 100%; height: 100%; margin: 0 auto; background-color: var(--panel-bg); }
        
        .game-lobby-header {
            padding: 15px;
            border-bottom: 3px solid var(--panel-border); /* [ìˆ˜ì •] */
            background-color: #FFFAE0; /* [ìˆ˜ì •] ëŒ€ê¸°ì‹¤ í—¤ë” ë°°ê²½ */
            color: var(--text-color-dark); /* [ìˆ˜ì •] */
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .header-title { text-align: center; flex-grow: 1; min-width: 0; }
        .game-lobby-header h1 {
            font-size: 1.4em; margin: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .game-lobby-header p {
            font-size: 0.8em; opacity: 0.8; margin: 2px 0 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .header-btn {
            font-family: 'GmarketSans', sans-serif;
            background: none; border: none;
            color: var(--text-color-dark); /* [ìˆ˜ì •] */
            font-size: 1.8em; font-weight: 700;
            cursor: pointer; padding: 0 10px;
            flex-shrink: 0;
            transition: opacity 0.2s;
        }
        .header-btn:active { opacity: 0.7; }
        .header-btn.leave { font-size: 2.5em; width: 50px; text-align: left; }
        .header-btn.invite {
            font-size: 0.9em; /* [ìˆ˜ì •] 1.0em -> 0.9em */
            font-weight: 900;
            background-color: var(--secondary-color); /* [ìˆ˜ì •] secondary ìƒ‰ìƒ */
            color: var(--text-color-light);
            border-radius: 12px;
            padding: 8px 12px; /* [ìˆ˜ì •] 10px 16px -> 8px 12px */
            border-bottom: 4px solid #379A93; /* [ìˆ˜ì •] secondary ì–´ë‘ìš´ ë²„ì „ */
            box-shadow: none;
            width: auto; /* ê³ ì • í­ ì œê±° */
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        .header-btn.invite:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        .header-buttons-wrapper {
            display: flex;
            flex-shrink: 0;
            gap: 8px; /* ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
        }

        .header-btn.invite:disabled {
            background-color: #BDBDBD !important;
            color: #757575 !important;
            border-bottom-color: #8D8D8D !important;
            cursor: not-allowed;
            transform: none;
        }
           
        
        .game-lobby-main { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; overflow: hidden; }
        
        /* [ìˆ˜ì •] 4. í”Œë ˆì´ì–´ ëª©ë¡ (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
        #player-list-wrapper {
            padding: 15px;
            border-bottom: 3px solid var(--panel-border); /* [ìˆ˜ì •] */
            background-color: #FFFAE0; /* [ìˆ˜ì •] */
            flex-shrink: 0;
        }
        #player-list-horizontal { display: flex; overflow-x: auto; gap: 15px; padding-bottom: 10px; }
        #player-list-horizontal::-webkit-scrollbar { height: 5px; }
        #player-list-horizontal::-webkit-scrollbar-thumb { background: #ccc; border-radius: 5px; }
        
       /* [ìˆ˜ì •] 5. í”Œë ˆì´ì–´ ìŠ¬ë¡¯ (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
.player-slot-compact { flex-shrink: 0; width: 90px; text-align: center; position: relative; /* [ìˆ˜ì •] ë ˆë²¨ ë°°ì§€ ë° ê°•í‡´ ë²„íŠ¼ì˜ ê¸°ì¤€ì  */ }

        /* âœ¨ [ì‹ ê·œ] ìŠ¤í¬íŠ¸ë¼ì´íŠ¸(ë³„ê°€ë£¨) ì¥ì°© ì‹œ ì•„ë°”íƒ€ ë°°ê²½ ë³€ê²½ */
        .player-slot-compact .avatar.effect-spotlight-equipped-bg {
            background-color: #341f4b; /* âœ¨ ì–´ë‘ìš´ ë°¤í•˜ëŠ˜ìƒ‰ */
            transition: background-color 0.5s ease;
        }

        .player-slot-compact .avatar {
            width: 70px; /* âœ¨ 60px -> 70px */
            height: 70px; /* âœ¨ 60px -> 70px */
            margin: 0 auto 4px; /* [ìˆ˜ì •] 8px -> 4px (ë°°ì§€ ê³µê°„) */
            background-color: var(--panel-bg); /* [ìˆ˜ì •] */
            border-radius: 12px; /* âœ¨ 12px (ì‚¬ê°í˜•) */
            display: flex; justify-content: center; align-items: center;
            font-size: 3em; /* âœ¨ 2em -> 3em (ì´ëª¨ì§€ í¬ê¸°) */
            position: relative;
            border: 3px solid var(--text-color-dark); /* [ìˆ˜ì •] */
            overflow: hidden; /* âœ¨ 'ë³„ê°€ë£¨' íš¨ê³¼ë¥¼ ìœ„í•´ hidden ì¶”ê°€ */
        }
        .player-slot-compact .avatar img { width: 100%; height: 100%; object-fit: contain; /* border-radius: 50% ì œê±° */ }
        .player-slot-compact.is-host .avatar {
            border-color: var(--accent-color); /* [ìˆ˜ì •] */
        }
        .player-slot-compact.is-host .nickname {
            color: var(--accent-color);
            text-shadow: 0 0 8px rgba(255, 200, 74, 0.7);
        }
        .player-slot-compact .nickname { 
            font-size: 0.9em; 
            font-weight: 700; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }
        
        /* [ìˆ˜ì •] 6. ì±„íŒ…ì°½ (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
        #chat-container {
            flex-grow: 1; display: flex; flex-direction: column;
            padding: 10px; overflow-y: auto;
            background-color: var(--bg-color); /* [ìˆ˜ì •] */
        }
        .chat-message { display: flex; margin-bottom: 12px; max-width: 85%; align-self: flex-start; }
        .chat-message.my-message { align-self: flex-end; }
        .chat-message .sender-avatar {
            width: 36px; height: 36px; border-radius: 50%; font-size: 1.6em;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; margin-right: 10px;
            background-color: var(--panel-bg); /* [ìˆ˜ì •] */
            border: 2px solid var(--panel-border); /* [ìˆ˜ì •] */
            overflow: hidden; /* [ì¶”ê°€] */
        }
        .chat-message .sender-avatar img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .chat-message.my-message .sender-avatar { display: none; }
        .chat-message .msg-body { display: flex; flex-direction: column; }
        .chat-message .sender {
            font-weight: 700; font-size: 0.9em;
            color: var(--primary-color); /* [ìˆ˜ì •] */
            margin-bottom: 4px;
        }
        .chat-message.my-message .sender { display: none; }
        .chat-message .content {
            padding: 10px 14px; border-radius: 12px; /* [ìˆ˜ì •] */
            background-color: var(--panel-bg); /* [ìˆ˜ì •] */
            border: 2px solid var(--panel-border); /* [ìˆ˜ì •] */
            display: inline-block; word-break: break-word; text-align: left;
        }
        /* [ìˆ˜ì •] ë‚´ ë©”ì‹œì§€ (ëŒ€ê¸°ì‹¤ ìŠ¤íƒ€ì¼) */
        .chat-message.my-message .content {
            background-color: var(--accent-color);
            border-color: #D1B030;
            color: var(--text-color-dark);
        }
        .system-message {
            text-align: center; font-size: 0.85em; font-weight: 700;
            color: #9A6A3A; /* [ìˆ˜ì •] */
            margin: 10px 0;
            background-color: #FFFAE0; /* [ìˆ˜ì •] */
            padding: 5px; border-radius: 8px;
            border: 2px dashed var(--panel-border); /* [ìˆ˜ì •] */
        }

        /* [ìˆ˜ì •] 7. ì±„íŒ… í‘¸í„° (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
        .game-lobby-footer {
            padding: 15px; /* [ìˆ˜ì •] */
            border-top: 3px solid var(--panel-border); /* [ìˆ˜ì •] */
            display: flex; flex-direction: column;
            flex-shrink: 0;
            background-color: #FFFAE0; /* [ìˆ˜ì •] */
        }
        #start-game-btn {
            font-size: 1.1em;
            padding: 14px;
        }
        #chat-controls { display: flex; gap: 8px; align-items: center; position: relative;}
        #chat-input {
            flex-grow: 1;
            border: 2px solid var(--text-color-dark); /* [ìˆ˜ì •] */
            background-color: #fff;
            border-radius: 12px; /* [ìˆ˜ì •] */
            padding: 12px; /* [ìˆ˜ì •] */
            font-size: 1em; font-family: 'GmarketSans', sans-serif;
            min-width: 0;
        }
        #chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        /* [ìˆ˜ì •] ì±„íŒ… ì…ë ¥ì°½ (ë²„íŠ¼ 3ê°œ ê³µê°„ í™•ë³´) */
        #chat-input {
            /* ë§ˆì´í¬+ì„¤ì •+ì´ëª¨ì§€+ì „ì†¡ ë²„íŠ¼ ì˜ì—­ í™•ë³´ */
            padding-right: 190px; 
        }

        /* [ì‹ ê·œ] ì±„íŒ… ì„¤ì • í†±ë‹ˆë°”í€´ ë²„íŠ¼ */
        #chat-settings-btn {
            font-size: 1.6em; background: none; border: none;
            cursor: pointer; padding: 5px;
            color: var(--text-color-dark);
            transition: color 0.2s, transform 0.2s;
            position: absolute;
            right: 150px; /* ë§ˆì´í¬(115px) ì¢Œì¸¡ */
            top: 50%; transform: translateY(-50%);
            z-index: 5;
        }
        #chat-settings-btn:active {
             transform: translateY(-50%) scale(0.9);
        }

        /* [ìˆ˜ì •] ë§ˆì´í¬ ë²„íŠ¼ ìœ„ì¹˜ (ì„¤ì • ë²„íŠ¼ìœ¼ë¡œ ì¸í•´ ì´ë™) */
        #mic-btn {
             right: 115px; /* ì´ëª¨ì§€(80px) ì¢Œì¸¡ */
        }
        /* --- [ì‹ ê·œ] TTS ì„¤ì • í† ê¸€ ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ --- */
        .toggle-switch-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .toggle-switch-label {
            font-weight: 700;
            font-size: 0.9em;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px; /* ë„ˆë¹„ */
            height: 28px; /* ë†’ì´ */
        }
        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px; /* ë™ê·¸ë¼ë¯¸ ë†’ì´ */
            width: 20px; /* ë™ê·¸ë¼ë¯¸ ë„ˆë¹„ */
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px); /* ë™ê·¸ë¼ë¯¸ ì´ë™ ê±°ë¦¬ */
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        /* --- [ì‹ ê·œ] í† ê¸€ ìŠ¤ìœ„ì¹˜ ë --- */
        /* [ìˆ˜ì •] ì±„íŒ… ì…ë ¥ì°½ (ë§ˆì´í¬/ì´ëª¨ì§€ ë²„íŠ¼ ê³µê°„ í™•ë³´) */
        #chat-input {
            padding-right: 150px; /* ë§ˆì´í¬+ì´ëª¨ì§€+ì „ì†¡ ë²„íŠ¼ ì˜ì—­ í™•ë³´ */
        }
        
        /* [ì‹ ê·œ] ìŒì„± ì±„íŒ… ë§ˆì´í¬ ë²„íŠ¼ */
        #mic-btn {
            font-size: 1.6em; background: none; border: none;
            cursor: pointer; padding: 5px;
            color: var(--text-color-dark);
            transition: color 0.2s, transform 0.2s;
            position: absolute;
            right: 115px; /* ì´ëª¨ì§€(80px) ì¢Œì¸¡ */
            top: 50%; transform: translateY(-50%);
            z-index: 5;
        }
        #mic-btn:active {
             transform: translateY(-50%) scale(0.9);
        }
        #mic-btn.recording {
            color: var(--primary-color);
            animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { transform: translateY(-50%) scale(1); }
            50% { transform: translateY(-50%) scale(1.1); }
            100% { transform: translateY(-50%) scale(1); }
        }
        /* [ìˆ˜ì •] ë§ˆì´í¬ ë²„íŠ¼ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ì´ëª¨ì§€ ë²„íŠ¼ z-index ìˆ˜ì • */
        #emoji-toggle-btn {
             z-index: 5;
        }
        #send-chat-btn {
            padding: 0 20px; /* [ìˆ˜ì •] */
            font-size: 1em; /* [ìˆ˜ì •] */
            font-weight: 700; /* [ìˆ˜ì •] */
            border-radius: 12px; /* [ìˆ˜ì •] */
            border: none;
            background-color: var(--primary-color);
            color: white; cursor: pointer;
            width: auto; /* [ìˆ˜ì •] */
            height: 48px; /* [ìˆ˜ì •] */
            display:flex; justify-content:center; align-items:center;
            flex-shrink: 0;
            border-bottom: 4px solid #C04A4A; /* [ìˆ˜ì •] */
        }
        #send-chat-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        #emoji-toggle-btn {
            font-size: 1.6em; background: none; border: none;
            cursor: pointer; padding: 5px;
            color: var(--text-color-dark); /* [ìˆ˜ì •] */
            position: absolute; /* [ì¶”ê°€] */
            right: 80px; /* [ì¶”ê°€] ì „ì†¡ ë²„íŠ¼ ì˜† */
            top: 50%; transform: translateY(-50%);
        }
        #emoji-popover {
            display: none; position: absolute; bottom: calc(100% + 5px); left: 5px;
            background: var(--panel-bg);
            border: 3px solid var(--text-color-dark); /* [ìˆ˜ì •] */
            border-radius: 12px;
            box-shadow: 4px 4px 0px 0px var(--text-color-dark); /* [ìˆ˜ì •] */
            padding: 10px; grid-template-columns: repeat(4, 1fr);
            gap: 10px; z-index: 10;
        }
        #emoji-popover.active { display: grid; }
        #emoji-popover button { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 5px; }
        
/* âœ¨ [ìˆ˜ì •] ì…ì¥ ì´í™íŠ¸ ìŠ¤íƒ€ì¼ (ì§€ì†í˜•) */
        .entry-effect-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* í´ë¦­ ë°©ì§€ */
            z-index: 10;
        }
        
        /* 1. ë°˜ì§ì„ (í‹¸(teal) ìƒ‰ìƒ ê¹œë¹¡ì„ íš¨ê³¼ - ìœ ì§€) */
        @keyframes teal-pulse-anim {
            0%, 100% {
                /* âœ¨ border-color ì œê±° -> box-shadow + inset shadow */
                box-shadow: 0 0 10px 2px var(--secondary-color), inset 0 0 10px 2px var(--secondary-color);
                opacity: 0.6;
            }
            50% {
                box-shadow: 0 0 15px 5px var(--secondary-color), inset 0 0 15px 5px var(--secondary-color);
                opacity: 1;
            }
        }
        .effect-sparkle-persistent {
            /* âœ¨ [ìˆ˜ì •] box-shadow ë°©ì‹ìœ¼ë¡œ ë³€ê²½ (overflow:hidden í˜¸í™˜) */
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            /* border: 3px solid transparent; */ /* ì œê±° */
            animation: teal-pulse-anim 2.5s ease-in-out infinite; 
            z-index: 10; /* âœ¨ 'ë°˜ì§ì„'ì´ 'ë³„ê°€ë£¨'ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
        }
        
        /* 2. ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ (âœ¨ 'ë³„ê°€ë£¨ ë¹„' ìŠ¤íƒ€ì¼ë¡œ ë³€ê²½) */
        @keyframes star-fall {
            0% { 
                transform: translateY(-20px); /* ìŠ¬ë¡¯ ìœ„ì—ì„œ ì‹œì‘ */
                opacity: 0; 
            }
            10% { opacity: 1; } /* ë‚˜íƒ€ë‚˜ê¸° */
            90% { opacity: 1; } /* ë–¨ì–´ì§€ê¸° */
            100% { 
                transform: translateY(70px); /* ìŠ¬ë¡¯(60px) ì•„ë˜ë¡œ ì‚¬ë¼ì§ */
                opacity: 0; 
            }
        }
        
        .effect-spotlight-persistent {
            /* ì´ í´ë˜ìŠ¤ ìì²´ëŠ” ì»¨í…Œì´ë„ˆ ì—­í• ë§Œ í•¨ */
            width: 100%;
            height: 100%;
            border-radius: 12px; /* âœ¨ 12px (ì‚¬ê°í˜•) */
            overflow: hidden; /* âœ¨ ë³„ê°€ë£¨ê°€ ì› ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ */
            z-index: 5; /* âœ¨ ë°˜ì§ì„ë³´ë‹¤ ì•„ë˜ì— ì˜¤ë„ë¡ */
        }

        /* 2-1. ë³„ê°€ë£¨ ì…ì (::before) - ë¹ ë¦„ */
        .effect-spotlight-persistent::before {
            content: '';
            position: absolute;
            top: 0; /* ìƒë‹¨ ê³ ì • */
            left: 50%;
            width: 2px; /* ì…ì í¬ê¸° */
            height: 2px;
            background: #FFF;
            border-radius: 50%;
            
            /* âœ¨ box-shadowë¡œ ì—¬ëŸ¬ ê°œì˜ ë³„ ìƒì„± (ê°€ë¡œ 60px ë²”ìœ„) */
            box-shadow: 
                -20px 10px #FFF, 15px 25px #FFF, 0px 40px #FFF, 
                -10px 55px #FFF, 25px 5px #FFF, -5px 30px #FFF;
            
            animation: star-fall 1.5s linear infinite;
            animation-delay: -0.5s; /* ì¦‰ì‹œ ì‹œì‘ */
        }
        
        /* 2-2. ë³„ê°€ë£¨ ì…ì (::after) - ëŠë¦¼ (ì‹œì°¨) */
        .effect-spotlight-persistent::after {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            width: 2px;
            height: 2px;
            background: #FFF;
            border-radius: 50%;
            
            /* âœ¨ ë‹¤ë¥¸ ìœ„ì¹˜ì— ë³„ ìƒì„± */
            box-shadow: 
                10px 18px #FFF, -15px 35px #FFF, 5px 50px #FFF, 
                -25px 8px #FFF, 20px 22px #FFF, -8px 42px #FFF;
            
            animation: star-fall 2.5s linear infinite; /* âœ¨ 1.5s -> 2.5s (ë” ëŠë¦¬ê²Œ) */
        }

        /* [ì‹ ê·œ] ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬ */
        #friend-invite-modal .modal-header {
            padding: 15px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-bottom: 4px solid #379A93;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        #friend-invite-modal .modal-header h2 {
            font-size: 1.25em;
            margin: 0;
            color: white;
            text-align: center;
            flex-grow: 1;
        }
        #friend-invite-modal .modal-header .close-btn {
            background: none; border: none; color: white;
            font-size: 2.5em; cursor: pointer;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0 10px;
            line-height: 1;
        }
        #friend-invite-modal .modal-body {
            padding: 0;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* [ì‹ ê·œ] ìœ ì € ëª©ë¡ (ì¹œêµ¬.html ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) */
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 15px;
        }
        .user-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background-color: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 16px;
            box-shadow: 4px 4px 0px 0px var(--panel-shadow);
        }
        .user-list-avatar {
            width: 44px; height: 44px; font-size: 2.2em;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; border: 3px solid var(--text-color-dark);
            background-color: var(--panel-bg);
            overflow: hidden; flex-shrink: 0;
        }
        .user-list-avatar img { width: 100%; height: 100%; object-fit: contain; }
        
        .user-list-nickname {
            font-weight: 700;
            font-size: 1.0em;
            flex-grow: 1; min-width: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .user-item-actions {
            display: flex; gap: 8px; flex-shrink: 0;
        }
        .user-action-btn {
            font-size: 0.9em;
            padding: 10px 12px;
            min-width: 60px;
            width: auto;
            border-radius: 12px;
            border-bottom-width: 4px;
        }

/* [ì‹ ê·œ] ì•„ë°”íƒ€ ìƒë‹¨ ë ˆë²¨ ë°°ì§€ */
.player-level-badge {
    /* [ìˆ˜ì •] position: absolute ì œê±° -> inline-blockìœ¼ë¡œ ë³€ê²½ */
    display: inline-block; /* í…ìŠ¤íŠ¸ í¬ê¸°ë§Œí¼ë§Œ ë„ˆë¹„ ì°¨ì§€ (ë¶€ëª¨ì˜ text-align: center ì ìš©ë°›ìŒ) */
    background-color: var(--primary-color);
    color: white;
    font-size: 0.7em; /* [ìˆ˜ì •] 0.8em -> 0.7em (ë” ì‘ê²Œ) */
    font-weight: 700;
    padding: 1px 4px; /* [ìˆ˜ì •] 2px 6px -> 1px 4px (ì—¬ë°± ì¶•ì†Œ) */
    border-radius: 6px; /* [ìˆ˜ì •] 8px -> 6px (ëª¨ì„œë¦¬ ë‘¥ê¸€ê¸°) */
    border: 1px solid white; /* [ìˆ˜ì •] 2px -> 1px (í…Œë‘ë¦¬ ë‘ê»˜) */
    box-shadow: 0 1px 2px rgba(0,0,0,0.2); /* [ìˆ˜ì •] ê·¸ë¦¼ì ì¶•ì†Œ */
    margin-bottom: 3px; /* [ìˆ˜ì •] 4px -> 3px (ë‹‰ë„¤ì„ê³¼ì˜ ê°„ê²©) */
    
    /* [ì œê±°] position: absolute ì†ì„±ë“¤ */
    /* position: absolute; */
    /* top: -10px; */
    /* left: 50%; */
    /* transform: translateX(-50%); */
    /* z-index: 5; */
}
/* [ì‹ ê·œ] í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        #toast-container {
            position: fixed;
            top: 20px; /* ìƒë‹¨ì—ì„œ 20px ì•„ë˜ */
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none; /* í´ë¦­ ë°©ì§€ */
        }
.toast-notification {
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            animation: toast-fade-in 0.5s forwards, toast-fade-out 0.5s 2.5s forwards;
            white-space: nowrap; /* [ì¶”ê°€] ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
        @keyframes toast-fade-in {
            from { opacity: 0; transform: translateY(-20px); } /* ìœ„ì—ì„œ ì•„ë˜ë¡œ */
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        /* [ìˆ˜ì •] 8. ëª¨ë‹¬ ë° ì˜¤ë²„ë ˆì´ (ëŒ€ê¸°ì‹¤ í…Œë§ˆ ì ìš©) */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* [ìˆ˜ì •] */
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; } /* [ì¶”ê°€] */

        .modal-content {
            background: var(--panel-bg);
            border-radius: 24px;
            width: 90%; max-width: 420px;
            overflow: hidden;
            border: 4px solid var(--text-color-dark);
            box-shadow: 8px 8px 0px 0px var(--text-color-dark);
        }
        .modal-body { padding: 30px 20px 20px; text-align: center; }
        .modal-body h3 { font-size: 1.4em; margin-bottom: 15px; }
        .modal-body p { font-size: 0.9em; color: #666; }
        .modal-footer {
            display: flex; gap: 10px;
            padding: 20px;
            border-top: 3px solid var(--panel-border);
            background-color: #FFFAE0; /* [ìˆ˜ì •] */
        }
        .modal-footer .menu-btn { margin: 0; font-size: 1.1em; }

        .spinner {
            border: 5px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* 4. [ì‹ ê·œ] ë¶ˆíƒ€ëŠ” ë“±ì¥ (ì´ê¸€ì´ê¸€) */
        @keyframes flame-anim {
            0% { box-shadow: 0 5px 12px -5px #F90, 0 8px 15px 0px #F00, 0 5px 20px 5px #F90, 0 2px 5px 0 #FFF; }
            50% { box-shadow: 0 8px 15px -5px #FFF, 0 10px 20px 5px #F00, 0 8px 25px 10px #F90, 0 5px 10px 0 #FFF; }
            100% { box-shadow: 0 5px 12px -5px #F90, 0 8px 15px 0px #F00, 0 5px 20px 5px #F90, 0 2px 5px 0 #FFF; }
        }
        /* [ìˆ˜ì •] ì…€ë ‰í„° ë³€ê²½: .player-slot-compact .avatar */
        .player-slot-compact .avatar.preview-effect-flames {
            position: relative; z-index: 1;
        }
        .player-slot-compact .avatar.preview-effect-flames::after {
            content: ''; position: absolute; bottom: -5px; left: 10%;
            width: 80%; height: 10px; border-radius: 50%;
            background: transparent;
            animation: flame-anim 1.2s ease-in-out infinite;
            z-index: -1;
        }

        /* 5. [ì‹ ê·œ] ì²œì‚¬ ë§ */
        @keyframes halo-hover-anim {
            0%, 100% { transform: translateY(0) rotateX(60deg) scale(0.9); opacity: 0.8; }
            50% { transform: translateY(-8px) rotateX(60deg) scale(1); opacity: 1; }
        }
        .effect-angel-halo {
            position: absolute; top: 0px; left: 50%;
            transform-origin: center center; width: 40px; height: 15px;
            margin-left: -20px; border: 3px solid var(--accent-color);
            border-radius: 50%;
            background: radial-gradient(ellipse at center, rgba(255,255,0,0.3) 0%, rgba(255,255,255,0) 60%);
            box-shadow: 0 0 10px 3px var(--accent-color);
            animation: halo-hover-anim 2s ease-in-out infinite;
            transform: rotateX(60deg); z-index: 20; 
        }

        /* 6. [ì‹ ê·œ] ë¹™ê²° */
        @keyframes frost-anim {
            0% { opacity: 0.7; box-shadow: 0 0 10px 3px #FFF, 0 0 20px 8px #a7d5ff, inset 0 0 8px 3px #FFF; }
            50% { opacity: 0.4; box-shadow: 0 0 15px 5px #FFF, 0 0 30px 12px #a7d5ff, inset 0 0 12px 5px #FFF; }
            100% { opacity: 0.7; box-shadow: 0 0 10px 3px #FFF, 0 0 20px 8px #a7d5ff, inset 0 0 8px 3px #FFF; }
        }
        .effect-frozen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 12px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100'%3E%3Cfilter id='f'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.2' numOctaves='3'/%3E%3CfeDiffuseLighting lighting-color='%23a7d5ff' surfaceScale='5'%3E%3CfeDistantLight azimuth='45' elevation='45'/%3E%3C/feDiffuseLighting%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23f)'/%3E%3C/svg%3E");
            mix-blend-mode: screen; 
            animation: frost-anim 4s ease-in-out infinite;
            z-index: 20;
        }
    </style>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"></script>
</head>
<body>

    

    <audio id="enter-sound" src="https://blog.kakaocdn.net/dna/dEAY2/dJMb88H2R2G/AAAAAAAAAAAAAAAAAAAAAPg0_H0XgRz8g-U-2Qk-5K2uWlT2sFpA-Vz_86X37x-o/%EC%9E%85%EC%9E%A5%EC%82%AC%EC%9A%B4%EB%93%9C.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1761922799&allow_ip=&allow_referer=&signature=8yD70E4Y6rV3d9W5D%252B19eYd%252BYcM%253D&attach=1&knm=tfile.mp3" preload="auto"></audio>
    <audio id="leave-sound" src="https://blog.kakaocdn.net/dna/brwD6P/dJMb856J6l3/AAAAAAAAAAAAAAAAAAAAAI1QcI8lW7rA0zH8m8M7p7y7dE0g0-z04sXUqN_S7-kO/%ED%87%B4%EC%9E%A5%EC%82%AC%EC%9A%B4%EB%93%9C.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1761922799&allow_ip=&allow_referer=&signature=8yA7x4n75s5G6j%252B11uA%252BF5hXj8A%253D&attach=1&knm=tfile.mp3" preload="auto"></audio>

    <div class="game-lobby-container">
        <div class="game-lobby-header">
            <button id="leave-room-btn" class="header-btn leave">â€¹</button>
            <div class="header-title">
                <h1 id="room-name-header"></h1>
                <p id="game-type-header"></p>
            </div>
            <div class="header-buttons-wrapper">
                <button id="invite-btn" class="header-btn invite">ì¹´í†¡ì´ˆëŒ€</button>
                </div>
        </div>
        
        <div class="game-lobby-main">
            <div id="player-list-wrapper">
                <div id="player-list-horizontal"></div>
            </div>
            <div id="chat-container"></div>
        </div>
        
        <div class="game-lobby-footer">
            <button id="start-game-btn" class="menu-btn primary" disabled style="display: none; margin-bottom: 10px;">ê²Œì„ ì‹œì‘</button>
            
            <div id="chat-controls">
                <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="50" autocomplete="off">
              <button id="mic-btn">ğŸ™ï¸</button>
                <button id="emoji-toggle-btn">ğŸ˜€</button>
                <button id="chat-settings-btn">âš™ï¸</button>
                <div id="emoji-popover">
                    <button>ğŸ‘</button><button>ğŸ˜‚</button><button>ğŸ˜®</button><button>ğŸ‘‹</button>
                    <button>ğŸ˜</button><button>ğŸ‘Œ</button><button>ğŸ˜­</button><button>ğŸ¤—</button>
                </div>
                <button id="send-chat-btn">ì „ì†¡</button>
            </div>
            </div>
    </div>
    
    <div id="loading-overlay" class="overlay">
        <div class="spinner"></div>
    </div>

    <script src="ì•„ë°”íƒ€.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
   <script>
    // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ (ì¹´ì¹´ì˜¤ ê³µìœ ì—ì„œ ì‚¬ìš©)
    let currentRoomData = null;
    let roomRef = null;
    let availableGames = [];
    
    // ì „ì—­ ìŠ¤ì½”í”„ í•¨ìˆ˜ ì •ì˜
    function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return str.replace(/[&<>"']/g, m => map[m]);
    }

    function setScreenHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
        const gameLobbyContainer = document.querySelector('.game-lobby-container');
        if (gameLobbyContainer) {
            gameLobbyContainer.style.height = `${window.innerHeight}px`;
        }
    }

    // F12 ì°¨ë‹¨ ë“±ì€ DOMContentLoaded ì „ì— ì‹¤í–‰ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì „ì—­ ìœ ì§€
    document.addEventListener('contextmenu', event => event.preventDefault());
    /* // ë””ë²„ê¹… ìœ„í•´ ì„ì‹œ ì£¼ì„ ì²˜ë¦¬
    document.addEventListener('keydown', event => {
       if (event.key === 'F12' ||
            (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
            (event.ctrlKey && event.key.toUpperCase() === 'U')) {
          event.preventDefault();
        }
    });
    setInterval(() => { try { debugger; } catch (e) {} }, 1000);
    */

    window.addEventListener('resize', setScreenHeight);
    window.addEventListener('orientationchange', setScreenHeight);
    setScreenHeight(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰

    // ì¹´ì¹´ì˜¤ ì´ˆëŒ€ í•¨ìˆ˜ ì •ì˜ (ì „ì—­ ìœ ì§€)
function kakaoInvite() {
    console.log('[ë¡œê·¸] kakaoInvite í•¨ìˆ˜ ì‹¤í–‰ ì‹œì‘ë¨.');
    
    // Kakao SDK ì²´í¬
    if (typeof window.Kakao === 'undefined' || !window.Kakao.isInitialized()) {
        alert('ì¹´ì¹´ì˜¤ SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ë³´ì„¸ìš”.');
        console.error('kakaoInvite: Kakao SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }
    
    console.log('Kakao SDK ì´ˆê¸°í™” í™•ì¸ë¨.');
    
    if (!currentRoomData || !roomRef) {
        alert("ì˜¤ë¥˜: ì•„ì§ ë°© ì •ë³´ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        console.error('kakaoInvite: currentRoomData ë˜ëŠ” roomRefê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    console.log('ë°© ì •ë³´ í™•ì¸ë¨.');
    
    const game = availableGames.find(g => g.id === currentRoomData.gameType);
    if (!game) {
        alert("ì˜¤ë¥˜: ì•Œ ìˆ˜ ì—†ëŠ” ê²Œì„ì…ë‹ˆë‹¤.");
        console.error('kakaoInvite: gameì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // [ìˆ˜ì •] index.html -> ëŒ€ê¸°ì‹¤.htmlë¡œ ë³€ê²½ (ì‚¬ìš©ì ìš”ì²­)
    const inviteURL = `https://bangat.github.io/game/ëŒ€ê¸°ì‹¤.html?roomId=${roomRef.key}`;
    console.log('kakaoInvite: ìƒì„±ëœ URL:', inviteURL);
    console.log('Kakao.Share.sendDefault í˜¸ì¶œ ì‹œë„...');
    
    try {
        window.Kakao.Share.sendDefault({
            objectType: 'feed',
            content: {
                title: `[${game.name}] ê°™ì´ í•  ì‚¬ëŒ!`,
                description: `'${currentRoomData.roomName}' ë°©ì—ì„œ ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!`,
                imageUrl: 'https://i.ibb.co/684n0XG/link-Image.png',
                link: {
                    mobileWebUrl: inviteURL,
                    webUrl: inviteURL,
                },
            },
            buttons: [
                {
                    title: 'ê²Œì„ ì°¸ê°€í•˜ê¸°',
                    link: {
                        mobileWebUrl: inviteURL,
                        webUrl: inviteURL,
                    },
                },
            ],
        });
        console.log('Kakao.Share.sendDefault í˜¸ì¶œ ì™„ë£Œ.');
    } catch (e) {
        console.error('Kakao.Share.sendDefault ì‹¤íŒ¨:', e);
        alert('ì¹´ì¹´ì˜¤í†¡ ê³µìœ í•˜ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}


    // âœ¨ [ì‹ ê·œ] ê²Œì„ ì„¤ì • ì „ì—­ ë³€ìˆ˜ (ëŒ€ê¸°ì‹¤ê³¼ ê³µìœ )
    const defaultSettings = {
        sfx: true,      // íš¨ê³¼ìŒ
        bgm: true,      // ë°°ê²½ìŒì•…
        vibration: true // ì§„ë™
    };
    // localStorageì—ì„œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ê±°ë‚˜, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
    let gameSettings = JSON.parse(localStorage.getItem('gameSettings')) || defaultSettings;
    // localStorageì— ìµœì‹  ìƒíƒœ(ê¸°ë³¸ê°’ í¬í•¨)ë¥¼ ì €ì¥ (í•„ìˆ˜ëŠ” ì•„ë‹ˆì§€ë§Œ, ì¼ê´€ì„±ì„ ìœ„í•´)
    localStorage.setItem('gameSettings', JSON.stringify(gameSettings));


    // --- DOMContentLoaded ì‹œì‘ ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log('--- DOMContentLoaded ì‹œì‘ ---');
        // --- âœ¨ [ì‹ ê·œ] Kakao SDK ì´ˆê¸°í™” (DOMContentLoadedë¡œ ì´ë™) ---
        try {
            if (typeof window.Kakao !== 'undefined' && window.Kakao.init) {
                if (!window.Kakao.isInitialized()) {
                    window.Kakao.init('eab4e799223cb0d41b51e518546b2405');
                    console.log('Kakao SDKê°€ DOMContentLoadedì—ì„œ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.log('Kakao SDKê°€ DOMContentLoadedì—ì„œ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìŒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.');
                }
            } else {
                console.error('DOMContentLoaded: Kakao SDK ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¡œë“œí–ˆìœ¼ë‚˜, Kakao ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        } catch (e) {
            console.error("DOMContentLoaded: Kakao SDK ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
        }
        // --- âœ¨ Kakao SDK ì´ˆê¸°í™” ë ---
          
    

    // --- ì¸ì•± ì½˜ì†” ê¸°ëŠ¥ (DOMContentLoaded ë‚´ë¶€ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™) ---
        const consoleModal = document.getElementById('console-modal');
        const consoleOutput = document.getElementById('console-output');
        const openConsoleBtn = document.getElementById('open-console-btn');
        const closeConsoleBtn = document.getElementById('close-console-btn');
        const clearConsoleBtn = document.getElementById('clear-console-btn');

        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        function addLogToModal(message, type = 'log') {
             const currentConsoleOutput = document.getElementById('console-output');
            if (!currentConsoleOutput) {
                 originalConsoleError("ì¸ì•± ì½˜ì†” ì¶œë ¥ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 return;
             }
            const logEntry = document.createElement('div');
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            logEntry.style.marginBottom = '5px';
            logEntry.style.borderBottom = '1px solid #444';
            logEntry.style.paddingBottom = '3px';
            logEntry.innerHTML = `<span style="color: #888;">[${timestamp}]</span> `;
            if (type === 'warn') { logEntry.style.color = 'yellow'; logEntry.innerHTML += `<span style="font-weight: bold;">[WARN]</span> `; }
            else if (type === 'error') { logEntry.style.color = 'red'; logEntry.innerHTML += `<span style="font-weight: bold;">[ERROR]</span> `; }
            else { logEntry.style.color = 'white'; }
            if (typeof message === 'object') {
                try { message = JSON.stringify(message, null, 2); } catch (e) { message = '[Object Circular Structure]'; }
                const pre = document.createElement('pre');
                pre.style.margin = '0'; pre.style.display = 'inline'; pre.textContent = message;
                logEntry.appendChild(pre);
            } else {
                const textNode = document.createTextNode(String(message));
                logEntry.appendChild(textNode);
            }
            currentConsoleOutput.appendChild(logEntry);
            currentConsoleOutput.scrollTop = currentConsoleOutput.scrollHeight;
        }

        // âœ¨ğŸ‘‡ ì—¬ê¸° ë°”ë¡œ ì•„ë˜ì— í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì¶”ê°€ ğŸ‘‡âœ¨
        addLogToModal("!!! ì¸ì•± ì½˜ì†” addLogToModal ì§ì ‘ í˜¸ì¶œ í…ŒìŠ¤íŠ¸ !!!", "warn");
        // âœ¨ğŸ‘† í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì¶”ê°€ ë ğŸ‘†âœ¨


        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addLogToModal(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'log');
        };
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addLogToModal(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'warn');
        };
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLogToModal(args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' '), 'error');
        };
        window.onerror = function(message, source, lineno, colno, error) {
            const errorMessage = `Uncaught Error: ${message} at ${source}:${lineno}:${colno}`;
            originalConsoleError(errorMessage, error);
            addLogToModal(errorMessage, 'error');
        };
        window.onunhandledrejection = function(event) {
            const reason = event.reason instanceof Error ? event.reason.stack || event.reason.message : String(event.reason);
            const errorMessage = `Unhandled Promise Rejection: ${reason}`;
            originalConsoleError(errorMessage);
            addLogToModal(errorMessage, 'error');
        };

        // í…ŒìŠ¤íŠ¸ ë¡œê·¸
        console.log('--- ì¸ì•± ì½˜ì†” í…ŒìŠ¤íŠ¸ ë¡œê·¸ (DOMContentLoaded) ---');

        if (openConsoleBtn) { openConsoleBtn.addEventListener('click', () => { if (consoleModal) consoleModal.style.display = 'flex'; openConsoleBtn.style.display = 'none'; }); }
        if (closeConsoleBtn) { closeConsoleBtn.addEventListener('click', () => { if (consoleModal) consoleModal.style.display = 'none'; if (openConsoleBtn) openConsoleBtn.style.display = 'block'; }); }
        if (clearConsoleBtn) { // clear ë²„íŠ¼ null ì²´í¬
             clearConsoleBtn.addEventListener('click', () => {
                 const currentConsoleOutput = document.getElementById('console-output');
                 if(currentConsoleOutput) currentConsoleOutput.innerHTML = '';
             });
        }
        // --- ì¸ì•± ì½˜ì†” ê¸°ëŠ¥ ë ---


        // --- ë‚˜ë¨¸ì§€ ê¸°ì¡´ DOMContentLoaded ì½”ë“œ ì‹œì‘ ---
        const confirmExitModal = document.getElementById('confirm-exit-modal');
        const exitModalSubtext = document.getElementById('exit-modal-subtext');

        history.pushState(null, '', location.href);
        window.addEventListener('popstate', (e) => {
             history.pushState(null, '', location.href);
             // isHost ë³€ìˆ˜ê°€ ì—¬ê¸°ì„œ ì‚¬ìš©ë  ë•Œ ê°’ì´ í• ë‹¹ë˜ì–´ ìˆë„ë¡ ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸ë˜ì—ˆëŠ”ì§€ í™•ì¸ í•„ìš”
             exitModalSubtext.textContent = isHost ? "ë°©ì¥ì´ ë‚˜ê°€ë©´ ë°©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤." : "ë°©ì—ì„œ ë‚˜ê°€ê²Œ ë©ë‹ˆë‹¤.";
             confirmExitModal.classList.add('active');
         });
        document.getElementById('exit-confirm-btn').addEventListener('click', () => {
             confirmExitModal.classList.remove('active');
             cleanupAndExit();
         });
        document.getElementById('exit-cancel-btn').addEventListener('click', () => {
             confirmExitModal.classList.remove('active');
         });

        let hostOnDisconnect = null;
        let playerOnDisconnect = null;

        const firebaseConfig = {
            apiKey: "AIzaSyCmNAKmgF_L3o0QyOGh_oFAq_rMRtUyklw",
            authDomain: "goodluck-7c14b.firebaseapp.com",
            databaseURL: "https://goodluck-7c14b-default-rtdb.firebaseio.com",
            projectId: "goodluck-7c14b",
            storageBucket: "goodluck-7c14b.appspot.com",
            messagingSenderId: "858281658455",
            appId: "1:858281658455:web:9131280a459be983933b12"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const roomsRef = db.ref('rooms');
        const usersRef = db.ref('users');

        const loadingOverlay = document.getElementById('loading-overlay');
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveRoomBtn = document.getElementById('leave-room-btn');
        const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
        const emojiPopover = document.getElementById('emoji-popover');
       const micBtn = document.getElementById('mic-btn'); // âœ¨ [ì‹ ê·œ] ë§ˆì´í¬ ë²„íŠ¼
        
        // âœ¨ [ì‹ ê·œ] Web Speech API (STT / TTS)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        const synthesis = window.speechSynthesis;

        // âœ¨ [ì‹ ê·œ] TTS ì„¤ì • ê´€ë ¨ DOM
        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        const ttsSettingsModal = document.getElementById('tts-settings-modal');
        const ttsVoiceSelect = document.getElementById('tts-voice-select');
        const ttsSettingsCloseBtn = document.getElementById('tts-settings-close-btn');
        const TTS_VOICE_KEY = 'gameLobbyVoiceURI'; // localStorage í‚¤
        // âœ¨ [ì‹ ê·œ] TTS ON/OFF í† ê¸€
        const ttsToggle = document.getElementById('tts-toggle-switch');
        const TTS_ENABLED_KEY = 'gameLobbyTTSOn'; // localStorage í‚¤

        // âœ¨ [ì‹ ê·œ] TTS í™œì„±í™” ìƒíƒœ (í˜ì´ì§€ ë¡œë“œ ì‹œ localStorageì—ì„œ ë¶ˆëŸ¬ì˜´)
        // âœ¨ [ìˆ˜ì •] 'false'ì¼ ë•Œë§Œ êº¼ì§€ê³ , null(ìµœì´ˆ)ì´ê±°ë‚˜ 'true'ë©´ ì¼œì§ (ê¸°ë³¸ê°’: ON)
        let isTTSOn = localStorage.getItem(TTS_ENABLED_KEY) !== 'false';

        // âœ¨ [ì‹ ê·œ] ì•Œë¦¼ ëª¨ë‹¬ ë³€ìˆ˜
        const alertModal = document.getElementById('alert-modal');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const alertModalOkBtn = document.getElementById('alert-modal-ok-btn');

        // [ì‹ ê·œ] ì¹œêµ¬ ì´ˆëŒ€ ëª¨ë‹¬
        const friendInviteModal = document.getElementById('friend-invite-modal');
        const friendInviteListContainer = document.getElementById('friend-invite-list-container');
        const friendInviteModalCloseBtn = document.getElementById('friend-invite-modal').querySelector('[data-close]');
        
        // âœ¨ [ì‹ ê·œ] ì•Œë¦¼ ëª¨ë‹¬ "í™•ì¸" ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
        if (alertModalOkBtn) {
            alertModalOkBtn.addEventListener('click', () => {
                alertModal.classList.remove('active');
            });
        }

        // âœ¨ [ì‹ ê·œ] STT/TTS ê¸°ëŠ¥ ì´ˆê¸°í™”
        if (recognition && micBtn) {
            recognition.lang = 'ko-KR';
            recognition.continuous = false;
            recognition.interimResults = false;

            // 1. ìŒì„± ì¸ì‹ì´ ì„±ê³µí–ˆì„ ë•Œ
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                console.log('ì¸ì‹ëœ í…ìŠ¤íŠ¸:', text);
                
                // [í•µì‹¬] ì¸ì‹ëœ í…ìŠ¤íŠ¸ë¥¼ "ì±„íŒ… ì „ì†¡" í•¨ìˆ˜ë¡œ ë³´ëƒ„
                sendMessage(text); 
            };

            // 2. ìŒì„± ì¸ì‹ì´ ëë‚˜ë©´ ë²„íŠ¼ ë³µêµ¬
            recognition.onend = () => {
                micBtn.classList.remove('recording');
                micBtn.disabled = false;
            };

            // 3. ì—ëŸ¬ ì²˜ë¦¬
            recognition.onerror = (event) => {
                console.error('ìŒì„± ì¸ì‹ ì—ëŸ¬:', event.error);
                if (event.error === 'no-speech') {
                    showToast('ìŒì„±ì´ ë“¤ë¦¬ì§€ ì•Šì•„ìš”.');
                } else if (event.error === 'not-allowed') {
                    showAlert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                } else {
                    showToast('ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
                micBtn.classList.remove('recording');
                micBtn.disabled = false;
            };

            // 4. ë§ˆì´í¬ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            micBtn.addEventListener('click', () => {
                if (!currentUser) return; // ë¡œê·¸ì¸ ì²´í¬

                if (micBtn.classList.contains('recording')) {
                    // ë…¹ìŒ ì¤‘ì¼ ë•Œ ëˆ„ë¥´ë©´ ì¤‘ì§€
                    recognition.stop();
                } else {
                    // ë…¹ìŒ ì‹œì‘
                    try {
                        recognition.start();
                        micBtn.classList.add('recording');
                        micBtn.disabled = true; // ë…¹ìŒ ì¤‘ ë¹„í™œì„±í™”
                        showToast('ë“£ê³  ìˆì–´ìš”... ğŸ™ï¸');
                    } catch(e) {
                        console.error("ì¸ì‹ ì‹œì‘ ì—ëŸ¬", e);
                        if (e.name === 'NotAllowedError') {
                             showAlert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        } else {
                             showToast('ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    }
                }
            });

        } else {
            // STT ë¯¸ì§€ì› ë¸Œë¼ìš°ì €
            console.warn("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            if (micBtn) {
                micBtn.style.display = 'none'; // ë²„íŠ¼ ìˆ¨ê¹€
            }
        }

        // --- âœ¨ [ìˆ˜ì •] TTS ëª©ì†Œë¦¬ ëª©ë¡ ë¡œë“œ (ê°•ë ¥í•œ ì¬ì‹œë„ ë¡œì§ í¬í•¨) ---
        let voiceList = []; // ìŒì„± ëª©ë¡ ìºì‹œ
        let voiceLoadAttempts = 0; // [ì‹ ê·œ] ë¡œë“œ ì‹œë„ íšŸìˆ˜

        function populateVoiceList() {
            if (!synthesis) return;

            voiceList = synthesis.getVoices();
            
            // [ì‹ ê·œ] ëª©ë¡ì´ ë¹„ì–´ìˆê±°ë‚˜, í•œêµ­ì–´ ìŒì„±ì´ ì—†ìœ¼ë©´ ì¬ì‹œë„
            const koreanVoices = voiceList.filter(voice => voice.lang === 'ko-KR' || voice.lang.startsWith('ko-'));

            if (koreanVoices.length === 0 && voiceLoadAttempts < 5) {
                voiceLoadAttempts++;
                console.warn(`TTS ëª©ì†Œë¦¬ ëª©ë¡ì´ ë¹„ì–´ìˆê±°ë‚˜ í•œêµ­ì–´ ìŒì„±ì´ ì—†ìŠµë‹ˆë‹¤. ${voiceLoadAttempts}ë²ˆì§¸ ì¬ì‹œë„... (ì—”ì§„ ê¹¨ìš°ëŠ” ì¤‘)`);
                
                // 0.1ì´ˆ í›„ì— ì—”ì§„ì„ ê¹¨ìš°ê³ , 0.5ì´ˆ í›„ì— ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œ
                setTimeout(primeTTSEngine, 100); 
                setTimeout(populateVoiceList, 500); 
                return; // ì§€ê¸ˆì€ ëª©ë¡ì„ ì±„ìš°ì§€ ì•ŠìŒ
            }

            console.log(`TTS ëª©ì†Œë¦¬ ${voiceList.length}ê°œ ë¡œë“œë¨. (í•œêµ­ì–´ ${koreanVoices.length}ê°œ)`);

            ttsVoiceSelect.innerHTML = '<option value="">ê¸°ë³¸ ëª©ì†Œë¦¬ (ë¸Œë¼ìš°ì €)</option>'; // ì´ˆê¸°í™”
            
            const savedVoiceURI = localStorage.getItem(TTS_VOICE_KEY);

            koreanVoices.forEach(voice => { // [ìˆ˜ì •] í•„í„°ë§ëœ í•œêµ­ì–´ ëª©ë¡ ì‚¬ìš©
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                
                if (voice.voiceURI === savedVoiceURI) {
                    option.selected = true; // ì €ì¥ëœ ëª©ì†Œë¦¬ ì„ íƒ
                }
                
                ttsVoiceSelect.appendChild(option);
            });
        }

        // (ì¤‘ìš”) ìŒì„± ëª©ë¡ì€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.
        if(synthesis) {
            // [ìˆ˜ì •] onvoiceschanged í•¸ë“¤ëŸ¬ë¥¼ ë¨¼ì € ì„¤ì •í•©ë‹ˆë‹¤.
            if (synthesis.onvoiceschanged !== undefined) {
                synthesis.onvoiceschanged = populateVoiceList;
            }
            
            // [ìˆ˜ì •] ê·¸ë¦¬ê³  *ì¦‰ì‹œ* ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤ (ì¬ì‹œë„ ë¡œì§ì´ í¬í•¨ëœ ìƒˆ í•¨ìˆ˜).
            populateVoiceList();

        } else if (chatSettingsBtn) {
            // [ì‹ ê·œ] TTSê°€ ì•„ì˜ˆ ì§€ì› ì•ˆë˜ë©´ ì„¤ì • ë²„íŠ¼ ìˆ¨ê¹€
            chatSettingsBtn.style.display = 'none';
        }

// ì„¤ì •(âš™ï¸) ë²„íŠ¼ í´ë¦­ -> ëª¨ë‹¬ ì—´ê¸°
        if (chatSettingsBtn) {
            chatSettingsBtn.addEventListener('click', () => {
                populateVoiceList(); // ëª¨ë‹¬ ì—´ ë•Œë§ˆë‹¤ ëª©ë¡ ê°±ì‹ 
                
                // âœ¨ [ìˆ˜ì •] í˜„ì¬ TTS ON/OFF ìƒíƒœë¥¼ í† ê¸€ ìŠ¤ìœ„ì¹˜ì— ë°˜ì˜
                if(ttsToggle) ttsToggle.checked = isTTSOn; 
                
                ttsSettingsModal.classList.add('active');
            });
        }
        
        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        if (ttsSettingsCloseBtn) {
            ttsSettingsCloseBtn.addEventListener('click', () => {
                ttsSettingsModal.classList.remove('active');
            });
        }

        // ëª©ì†Œë¦¬ ì„ íƒ ì‹œ localStorageì— "ì¦‰ì‹œ ì €ì¥"
        if (ttsVoiceSelect) {
            ttsVoiceSelect.addEventListener('change', () => {
                const selectedVoiceURI = ttsVoiceSelect.value;
                if (selectedVoiceURI) {
                    localStorage.setItem(TTS_VOICE_KEY, selectedVoiceURI);
                } else {
                    localStorage.removeItem(TTS_VOICE_KEY); // 'ê¸°ë³¸' ì„ íƒ ì‹œ ì €ì¥ê°’ ì œê±°
                }
                showToast('ëª©ì†Œë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // í…ŒìŠ¤íŠ¸ ì¬ìƒ
                const testUtterance = new SpeechSynthesisUtterance('ëª©ì†Œë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                const savedVoice = voiceList.find(v => v.voiceURI === selectedVoiceURI);
                if (savedVoice) {
                    testUtterance.voice = savedVoice;
                }
                testUtterance.lang = 'ko-KR';
                synthesis.speak(testUtterance);
            });
        }

        // âœ¨ [ì‹ ê·œ] TTS ON/OFF í† ê¸€ ìŠ¤ìœ„ì¹˜ í´ë¦­ ì´ë²¤íŠ¸
        if (ttsToggle) {
            ttsToggle.addEventListener('change', () => {
                isTTSOn = ttsToggle.checked; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                localStorage.setItem(TTS_ENABLED_KEY, isTTSOn); // localStorageì— ì €ì¥
                
                if (isTTSOn) {
                    showToast('ì±„íŒ… ìŒì„± ë“£ê¸° ON');
                    // ì¼œì¡Œì„ ë•Œ í…ŒìŠ¤íŠ¸ ì¬ìƒ
                    const testUtterance = new SpeechSynthesisUtterance('ìŒì„± ë“£ê¸°ê°€ ì¼œì¡ŒìŠµë‹ˆë‹¤.');
                    const savedVoiceURI = localStorage.getItem(TTS_VOICE_KEY);
                    const savedVoice = voiceList.find(v => v.voiceURI === savedVoiceURI);
                    if (savedVoice) testUtterance.voice = savedVoice;
                    testUtterance.lang = 'ko-KR';
                    synthesis.speak(testUtterance);
                } else {
                    showToast('ì±„íŒ… ìŒì„± ë“£ê¸° OFF');
                    synthesis.cancel(); // í˜¹ì‹œ ë§í•˜ê³  ìˆì—ˆë‹¤ë©´ ì¤‘ì§€
                }
            });
        }
        // [ì‹ ê·œ] ì•± ë°±ê·¸ë¼ìš´ë“œ/ë³µê·€ ì‹œ ì ‘ì† ìœ ì§€ ë¡œì§ (pagehide/pageshowë¡œ ì•ˆì •ì„± ê°•í™”)
        
        const handleAppHide = () => {
            // ì´ë¯¸ íƒ€ì´ë¨¸ê°€ ì‹¤í–‰ ì¤‘ì´ë©´ (ë‹¤ë¥¸ ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì‹¤í–‰ëë‹¤ë©´) ë¬´ì‹œ
            if (presenceTimeout) return; 

            console.log('[Presence] ê²Œì„ë°© ìˆ¨ê¹€ (pagehide/hidden). 5ë¶„ íƒ€ì´ë¨¸ ì‹œì‘.');
            
            // [### 1. onDisconnect ìˆ˜ë™ ì·¨ì†Œ (í•µì‹¬ ìˆ˜ì •) ###]
            // "ë‚˜ ì§€ê¸ˆ ì ê¹ ë‚˜ê°€ëŠ”ê±°ì•¼, 5ë¶„ ì•ˆì— ëŒì•„ì˜¬ê²Œ"ë¼ê³  ì„œë²„ì— ì•Œë¦¼.
            // ì´ ì½”ë“œë¥¼ ì£¼ì„ ì²˜ë¦¬í•˜ë©´, ìˆ¨ê¸°ëŠ” ì¦‰ì‹œ ì„œë²„ê°€ íŠ•ê²¨ëƒ„.
            cancelMyOnDisconnectHandler(); 
            
            presenceTimeout = setTimeout(() => {
                console.log('[Presence] 5ë¶„ ê²½ê³¼. ê²Œì„ë°©ì—ì„œ ë‚˜ê°‘ë‹ˆë‹¤.');
                cleanupAndExit();
            }, 300000); // 5ë¶„ (300,000ms)
        };

        const handleAppShow = () => {
            // íƒ€ì´ë¨¸ê°€ ì—†ìœ¼ë©´ (ì´ë¯¸ 'show' ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬ëë‹¤ë©´) ë¬´ì‹œ
            if (!presenceTimeout) return; 

            console.log('[Presence] ê²Œì„ë°© í™œì„±í™” (pageshow/visible). 5ë¶„ íƒ€ì´ë¨¸ ì·¨ì†Œ.');
            
            clearTimeout(presenceTimeout);
            presenceTimeout = null;
            
            // [ì¤‘ìš”] onDisconnect í•¸ë“¤ëŸ¬ë¥¼ *ì¦‰ì‹œ ë‹¤ì‹œ ì„¤ì •*í•¨
            setMyOnDisconnectHandler();
        };

        // 'pagehide'ëŠ” ì•±ì´ ë°±ê·¸ë¼ìš´ë“œë¡œ ê°€ê±°ë‚˜ ë‹«í ë•Œ 'visibilitychange'ë³´ë‹¤ ì•ˆì •ì 
        window.addEventListener('pagehide', handleAppHide);
        // 'pageshow'ëŠ” ì•±ì´ ë‹¤ì‹œ í™œì„±í™”ë  ë•Œ
        window.addEventListener('pageshow', handleAppShow);

        // êµ¬í˜• ë¸Œë¼ìš°ì €/ì¼ë°˜ íƒ­ ì „í™˜ì„ ìœ„í•œ visibilitychangeë„ ìœ ì§€
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                handleAppHide();
            } else if (document.visibilityState === 'visible') {
                handleAppShow();
            }
        });

        // âœ¨ [ì‹ ê·œ] ê³µìš© í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showToast(message) {
            const toastContainer = document.getElementById('toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = message;
            
            toastContainer.appendChild(toast);

            // 3ì´ˆ í›„ DOMì—ì„œ ì œê±°
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // âœ¨ [ì‹ ê·œ] ê³µìš© ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showAlert(message) {
            if (alertModalMessage) alertModalMessage.textContent = message;
            if (alertModal) alertModal.classList.add('active');
        }
        const lobbyFooter = document.querySelector('.game-lobby-footer');

        // ë³€ìˆ˜ ì„ ì–¸ (ìŠ¤ì½”í”„ ìƒë‹¨ìœ¼ë¡œ)
let currentUser, myNickname, myAvatar, myBombSkin, isHost;
let myEntryEffect = null; // âœ¨ [ì‹ ê·œ] ì…ì¥ ì´í™íŠ¸ 
let myLevel = 1; // âœ¨ [ì‹ ê·œ] ë ˆë²¨ ì €ì¥ìš©
let previousPlayerNicks = {};

let presenceTimeout = null; // [ì‹ ê·œ] ë°±ê·¸ë¼ìš´ë“œ ìœ ì˜ˆ ì‹œê°„ íƒ€ì´ë¨¸
// âœ¨ [ì‹ ê·œ] ì¹œêµ¬ ì ‘ì† ê°ì§€ ë¦¬ìŠ¤ë„ˆ
let friendStatusListener = null;
let friendStatusRef = null;


// availableGames ì •ì˜ (ì „ì—­ìœ¼ë¡œ ì´ë™)
availableGames = [
            { id: 'alkkagi', name: 'ì•Œê¹Œê¸°', icon: 'âšª', file: 'ì•Œê¹Œê¸°.html', maxPlayers: 2 },
            { id: 'crossingKnights', name: 'í¬ë¡œì‹± ë‚˜ì´ì¸ ', icon: 'â™', file: 'í¬ë¡œì‹±ë‚˜ì´ì¸ .html', maxPlayers: 2 },
            { id: 'memoryGame', name: 'ë©”ëª¨ë¦¬', icon: 'ğŸ§ ', file: 'ë©”ëª¨ë¦¬ê²Œì„.html', maxPlayers: 4 },
            { id: 'reversi', name: 'ë¦¬ë²„ì‹œ', icon: 'âš«', file: 'ë¦¬ë²„ì‹œ.html', maxPlayers: 2 },
            { id: 'indianpoker', name: 'ì¸ë””ì–¸í¬ì»¤', icon: 'ğŸƒ', file: 'ì¸ë””ì–¸í¬ì»¤.html', maxPlayers: 2 },
            { id: 'candysoap', name: 'ì• ë‹ˆíŒ¡', icon: 'ğŸ¬', file: 'ì• ë‹ˆíŒ¡.html', maxPlayers: 4 },
            { id: 'quiz', name: 'AI ìŠ¤í”¼ë“œí€´ì¦ˆ', icon: 'â“', file: 'aií€´ì¦ˆ.html', maxPlayers: 4 },
            { id: 'bomber', name: 'í¬ë ˆì´ì§€ ë´„ë²„', icon: 'ğŸ’£', file: 'ë´„ë²„ë§¨.html', maxPlayers: 4 },
            { id: 'shisenSho', name: 'ì‚¬ì²œì„±', icon: 'ğŸ€„', file: 'ì‚¬ì²œì„±.html', maxPlayers: 4 },
            { id: 'tetris', name: 'í…ŒíŠ¸ë¦¬ìŠ¤', icon: 'ğŸ§±', file: 'í…ŒíŠ¸ë¦¬ìŠ¤.html', maxPlayers: 4, color: '#2980b9', canSolo: false }
        ];

        // âœ¨ [ìˆ˜ì •] ê²Œì„ ì„¤ì • ë¡œë“œ
        const defaultSettings = { sfx: true, bgm: true, vibration: true };
        let gameSettings = JSON.parse(localStorage.getItem('gameSettings')) || defaultSettings;
        localStorage.setItem('gameSettings', JSON.stringify(gameSettings));
        
        const playSound = (id) => {
            // âœ¨ [ìˆ˜ì •] íš¨ê³¼ìŒ ì„¤ì •ì´ ì¼œì ¸ ìˆì„ ë•Œë§Œ ì¬ìƒ
            if (!gameSettings.sfx) return;

            const sound = document.getElementById(id);
            if(sound) {
                sound.currentTime = 0;
                sound.play().catch(e => { /* ì˜¤ë¥˜ ë¬´ì‹œ ë˜ëŠ” ë¡œê¹… */ });
            }
        };

        const vibrate = () => {
            // âœ¨ [ìˆ˜ì •] ì§„ë™ ì„¤ì •ì´ ì¼œì ¸ ìˆì„ ë•Œë§Œ ì‹¤í–‰
            if (!gameSettings.vibration) return;

            if ('vibrate' in navigator) {
                navigator.vibrate(500); // 0.5ì´ˆ ì§„ë™
            }
        };

        // --- ë‚˜ë¨¸ì§€ í•¨ìˆ˜ ì •ì˜ (initializeRoom, listenToRoomChanges ë“±) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                myNickname = localStorage.getItem('userNickname');
                myAvatar = localStorage.getItem('userAvatar');
                if (!myNickname) { auth.signOut(); window.location.replace('index.html'); return; }

                // âœ¨ [ìˆ˜ì •] "ëª¨ë“  ìœ ì €" ì ‘ì† ê°ì§€ ë¦¬ìŠ¤ë„ˆ (ì¹œêµ¬ ëª©ë¡ ë¡œë“œ ì œê±°)
                if (friendStatusListener) {
                    friendStatusRef.off('child_added', friendStatusListener); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
                }
                
                friendStatusRef = db.ref('status');
                friendStatusListener = friendStatusRef.on('child_added', (statusSnap) => {
                    const onlineUid = statusSnap.key;
                    
                    // 1. ì ‘ì†í•œ ì‚¬ëŒì´ ë‚´ê°€ ì•„ë‹ˆì–´ì•¼ í•¨
                    if (onlineUid !== currentUser.uid) {
                        
                        // 2. (ì¤‘ìš”) ì´ ì‚¬ëŒì´ ì´ë¯¸ ì´ ë°©ì— ìˆëŠ”ì§€ í™•ì¸
                        const playerIdsInRoom = Object.keys(currentRoomData?.players || {});
                        if (playerIdsInRoom.includes(onlineUid)) {
                            return; // ì´ë¯¸ ë°©ì— ìˆìœ¼ë¯€ë¡œ ì•Œë¦¼ X
                        }

                        // 3. ë‹‰ë„¤ì„ì„ ê°€ì ¸ì™€ì„œ í† ìŠ¤íŠ¸ ì•Œë¦¼
                        usersRef.child(onlineUid).child('profile/nickname').once('value', (profileSnap) => {
                            if (profileSnap.exists()) {
                                showToast(`ğŸ”” ${escapeHTML(profileSnap.val())}ë‹˜ì´ ê²Œì„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤.`);
                            }
                        });
                    }
                });
                // --- [ìˆ˜ì •] ë¦¬ìŠ¤ë„ˆ ë¡œì§ ë³€ê²½ ë ---

                // âœ¨ [ìˆ˜ì •] bombSkinê³¼ entryEffectë¥¼ í•¨ê»˜ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                usersRef.child(currentUser.uid).child('profile').once('value', snapshot => {
                    const profile = snapshot.val() || {};
                    myBombSkin = profile.bombSkin || './ë´„ë²„ë§¨ì‚¬ìš´ë“œ/ë¬¼í’ì„ .png';
                    myEntryEffect = profile.equippedEntryEffect || null; // âœ¨ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                    myLevel = profile.level || 1; // âœ¨ [ì‹ ê·œ] ë ˆë²¨ ì €ì¥
                    initializeRoom();
                }).catch(error => {
                    console.error("í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:", error);
                    myBombSkin = './ë´„ë²„ë§¨ì‚¬ìš´ë“œ/ë¬¼í’ì„ .png';
                    myEntryEffect = null;
                    initializeRoom();
                });
            } else {
                window.location.href = 'index.html';
            }
        });

        // [ì‹ ê·œ] onDisconnect í•¸ë“¤ëŸ¬ë¥¼ (ì¬)ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
function setMyOnDisconnectHandler() {
    if (!roomRef || !currentUser) return; // ë°©ì–´ ì½”ë“œ

    // ê¸°ì¡´ í•¸ë“¤ëŸ¬ê°€ ìˆë‹¤ë©´ ì¼ë‹¨ ëª¨ë‘ ì·¨ì†Œ
    cancelMyOnDisconnectHandler();

    if (isHost) {
        hostOnDisconnect = roomRef.onDisconnect();
        hostOnDisconnect.remove();
        console.log('[Presence] í˜¸ìŠ¤íŠ¸ onDisconnect ì„¤ì •ë¨ (ì¦‰ì‹œ ì œê±°)');
    } else {
        playerOnDisconnect = roomRef.child('players/' + currentUser.uid).onDisconnect();
        playerOnDisconnect.remove();
        console.log('[Presence] ê²ŒìŠ¤íŠ¸ onDisconnect ì„¤ì •ë¨ (ì¦‰ì‹œ ì œê±°)');
    }
}

// [ì‹ ê·œ] onDisconnect í•¸ë“¤ëŸ¬ë¥¼ ì·¨ì†Œí•˜ëŠ” í•¨ìˆ˜
function cancelMyOnDisconnectHandler() {
    if (hostOnDisconnect) {
        try { hostOnDisconnect.cancel(); } catch(e) {}
        hostOnDisconnect = null;
        console.log('[Presence] í˜¸ìŠ¤íŠ¸ onDisconnect ì·¨ì†Œë¨');
    }
    if (playerOnDisconnect) {
        try { playerOnDisconnect.cancel(); } catch(e) {}
        playerOnDisconnect = null;
        console.log('[Presence] ê²ŒìŠ¤íŠ¸ onDisconnect ì·¨ì†Œë¨');
    }
}

        function initializeRoom() {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('roomId');
            const isSoloQuiz = urlParams.get('mode') === 'solo' && roomId === 'solo_quiz_temp';

            if (isSoloQuiz) {
                const game = availableGames.find(g => g.id === 'quiz');
                if (game) { window.location.replace(`${game.file}?roomId=${roomId}&mode=solo`); return; }
            }
            if (!roomId) { alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤."); window.location.href = 'ëŒ€ê¸°ì‹¤.html'; return; }

            roomRef = roomsRef.child(roomId);
            roomRef.once('value', snapshot => {
                if (!snapshot.exists()) { alert("ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); window.location.href = 'ëŒ€ê¸°ì‹¤.html'; return; }

                const roomData = snapshot.val();
                const game = availableGames.find(g => g.id === roomData.gameType);
                const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
                const isPlayerAlreadyIn = roomData.players && roomData.players[currentUser.uid];

                if (!isPlayerAlreadyIn && game && playerCount >= game.maxPlayers) { alert("ë°©ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤."); window.location.href = 'ëŒ€ê¸°ì‹¤.html'; return; }

                isHost = roomData.hostId === currentUser.uid; // isHost ì—¬ê¸°ì„œ í• ë‹¹

                // [ì‹ ê·œ] ë°©ì¥ì´ 'lobby' ìƒíƒœì˜ ë°©ìœ¼ë¡œ ë³µê·€í•œ ê²½ìš°,
                // ë°©ì„ 'waiting' ìƒíƒœë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
                if (isHost && roomData.status === 'lobby') {
                    console.log("ë°©ì¥ ë³µê·€: 'lobby' ìƒíƒœë¥¼ 'waiting'ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.");
                    roomRef.update({
                        status: 'waiting',
                        // ì• ë‹ˆíŒ¡ì—ì„œ ì‚¬ìš©í•œ ì´ˆê¸°í™” ë°ì´í„°ë¥¼ ì—¬ê¸°ì„œë„ ë™ì¼í•˜ê²Œ ì ìš©
                        gameStarted: false, 
                        readyPlayers: null,
                        rematchRequests: null,
                        attacks: null
                    });
                }

                const myPlayerData = {
                    nickname: myNickname, avatar: myAvatar, bombSkin: myBombSkin, isHost: isHost,
                    entryEffect: myEntryEffect, // âœ¨ [ì¶”ê°€]
                    level: myLevel // âœ¨ [ì‹ ê·œ] ë ˆë²¨ ì¶”ê°€
                };

                roomRef.child('players/' + currentUser.uid).set(myPlayerData).then(() => {
                    listenToRoomChanges();
                }).catch(error => {
                    console.error("Error joining room:", error); alert("ë°© ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); window.location.href = 'ëŒ€ê¸°ì‹¤.html';
                });
            });
        }

        function listenToRoomChanges() {
            roomRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                     if (!document.querySelector('.overlay.active')) { // ê²Œì„ ì¢…ë£Œ ëª¨ë‹¬ ë“±ì´ ë–  ìˆì§€ ì•Šì„ ë•Œë§Œ ì•Œë¦¼
                        alert("ë°©ì´ ì‚¬ë¼ì¡ŒìŠµë‹ˆë‹¤.");
                     }
                     cleanupAndExit();
                     return;
                 }
                const oldRoomData = currentRoomData;
                currentRoomData = snapshot.val();

                // âœ… ë³€ê²½ ì½”ë“œ (ìœ„ ë¸”ë¡ ì „ì²´ êµì²´)
if (currentRoomData.status === 'playing') {
    const game = availableGames.find(g => g.id === currentRoomData.gameType);
    if (game) {
        if (isHost) {
            if(hostOnDisconnect) hostOnDisconnect.cancel();
            roomRef.onDisconnect().cancel();
        } else {
            if(playerOnDisconnect) playerOnDisconnect.cancel();
            roomRef.child('players/' + currentUser.uid).onDisconnect().cancel();
        }
        if(roomRef) roomRef.off();
        window.location.href = `${game.file}?roomId=${snapshot.key}`;
    }
    return;
}

// ğŸ”¹ [ì‹ ê·œ] ê²Œì„ ì¢…ë£Œ í›„ ë³µê·€ ì‹œ 'lobby' ìƒíƒœë¥¼ 'waiting'ìœ¼ë¡œ ì´ˆê¸°í™”
if (currentRoomData.status === 'lobby') {
            if (isHost) {
                console.log("[ê²Œì„ë°©] 'lobby' ìƒíƒœ ê°ì§€. 'waiting'ìœ¼ë¡œ ì´ˆê¸°í™”.");
                roomRef.update({
                    status: 'waiting',
            gameStarted: false,
            readyPlayers: null,
            rematchRequests: null,
            attacks: null
        });
    }
   return;
}

                if (!currentRoomData.players || !currentRoomData.players[currentUser.uid]) {
                     if (!document.querySelector('.overlay.active')) {
                        alert("ë°©ì—ì„œ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                     }
                     cleanupAndExit();
                     return;
                 }

                isHost = currentRoomData.hostId === currentUser.uid; // ë°ì´í„° ë³€ê²½ ì‹œ isHost ì¬í™•ì¸

               // onDisconnect ì„¤ì • (Firebase ì—°ê²°ì´ ë³µêµ¬ë  ë•Œë§ˆë‹¤ í˜¸ì¶œë¨)
                setMyOnDisconnectHandler();

                updateUI();
                handlePlayerChanges(oldRoomData ? oldRoomData.players : {});
                loadingOverlay.style.display = 'none';
            });
            roomRef.child('chat').on('child_added', snapshot => {
                const msg = snapshot.val();
                if (!msg) return;

                renderChatMessage(msg); // 1. ì±„íŒ…ì°½ì— ë Œë”ë§ (ê¸°ì¡´ ë¡œì§)
                
                // 2. âœ¨ [ì‹ ê·œ] TTSë¡œ ë©”ì‹œì§€ ì½ì–´ì£¼ê¸°
                if (msg && !msg.isSystem && msg.senderId !== currentUser.uid && synthesis && isTTSOn) {
                    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì•„ë‹ˆê³ , ë‚´ê°€ ë³´ë‚¸ê²Œ ì•„ë‹ˆê³ , TTSê°€ ì§€ì›ë˜ê³ , âœ¨ìƒˆë¡œìš´ í† ê¸€(isTTSOn)ì´ ì¼œì ¸ìˆë‹¤ë©´
                    try {
                        // ì´ì „ì— ì½ë˜ê²Œ ìˆìœ¼ë©´ ì¤‘ì§€
                        if (synthesis.speaking) {
                            synthesis.cancel(); 
                        }
                        
                        // --- [ìˆ˜ì •] 'ë‹¨ì¶•ì–´ ë²ˆì—­' í•¨ìˆ˜ë¥¼ ê±°ì¹œ í…ìŠ¤íŠ¸ë¡œ ì½ê¸° ---
                        const processedText = preprocessTextForTTS(msg.content);
                        const utterance = new SpeechSynthesisUtterance(processedText);
                        
                        // --- [ìˆ˜ì •] ì €ì¥ëœ ëª©ì†Œë¦¬ ì ìš© ---
                        const savedVoiceURI = localStorage.getItem(TTS_VOICE_KEY);
                        if (savedVoiceURI) {
                            // voiceListëŠ” populateVoiceList() í•¨ìˆ˜ì—ì„œ ì´ë¯¸ ì±„ì›Œì§
                            const savedVoice = voiceList.find(v => v.voiceURI === savedVoiceURI);
                            if (savedVoice) {
                                utterance.voice = savedVoice;
                            }
                        }
                        // --- [ìˆ˜ì •] ë ---
                        
                        utterance.lang = 'ko-KR';
                        utterance.rate = 1.1; // ì¡°ê¸ˆ ë¹ ë¥´ê²Œ
                        synthesis.speak(utterance);
                    } catch (e) {
                        console.error("TTS ì‹¤í–‰ ì˜¤ë¥˜:", e);
                    }
                }
            });
        }

        function handlePlayerChanges(oldPlayers) {
            const currentPlayers = currentRoomData.players || {};
            const oldPlayerIds = Object.keys(oldPlayers);
            const currentPlayerIds = Object.keys(currentPlayers);
            const joined = currentPlayerIds.filter(id => !oldPlayerIds.includes(id));
            const left = oldPlayerIds.filter(id => !currentPlayerIds.includes(id));

            joined.forEach(id => {
                const joinedPlayer = currentPlayers[id]; // âœ¨ [ìˆ˜ì •]
                if (id !== currentUser.uid && oldPlayerIds.length > 0) {
                    addSystemMessage(`${joinedPlayer.nickname}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
                    playSound('enter-sound');
                    vibrate();
                    // âœ¨ [ì‹ ê·œ] ì ‘ì†í•œ ìœ ì €ê°€ ì¹œêµ¬ì¸ì§€ í™•ì¸
                    if (myFriendIds[id]) {
                        showToast(`ğŸ”” ${escapeHTML(joinedPlayer.nickname)}ë‹˜ì´ ì ‘ì†í–ˆì–´ìš”!`);
                    }
                    // âœ¨ [ì œê±°] ì…ì¥ ì´í™íŠ¸ ì¬ìƒ (updateUIê°€ ì²˜ë¦¬)
                    // playEntryEffect(id, joinedPlayer.entryEffect);
                }
            });
            left.forEach(id => {
                const leftPlayerNickname = oldPlayers[id]?.nickname;
                 if (leftPlayerNickname) {
                    addSystemMessage(`${leftPlayerNickname}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
                    playSound('leave-sound');
                    vibrate();
                 }
            });
       }

        
        function updateUI() {
            const game = availableGames.find(g => g.id === currentRoomData.gameType);
            document.getElementById('room-name-header').textContent = currentRoomData.roomName;
            document.getElementById('game-type-header').textContent = game ? `${game.icon} ${game.name}` : '';

            const playerList = document.getElementById('player-list-horizontal');
            playerList.innerHTML = '';
            const playerIds = Object.keys(currentRoomData.players || {}); // null ì²´í¬ ì¶”ê°€

            for (let i = 0; i < (game?.maxPlayers || 0); i++) {
                const playerId = playerIds[i];
                const player = playerId ? currentRoomData.players[playerId] : null;
                const slot = document.createElement('div');
                slot.className = 'player-slot-compact';
                
                if (player) {
                    slot.dataset.playerId = playerId; // âœ¨ [ìœ ì§€] í”Œë ˆì´ì–´ IDë¥¼ DOMì— ì €ì¥
                    if (player.isHost) slot.classList.add('is-host');

                    // 1. ì•„ë°”íƒ€ ìš”ì†Œ ìƒì„±
                    const avatarEl = document.createElement('div');
                    avatarEl.className = 'avatar';

                    const avatarSet = AVATAR_SETS[player.avatar];
                    let avatarHTML = '';
                    if (avatarSet) { avatarHTML = `<img src="${avatarSet.front}" alt="avatar">`; }
                    else if (player.avatar && (player.avatar.startsWith('http') || /\.(png|jpg|jpeg|gif|webp)$/i.test(player.avatar))) { avatarHTML = `<img src="${player.avatar}" alt="avatar">`; }
                    else { avatarHTML = player.avatar || 'â“'; }
                    avatarEl.innerHTML = avatarHTML;

                    // 2. âœ¨ [ì‹ ê·œ] ì§€ì†í˜• ì´í™íŠ¸ ì¶”ê°€ (í”Œë ˆì´ì–´ ë°ì´í„° ê¸°ë°˜)
                    const effectId = player.entryEffect;

                    // [ì‹ ê·œ] ì ìš© ì „ ì´ˆê¸°í™”
                    avatarEl.classList.remove('effect-spotlight-equipped-bg', 'preview-effect-flames');
                    const existingOverlay = avatarEl.querySelector('.entry-effect-overlay, .effect-angel-halo, .effect-frozen-overlay');
                    if (existingOverlay) {
                        existingOverlay.remove();
                    }

                    if (effectId) {
                        const effectOverlay = document.createElement('div');
                        effectOverlay.className = 'entry-effect-overlay'; // ê¸°ë³¸ í´ë˜ìŠ¤
                        
                        if (effectId === 'effect_sparkle') {
                            effectOverlay.classList.add('effect-sparkle-persistent');
                            avatarEl.appendChild(effectOverlay);
                        } else if (effectId === 'effect_spotlight') {
                            effectOverlay.classList.add('effect-spotlight-persistent');
                            avatarEl.classList.add('effect-spotlight-equipped-bg');
                            avatarEl.appendChild(effectOverlay);
                        } else if (effectId === 'effect_flames') {
                            // 'ì´ê¸€ì´ê¸€'ì€ í´ë˜ìŠ¤ë§Œ ì¶”ê°€ (ì˜¤ë²„ë ˆì´ div ì—†ìŒ)
                            avatarEl.classList.add('preview-effect-flames');
                        } else if (effectId === 'effect_angel') {
                            // 'ì²œì‚¬ ë§'ì€ ì „ìš© í´ë˜ìŠ¤ë¡œ div ì¶”ê°€
                            effectOverlay.className = 'effect-angel-halo';
                            avatarEl.appendChild(effectOverlay);
                        } else if (effectId === 'effect_frozen') {
                            // 'ë¹™ê²°'ì€ ì „ìš© í´ë˜ìŠ¤ë¡œ div ì¶”ê°€
                            effectOverlay.className = 'effect-frozen-overlay';
                            avatarEl.appendChild(effectOverlay);
                        }
                    }
                    
                    // 3. ë‹‰ë„¤ì„ ìš”ì†Œ ìƒì„± (ì›ë˜ëŒ€ë¡œ)
                    const nicknameEl = document.createElement('div');
                    nicknameEl.className = 'nickname';
                    nicknameEl.textContent = escapeHTML(player.nickname || 'Unknown');

                    // 4. âœ¨ [ì‹ ê·œ] ë ˆë²¨ ë°°ì§€ ìƒì„±
                    const level = player.level || 1; // 2.1ë‹¨ê³„ì—ì„œ ì €ì¥í•œ ë ˆë²¨
                    const levelBadgeEl = document.createElement('div');
                    levelBadgeEl.className = 'player-level-badge';
                    levelBadgeEl.textContent = `Lv.${level}`;
                    
                    // 5. ìŠ¬ë¡¯ì— ì•„ë°”íƒ€, ë ˆë²¨ ë°°ì§€, ë‹‰ë„¤ì„ ìˆœìœ¼ë¡œ ì¶”ê°€
                    slot.appendChild(avatarEl);
                    slot.appendChild(levelBadgeEl); // [ìˆ˜ì •] ë‹‰ë„¤ì„ë³´ë‹¤ ìœ„ë¡œ ì´ë™
                    slot.appendChild(nicknameEl);
                    
                    // 5. âœ¨ [ìœ ì§€] ê°•í‡´ ë²„íŠ¼ ë¡œì§
                    if (isHost && !player.isHost) {
                        const kickBtn = document.createElement('button');
                        kickBtn.textContent = 'X';
                        kickBtn.style.position = 'absolute';
                        kickBtn.style.top = '0';
                        kickBtn.style.right = '0';
                        kickBtn.style.background = 'var(--danger-color)';
                        kickBtn.style.color = 'white';
                        kickBtn.style.border = '1px solid white';
                        kickBtn.style.borderRadius = '50%';
                        kickBtn.style.width = '20px';
                        kickBtn.style.height = '20px';
                        kickBtn.style.lineHeight = '18px'; // í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬
                        kickBtn.style.padding = '0';
                        kickBtn.style.cursor = 'pointer';
                        kickBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm(`${player.nickname} ë‹˜ì„ ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                                roomRef.child('players/' + playerId).remove();
                            }
                        };
                        /* slot.style.position = 'relative'; // [ì œê±°] 1ë²ˆ CSS ìˆ˜ì •ìœ¼ë¡œ ë¶ˆí•„ìš” */
                        slot.appendChild(kickBtn);
                    }
                } else {
                    // ë¹ˆ ìŠ¬ë¡¯
                    slot.innerHTML = `<div class="avatar"></div><div class="nickname">ëŒ€ê¸°ì¤‘...</div>`;
                }
                playerList.appendChild(slot);
            }

           if (isHost) {
                const playerCount = playerIds.length;
                const minPlayers = (game && game.id === 'quiz' && playerCount === 1) ? 1 : 2; // AI í€´ì¦ˆëŠ” 1ëª…ë¶€í„° ê°€ëŠ¥
                const canStart = game && playerCount >= minPlayers && playerCount <= game.maxPlayers;

                startGameBtn.style.display = 'block';
                startGameBtn.disabled = !canStart;
                if (playerCount < minPlayers) { startGameBtn.textContent = `(${minPlayers}ëª…ë¶€í„° ì‹œì‘ ê°€ëŠ¥)`; }
                else { startGameBtn.textContent = `ê²Œì„ ì‹œì‘ (${playerCount}/${game.maxPlayers})`; }
            } else {
                startGameBtn.style.display = 'none';
            }
        }

        function renderChatMessage(msg) {
            if (!msg) return;
            const msgEl = document.createElement('div');

            if (msg.isSystem) {
                msgEl.className = 'system-message';
                msgEl.textContent = msg.content;
            } else {
                // âœ¨ ìˆ˜ì •: currentRoomDataì™€ playersê°€ ì¡´ì¬í•˜ëŠ”ì§€ ë¨¼ì € í™•ì¸
                if (!currentRoomData || !currentRoomData.players) {
                    console.warn("renderChatMessage: currentRoomData.playersê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë©”ì‹œì§€:", msg);
                    return; // players ë°ì´í„° ì—†ìœ¼ë©´ ë Œë”ë§ ì¤‘ë‹¨
                }

                const senderInfo = currentRoomData.players[msg.senderId];
                if (!senderInfo) {
                    console.warn("renderChatMessage: senderInfoë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. senderId:", msg.senderId);
                    // ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì ì²˜ë¦¬ (ì„ íƒ ì‚¬í•­)
                    // msgEl.innerHTML = `<div><strong>Unknown:</strong> ${escapeHTML(msg.content)}</div>`;
                    return; // senderInfo ì—†ìœ¼ë©´ ì¤‘ë‹¨
                }

                msgEl.className = 'chat-message';
                if (msg.senderId === currentUser.uid) msgEl.classList.add('my-message');

                const avatarSet = AVATAR_SETS[senderInfo.avatar];
                let avatarHTML = '';
                if (avatarSet) {
                    avatarHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                } else if (senderInfo.avatar && (senderInfo.avatar.startsWith('http') || /\.(png|jpg|jpeg|gif|webp)$/i.test(senderInfo.avatar))) {
                    avatarHTML = `<img src="${senderInfo.avatar}" alt="avatar">`;
                } else {
                    avatarHTML = senderInfo.avatar || 'â“'; // ê¸°ë³¸ê°’
                }
                msgEl.innerHTML = `
                    <div class="sender-avatar">${avatarHTML}</div>
                    <div class="msg-body">
                        <div class="sender">${escapeHTML(senderInfo.nickname || 'Unknown')}</div>
                        <div class="content">${escapeHTML(msg.content)}</div>
                    </div>`;
            }

            // âœ¨ chatContainerê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì¶”ê°€
            const chatContainer = document.getElementById('chat-container'); // chatContainer ë³€ìˆ˜ ë‹¤ì‹œ ì •ì˜ ë˜ëŠ” ì „ì—­/ìƒìœ„ ìŠ¤ì½”í”„ ì‚¬ìš©
            if (chatContainer) {
                chatContainer.appendChild(msgEl);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                console.error("renderChatMessage: chatContainer ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }

        function addSystemMessage(message) {
             if (roomRef) { // roomRef null ì²´í¬
                roomRef.child('chat').push({ isSystem: true, content: message, timestamp: firebase.database.ServerValue.TIMESTAMP });
             }
        }

      // [ì‹ ê·œ] TTSê°€ ì½ê¸° ì „ì— í…ìŠ¤íŠ¸ë¥¼ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ ìƒìš©êµ¬
        function preprocessTextForTTS(text) {
            // 1. ã…‹/ã… (ì›ƒìŒì†Œë¦¬)ëŠ” ë¬¸ì¥ ì¤‘ê°„ì— ìˆì–´ë„ ë³€í™˜
            // (ìµœì†Œ 2ê°œ ì´ìƒ ì—°ì†ë  ë•Œë§Œ)
            let processedText = text.replace(/ã…‹{2,}/g, 'í¬í¬í¬'); // ã…‹ã…‹ã…‹ -> í¬í¬í¬
            processedText = processedText.replace(/ã…{2,}/g, 'ííí'); // ã…ã…ã… -> ííí

            // 2. ë‹¨ì¶•ì–´ëŠ” "ë©”ì‹œì§€ ì „ì²´"ê°€ ì¼ì¹˜í•  ë•Œë§Œ ë³€í™˜ (ì˜¤ì‘ë™ ë°©ì§€)
            // (ì˜ˆ: "ìƒˆìš°ã…‡ã…‡"ê°€ "ìƒˆìš°ì‘ì‘"ì´ ë˜ëŠ” ê²ƒì„ ë°©ì§€)
            if (processedText === 'ã…ã…‡') return 'í•˜ì´';
            if (processedText === 'ã…‡ã…‡') return 'ì´ì‘ì´ì‘'; // 'ì´ì‘ì´ì‘'ë³´ë‹¤ ëŒ€í™”ì˜ ëœ»(Yes)ì— ë§ê²Œ 'ì‘ì‘'ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            if (processedText === 'ã„±ã„±') return 'ê³ ê³ ';
            if (processedText === 'ã„´ã„´') return 'ë…¸ë…¸'; // (ìì£¼ ì“°ì´ëŠ” ê²ƒ ì¶”ê°€)
            if (processedText === 'ã…ˆã……') return 'ì£„ì†¡'; // (ìì£¼ ì“°ì´ëŠ” ê²ƒ ì¶”ê°€)
            if (processedText === 'ã…‹ã…‹ã…‹ã…‹') return 'í¬í¬í¬í¬'; // (ìì£¼ ì“°ì´ëŠ” ê²ƒ ì¶”ê°€)
                        if (processedText === 'ã…‹ã…‹ã…‹ã…‹ã…‹') return 'í¬í¬í¬í¬'; // (ìì£¼ ì“°ì´ëŠ” ê²ƒ ì¶”ê°€)
                        if (processedText === 'ì˜¨ëŒ€?') return 'ì˜ìƒê¸´ ì˜¤ë¹  ì˜¨ëŒ€?'; // (ìì£¼ ì“°ì´ëŠ” ê²ƒ ì¶”ê°€)

            // 3. ì›ƒìŒì†Œë¦¬ë§Œ ë³€í™˜ë˜ì—ˆê±°ë‚˜, ë³€í™˜ì´ í•„ìš” ì—†ëŠ” í…ìŠ¤íŠ¸ ë°˜í™˜
            return processedText;
        }

        // [ì‹ ê·œ] TTS ì—”ì§„ì„ "ê¹¨ìš°ëŠ”" (Prime) í•¨ìˆ˜
        // (iOS/Safariì—ì„œ ê³ í’ˆì§ˆ ìŒì„± ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê¸° ìœ„í•œ í•µ/íŠ¸ë¦­)
        function primeTTSEngine() {
            if (!synthesis) return;
            
            // .speak()ë¥¼ í•œ ë²ˆ í˜¸ì¶œí•´ì•¼ë§Œ
            // ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¡œë“œë˜ëŠ” ì „ì²´ ìŒì„± ëª©ë¡ì´ 'onvoiceschanged' ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.
            const emptyUtterance = new SpeechSynthesisUtterance('');
            emptyUtterance.lang = 'ko-KR';
            
            // ì—ëŸ¬ê°€ ë‚˜ë„ ë¬´ì‹œí•©ë‹ˆë‹¤ (ìë™ì¬ìƒ ì •ì±… ë“±)
            try {
                // (ì°¸ê³ ) ì´ ì‹œì ì— synthesis.pause(), synthesis.resume()ì„
                // í˜¸ì¶œí•´ì•¼ë§Œ ëª©ë¡ì´ ë¡œë“œë˜ëŠ” êµ¬í˜• ì•ˆë“œë¡œì´ë“œ ê¸°ê¸°ë„ ìˆìŠµë‹ˆë‹¤.
                synthesis.pause();
                synthesis.resume();
                synthesis.speak(emptyUtterance);
            } catch (e) {
                console.warn("TTS ì—”ì§„ 'ê¹¨ìš°ê¸°' ì‹¤íŒ¨ (ìë™ì¬ìƒ ì •ì±…ì¼ ìˆ˜ ìˆìŒ):", e);
            }
        }

        function sendMessage(content) {
            const message = content.trim();
            if (message && roomRef) { // roomRef null ì²´í¬
                roomRef.child('chat').push({
                    senderId: currentUser.uid, senderNickname: myNickname, content: message, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }

        function startGame() {
            if (!isHost || !currentRoomData) return; // currentRoomData null ì²´í¬
            const game = availableGames.find(g => g.id === currentRoomData.gameType);
            if (!game) return;

            console.log('[ê²Œì„ë°©] ê²Œì„ ì‹œì‘ - gameType:', game.id);
            const playerIds = Object.keys(currentRoomData.players || {}); // null ì²´í¬
            const updates = {};

          if (game.id === 'reversi') {
                // [ë¦¬ë²„ì‹œ] ì´ˆê¸°í™”
                const initialBoard = Array(64).fill(null);
                initialBoard[27] = 'white'; initialBoard[28] = 'black';
                initialBoard[35] = 'black'; initialBoard[36] = 'white';

                playerIds.sort(() => Math.random() - 0.5); // í‘/ë°± ëœë¤ ë°°ì •
                
                updates['players/' + playerIds[0] + '/color'] = 'black';
                updates['players/' + playerIds[1] + '/color'] = 'white';
                
                updates.board = initialBoard;
                updates.turn = 'black'; // í‘ëŒ(black)ì´ ì„ ê³µ
                updates.passedTurn = false;
                updates.lastMove = null;

            } else if (game.id === 'memoryGame') {
                // âœ¨ [ì±„ì›€] ë©”ëª¨ë¦¬ ê²Œì„ ì´ˆê¸°í™”
                const pairCount = playerIds.length <= 2 ? 8 : 10; // 2ëª…=16ì¥(4x4), 3~4ëª…=20ì¥(5x4)
                const cards = generateCards(pairCount);
                updates.board = cards;
                updates.turn = playerIds[0]; // ë°©ì¥ë¶€í„°
                updates.scores = {};
                playerIds.forEach(id => { updates.scores[id] = 0; });
                updates.flippedIndices = [];
                updates.matchedPairs = 0;
                updates.lastPlayer = null; // [ì¶”ê°€] ì—°ì† í„´ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë³€ìˆ˜

            } else if (game.id === 'indianpoker') {
                // âœ¨ [ì±„ì›€] ì¸ë””ì–¸ í¬ì»¤ ì´ˆê¸°í™” (ì¹© ì„¸íŒ…)
                updates.gameState = {};
                playerIds.forEach(id => {
                    updates.gameState[id] = {
                        chips: 30, // 1ì¸ë‹¹ ê¸°ë³¸ ì¹©
                        hand: null,
                        bet: 0,
                        status: 'ready' // 'ready', 'betting', 'folded'
                    };
                });
                updates.turn = playerIds[0];
                updates.pot = 0;
                updates.round = 1;
                updates.deck = null; // ë±ì€ ì¸ë””ì–¸í¬ì»¤.htmlì—ì„œ ìƒì„±

            } else if (game.id === 'bomber') {
                // âœ¨ [ì±„ì›€] ë´„ë²„ë§¨ ì´ˆê¸°í™” (í”Œë ˆì´ì–´ ë²ˆí˜¸ í• ë‹¹)
                // ë´„ë²„ë§¨.htmlì—ì„œ ì´ ë²ˆí˜¸ë¥¼ ë³´ê³  ì‹œì‘ ìœ„ì¹˜ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
                playerIds.forEach((id, index) => {
                    updates['players/' + id + '/playerNum'] = index + 1; // 1, 2, 3, 4
                });
                updates.gameData = { status: 'ready' }; // ê²Œì„ ì‹œì‘ ì‹ í˜¸
                
            } else if (game.id === 'shisenSho') {
                // âœ¨ [ìœ ì§€] ì‚¬ì²œì„±ì€ shisenSho.htmlì—ì„œ ë°©ì¥ì´ ì§ì ‘ ë§µì„ ìƒì„±í•©ë‹ˆë‹¤.
                /* ... */
            } else if (game.id === 'tetris') {
                
                // âœ¨ [ìœ ì§€] í…ŒíŠ¸ë¦¬ìŠ¤ëŠ” tetris.htmlì—ì„œ ë°©ì¥ì´ ì§ì ‘ ë§µì„ ìƒì„±í•©ë‹ˆë‹¤.
                /* ... */
            } else { 
                // âœ¨ [ìœ ì§€] ì•Œê¹Œê¸°, í¬ë¡œì‹±ë‚˜ì´ì¸  ë“± (ìì²´ ì´ˆê¸°í™” ë¡œì§ ê°€ì •)
                /* ... */ 
            }
            updates.status = 'playing'; // ê³µí†µ ìƒíƒœ ë³€ê²½

            console.log('[ê²Œì„ë°©] Firebase ì—…ë°ì´íŠ¸ ì‹¤í–‰:', updates);
            if (roomRef) { // roomRef null ì²´í¬
                roomRef.update(updates).then(() => {
                    console.log('[ê²Œì„ë°©] ì—…ë°ì´íŠ¸ ì„±ê³µ!');
                }).catch(error => {
                    console.error('[ê²Œì„ë°©] ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                });
            }
        }

        function generateCards(pairCount) {
            // ì•„ì´ì½˜/ì´ë¯¸ì§€ ë“± (í•„ìš”ì— ë”°ë¼ ì¶”ê°€)
            const icons = [
                'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯',
                'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦…'
            ]; // 20ì¢…ë¥˜
            
            const pairs = [];
            for (let i = 0; i < pairCount; i++) {
                const icon = icons[i % icons.length];
                pairs.push(icon, icon); // ì•„ì´ì½˜ì„ 2ê°œì”© ë„£ìŒ
            }

            // Fisher-Yates shuffle
            for (let i = pairs.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pairs[i], pairs[j]] = [pairs[j], pairs[i]];
            }
            
            // Firebaseì— ì €ì¥í•  ì¹´ë“œ ê°ì²´ ë°°ì—´ ìƒì„±
            return pairs.map((icon, index) => ({
                id: index,
                icon: icon,
                isFlipped: false,
                isMatched: false
            }));
        }

        function cleanupAndExit() {
            console.log("Cleanup and Exit called");
            if (roomRef) {
                try { roomRef.off(); } catch(e) { console.warn("roomRef listener removal failed:", e); }
            }
            // onDisconnect í•¸ë“¤ëŸ¬ ì·¨ì†Œ ì‹œë„
            if (hostOnDisconnect) { try { hostOnDisconnect.cancel(); } catch(e) { console.warn("Host onDisconnect cancel failed:", e); } }
            if (playerOnDisconnect) { try { playerOnDisconnect.cancel(); } catch(e) { console.warn("Player onDisconnect cancel failed:", e); } }
// âœ¨ [ì‹ ê·œ] ì¹œêµ¬ ì ‘ì† ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (friendStatusListener) {
                try { friendStatusRef.off('child_added', friendStatusListener); } catch(e) { console.warn("Friend status listener removal failed:", e); }
            }
            let removePromise = Promise.resolve(); // ê¸°ë³¸ Promise

            if (roomRef && currentUser) {
                if (isHost) {
                    console.log("Host removing room...");
                    removePromise = roomRef.remove();
                } else {
                    console.log("Guest removing self from players...");
                    removePromise = roomRef.child('players/' + currentUser.uid).remove();
                }
            } else {
                 console.log("roomRef or currentUser missing, redirecting directly.");
            }

            removePromise
                .catch(e => console.error("Firebase remove operation failed:", e)) // ì‹¤íŒ¨ ì‹œ ë¡œê¹…
                .finally(() => {
                    console.log("Redirecting to ëŒ€ê¸°ì‹¤.html");
                    window.location.replace('ëŒ€ê¸°ì‹¤.html'); // replace ì‚¬ìš©
                });
        }


        // --- ë‚˜ë¨¸ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
chatInput.addEventListener('focus', () => {
            // [ìˆ˜ì •] í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¬ ë•Œ ë·°ë¥¼ ê°•ì œë¡œ ìŠ¤í¬ë¡¤í•˜ëŠ” ëŒ€ì‹ ,
            // ì±„íŒ…ì°½ ìì²´ë¥¼ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ìµœì‹  ë©”ì‹œì§€ê°€ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
            setTimeout(() => {
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                // lobbyFooter.scrollIntoView... ì½”ë“œëŠ” ì‚­ì œí•©ë‹ˆë‹¤.
            }, 150); // í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¤ëŠ” ì‹œê°„ ì ì‹œ ëŒ€ê¸°
        });
        sendChatBtn.addEventListener('click', () => { sendMessage(chatInput.value); chatInput.value = ''; chatInput.focus(); });
chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') { sendMessage(chatInput.value); chatInput.value = ''; e.preventDefault(); }});

// ì¹œêµ¬ì´ˆëŒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
const inviteBtn = document.getElementById('invite-btn');
// âœ¨ [ì‹ ê·œ] ì´ˆëŒ€ ë§í¬ ë³µì‚¬ ë²„íŠ¼
        const copyInviteBtn = document.createElement('button');
        copyInviteBtn.id = 'copy-invite-btn';
        copyInviteBtn.className = 'header-btn invite'; // ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©
        copyInviteBtn.textContent = 'ì¹œêµ¬ì´ˆëŒ€';
        // ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ (ì•…ì„¼íŠ¸ ìƒ‰ìƒ ì‚¬ìš©)
        copyInviteBtn.style.backgroundColor = 'var(--accent-color)';
        copyInviteBtn.style.color = 'var(--text-color-dark)';
        copyInviteBtn.style.borderBottomColor = '#D1B030';
        
// [ìˆ˜ì •] ì¹´ì¹´ì˜¤ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ë¶€ëª¨(ë˜í¼)ì— ì¶”ê°€
            const inviteBtnContainer = document.getElementById('invite-btn').parentNode;
            inviteBtnContainer.appendChild(copyInviteBtn);

        copyInviteBtn.addEventListener('click', () => {
            if (!roomRef) return;
            // âœ¨ [ìˆ˜ì •] index.html -> ëŒ€ê¸°ì‹¤.htmlë¡œ ë³€ê²½ (ì‚¬ìš©ì ìš”ì²­)
            const inviteURL = `https://bangat.github.io/game/ëŒ€ê¸°ì‹¤.html?roomId=${roomRef.key}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(inviteURL).then(() => {
                    // âœ¨ [ìˆ˜ì •] showAlert -> showToast
                    showToast('ì´ˆëŒ€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }).catch(err => {
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    // âœ¨ [ìˆ˜ì •] showAlert -> showToast
                    showToast('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
            } else {
                // êµ¬í˜• ë¸Œë¼ìš°ì € fallback
                // âœ¨ [ìˆ˜ì •] showAlert -> showToast
                showToast('ë§í¬ë¥¼ ë³µì‚¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            // --- [ì‹ ê·œ] ì‚¬ìš©ì ìš”ì²­: ë§í¬ ë³µì‚¬ì™€ ë™ì‹œì— ì´ˆëŒ€ ëª¨ë‹¬ ì—´ê¸° ---
            if (gameSettings.sfx) playSound('enter-sound'); // íš¨ê³¼ìŒ ì¬í™œìš©
            loadAndShowInviteModal();
            // --- [ì‹ ê·œ] ---
        });

if (inviteBtn) {
    inviteBtn.addEventListener('click', kakaoInvite);
    console.log('ì¹œêµ¬ì´ˆëŒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°ë¨.');
}



        startGameBtn.addEventListener('click', startGame);
        leaveRoomBtn.addEventListener('click', () => { history.back(); });
        emojiToggleBtn.addEventListener('click', e => { e.stopPropagation(); emojiPopover.classList.toggle('active'); });
        document.addEventListener('click', () => emojiPopover.classList.remove('active'));
       emojiPopover.addEventListener('click', e => { if(e.target.tagName === 'BUTTON'){ sendMessage(e.target.textContent); emojiPopover.classList.remove('active'); } });

     
       // --- [ì‹ ê·œ] ëŒ€ê¸°ì‹¤ ì¹œêµ¬ ì´ˆëŒ€ ë¡œì§ ---

        let presenceRef = db.ref('status'); // ì ‘ì† ìƒíƒœ ì°¸ì¡°
        let myFriendsRef = null;
        let myFriendIds = {};

        // 2. ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
        friendInviteModalCloseBtn.addEventListener('click', () => {
            friendInviteModal.classList.remove('active');
        });

        // 3. ì´ˆëŒ€ ëª¨ë‹¬ ì—´ê¸° ë° ëª©ë¡ ë¡œë“œ
        async function loadAndShowInviteModal() {
            friendInviteModal.classList.add('active');
            friendInviteListContainer.innerHTML = '<div class="spinner" style="margin: 30px auto;"></div>';

            try {
                // [ìˆ˜ì •] 1. ì¹œêµ¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì œê±°

                // 2. í˜„ì¬ ì ‘ì†ì ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const presenceSnap = await presenceRef.once('value');
                if (!presenceSnap.exists()) {
                    friendInviteListContainer.innerHTML = '<p style="text-align:center; padding: 20px;">í˜„ì¬ ì ‘ì† ì¤‘ì¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                const onlineUserIds = Object.keys(presenceSnap.val());
                
                // 3. í˜„ì¬ ë°©ì— ìˆëŠ” ìœ ì € ëª©ë¡
                const playerIdsInRoom = Object.keys(currentRoomData.players || {});

                // 4. [ìˆ˜ì •] í•„í„°ë§: (ì ‘ì†ì¤‘ && ì´ ë°©ì— ì—†ìŒ)
                const targetUids = onlineUserIds.filter(uid => 
                    // myFriendIds[uid] &&  <-- ì¹œêµ¬ ì¡°ê±´ ì œê±°
                    uid !== currentUser.uid &&              // ë‚´ê°€ ì•„ë‹ˆê³ 
                    !playerIdsInRoom.includes(uid)          // ì´ ë°©ì— ì—†ê³ 
                );

                if (targetUids.length === 0) {
                    friendInviteListContainer.innerHTML = '<p style="text-align:center; padding: 20px;">ì´ˆëŒ€í•  ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // 5. í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const profilePromises = targetUids.map(uid => usersRef.child(uid).child('profile').once('value'));
                const profileSnapshots = await Promise.all(profilePromises);

                friendInviteListContainer.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
                profileSnapshots.forEach((snap, index) => {
                    if (snap.exists()) {
                        const profile = snap.val();
                        const uid = targetUids[index];
                        const itemEl = createInviteListItem(uid, profile);
                        friendInviteListContainer.appendChild(itemEl);
                    }
                });

            } catch (error) {
                console.error("ì´ˆëŒ€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                friendInviteListContainer.innerHTML = '<p style="text-align:center; padding: 20px;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        // 4. ì´ˆëŒ€ ëª©ë¡ ì•„ì´í…œ ìƒì„±
        function createInviteListItem(uid, profile) {
            const itemEl = document.createElement('div');
            itemEl.className = 'user-list-item';

            const avatarSet = AVATAR_SETS[profile.avatar];
            let avatarHTML = '';
            if (avatarSet) { avatarHTML = `<img src="${avatarSet.front}" alt="av">`; }
            else if (profile.avatar && (profile.avatar.startsWith('http') || profile.avatar.includes('.'))) { avatarHTML = `<img src="${profile.avatar}" alt="av">`; }
            else { avatarHTML = escapeHTML(profile.avatar || 'â“'); }

            itemEl.innerHTML = `
                <div class="user-list-avatar">${avatarHTML}</div>
                <div class="user-list-nickname">${escapeHTML(profile.nickname)}</div>
                <div class="user-item-actions">
                    <button class="menu-btn user-action-btn secondary" data-action="invite" data-uid="${uid}" data-nickname="${escapeHTML(profile.nickname)}">ì´ˆëŒ€</button>
                </div>
            `;

            // 5. ì´ˆëŒ€ ë²„íŠ¼ì— ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            itemEl.querySelector('[data-action="invite"]').addEventListener('click', (e) => {
                const btn = e.currentTarget;
                const targetUid = btn.dataset.uid;
                const targetNickname = btn.dataset.nickname;
                
                // ë²„íŠ¼ ë¹„í™œì„±í™”
                btn.disabled = true;
                btn.textContent = 'ì´ˆëŒ€ë¨';
                btn.classList.remove('secondary');
                btn.classList.add('light');

                // ì´ˆëŒ€ ë°ì´í„° ìƒì„±
                const game = availableGames.find(g => g.id === currentRoomData.gameType);
                const inviteData = {
                    from_uid: currentUser.uid,
                    from_name: myNickname,
                    room_id: roomRef.key,
                    room_name: currentRoomData.roomName,
                    game_name: game ? game.name : 'ì•Œ ìˆ˜ ì—†ëŠ” ê²Œì„',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                
                // Firebaseì— ì´ˆëŒ€ì¥ ì „ì†¡
                db.ref(`invitations/${targetUid}`).push(inviteData)
                    .then(() => {
                        showToast(`${targetNickname}ë‹˜ì„ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.`);
                        friendInviteModal.classList.remove('active'); // <-- [ì‹ ê·œ] ì´ ì¤„ì„ ì¶”ê°€í•˜ì„¸ìš”
                    })
                    .catch((err) => {
                        showToast('ì´ˆëŒ€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        console.error("ì´ˆëŒ€ ì‹¤íŒ¨:", err);
                        btn.disabled = false; // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë³µêµ¬
                        btn.textContent = 'ì´ˆëŒ€';
                        btn.classList.remove('light');
                        btn.classList.add('secondary');
                    });
            });

            return itemEl;
        }

        
    }); // --- DOMContentLoaded ë ---

    

</script>
<div id="toast-container"></div>


<div id="friend-invite-modal" class="overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <button class="close-btn" data-close>â€¹</button>
                <h2>ëŒ€ê¸°ì‹¤ ì¹œêµ¬ì´ˆëŒ€</h2>
            </div>
            <div class="modal-body">
                <div class="user-list" id="friend-invite-list-container">
                    <div class="spinner" style="margin: 30px auto;"></div>
                </div>
            </div>
        </div>
    </div>

<div id="confirm-exit-modal" class="overlay">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-body">
            <h3>ëŒ€ê¸°ì‹¤ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
            <p id="exit-modal-subtext">ë°©ì¥ì´ ë‚˜ê°€ë©´ ë°©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
        </div>
        <div class="modal-footer">
            <button id="exit-cancel-btn" class="menu-btn secondary">ì·¨ì†Œ</button>
            <button id="exit-confirm-btn" class="menu-btn primary" style="background-color: var(--danger-color); border-bottom-color: #A94442;">í™•ì¸</button>
        </div>
    </div>
</div>


<div id="alert-modal" class="overlay">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-body">
                <h3 id="alert-modal-message" style="font-size: 1.1em; margin: 0; line-height: 1.5; word-break: keep-all;"></h3>
            </div>
            <div class="modal-footer" style="padding: 20px;">
                <button id="alert-modal-ok-btn" class="menu-btn primary" style="width: 100%;">í™•ì¸</button>
            </div>
        </div>
    </div>

<div id="console-modal" style="display: none; position: fixed; bottom: 10px; right: 10px; width: 90%; max-width: 500px; height: 300px; background-color: rgba(0,0,0,0.8); color: white; border: 1px solid #555; border-radius: 8px; z-index: 9999; font-family: monospace; font-size: 12px; flex-direction: column;">
    <div style="padding: 5px; background-color: #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <span>ì¸ì•± ì½˜ì†”</span>
            <button id="clear-console-btn" style="padding: 2px 5px; font-size: 10px; background-color: #555; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 5px;">Clear</button>
            <button id="close-console-btn" style="padding: 2px 5px; font-size: 10px; background-color: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">X</button>
        </div>
    </div>
    <div id="console-output" style="padding: 10px; overflow-y: scroll; flex-grow: 1;"></div>
    <button id="open-console-btn" style="display: none; position: fixed; bottom: 10px; right: 10px; padding: 5px 10px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; z-index: 9998; cursor: pointer;">ì½˜ì†” ì—´ê¸°</button>
</div>

<div id="tts-settings-modal" class="overlay">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header" style="background-color: var(--primary-color); border-bottom-color: #C04A4A;">
            <h2 style="color: white; flex-grow: 1; text-align: center;">ì±„íŒ… ìŒì„± ì„¤ì •</h2>
        </div>
        <div class="modal-body" style="text-align: left; padding: 20px;">
            <div class="toggle-switch-container">
                <label for="tts-toggle-switch" class="toggle-switch-label">ì±„íŒ… ìŒì„± ë“£ê¸°</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="tts-toggle-switch">
                    <span class="slider round"></span>
                </label>
            </div>
            <hr style="border: none; border-top: 2px solid var(--panel-border); margin: 15px 0;">
            <label for="tts-voice-select" style="font-weight: 700; font-size: 0.9em; margin-bottom: 8px; display: block;">ëª©ì†Œë¦¬ ì„ íƒ (í•œêµ­ì–´)</label>
            <select id="tts-voice-select" style="width: 100%; padding: 10px; font-size: 1em; border-radius: 8px; border: 2px solid var(--text-color-dark); font-family: 'GmarketSans', sans-serif;">
                <option value="">ê¸°ë³¸ ëª©ì†Œë¦¬ (ë¸Œë¼ìš°ì €)</option>
                </select>
            <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
                ëª©ë¡ì€ ì‚¬ìš© ì¤‘ì¸ ë¸Œë¼ìš°ì €/OS(Siri, Google ë“±)ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œë©ë‹ˆë‹¤.
            </p>
        </div>
        <div class="modal-footer">
            <button id="tts-settings-close-btn" class="menu-btn secondary" style="width: 100%;">ë‹«ê¸°</button>
        </div>
    </div>
</div>
</body>
</html>