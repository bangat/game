<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <title>우리집 육아기록</title>
  <style>
    :root{
      --bg0:#fff6ea;
      --bg1:#f2f7ff;
      --ink:#1c1d23;
      --muted:rgba(28,29,35,.62);
      --card:rgba(255,255,255,.82);
      --line:rgba(28,29,35,.12);
      --shadow: 0 20px 50px rgba(26,28,36,.18);
      --r: 18px;

      --hot:#ff5a43;
      --cool:#2da7ff;
      --med:#7a4bff;
      --food:#ffb000;
      --note:#1bbd85;

      --kid0:#ff6b6b;
      --kid1:#4d96ff;
      --kid2:#1bbd85;
      --kid3:#ffb000;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      font-family: "Gmarket Sans", "NanumSquare", "Apple SD Gothic Neo", "Malgun Gothic", system-ui, sans-serif;
      background:
        radial-gradient(900px 520px at 8% 6%, rgba(255,90,67,.16), transparent 55%),
        radial-gradient(820px 520px at 85% 12%, rgba(45,167,255,.18), transparent 55%),
        radial-gradient(900px 640px at 55% 95%, rgba(122,75,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px 12px 56px;
    }

    .app{
      width:min(1100px, 100%);
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:14px;
    }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .top{
      padding: 16px 16px 12px;
      border-bottom:1px solid var(--line);
      background:
        radial-gradient(900px 300px at 10% 0%, rgba(255,90,67,.18), transparent 60%),
        radial-gradient(900px 300px at 90% 0%, rgba(45,167,255,.18), transparent 60%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    h1{
      margin:0;
      font-size: 20px;
      letter-spacing: -.2px;
      font-weight: 900;
    }
    .sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .badge{
      border:1px solid var(--line);
      background: rgba(255,255,255,.7);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: rgba(28,29,35,.82);
      white-space:nowrap;
      user-select:none;
    }

    .bar{
      padding: 12px 14px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .leftbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .rightbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .select{
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .select label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }
    select{
      border:1px solid rgba(28,29,35,.16);
      background: rgba(255,255,255,.9);
      border-radius: 12px;
      padding: 8px 10px;
      color: var(--ink);
      font-weight: 900;
      outline:none;
    }

    .search{
      flex: 1 1 220px;
      min-width: 240px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .search input{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      font-weight: 800;
      color: var(--ink);
    }
    .search input::placeholder{ color: rgba(28,29,35,.46); font-weight: 800; }

    .btn{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.76));
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.primary{
      border-color: rgba(28,29,35,.18);
      background:
        linear-gradient(180deg, rgba(28,29,35,.92), rgba(28,29,35,.82));
      color: rgba(255,255,255,.95);
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.72);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
    }
    .chip[data-on="1"]{
      border-color: rgba(28,29,35,.18);
      background: rgba(28,29,35,.92);
      color: rgba(255,255,255,.95);
    }

    .list{
      padding: 4px 12px 14px;
    }

    .day{
      margin-top: 10px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.72);
      overflow:hidden;
    }
    .dayHead{
      padding: 10px 12px;
      border-bottom:1px solid rgba(28,29,35,.10);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:
        radial-gradient(700px 220px at 10% 0%, rgba(255,176,0,.12), transparent 60%),
        radial-gradient(700px 220px at 90% 0%, rgba(45,167,255,.10), transparent 60%);
    }
    .dayHead .d{
      font-weight: 1000;
      letter-spacing: -.2px;
    }
    .dayHead .c{
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }

    .row{
      display:grid;
      grid-template-columns: 44px 1fr auto;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-top:1px solid rgba(28,29,35,.08);
    }
    .row:first-child{ border-top:0; }

    .icon{
      width:44px; height:44px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:1px solid rgba(28,29,35,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
      background:
        radial-gradient(120px 70px at 25% 20%, rgba(255,255,255,.62), transparent 50%),
        linear-gradient(180deg, rgba(255,255,255,.84), rgba(255,255,255,.64));
      font-weight: 1000;
      letter-spacing: -.4px;
    }
    .icon.temp{ border-color: rgba(255,90,67,.22); }
    .icon.med{ border-color: rgba(122,75,255,.22); }
    .icon.food{ border-color: rgba(255,176,0,.26); }
    .icon.note{ border-color: rgba(27,189,133,.22); }

    .meta{
      min-width:0;
    }
    .meta .t{
      font-weight: 1000;
      letter-spacing: -.2px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:baseline;
    }
    .meta .t .time{
      color: rgba(28,29,35,.62);
      font-weight: 950;
      font-size: 12px;
    }
    .meta .s{
      margin-top: 4px;
      color: rgba(28,29,35,.76);
      font-size: 12px;
      line-height: 1.35;
      overflow:hidden;
      display:-webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }

    .trail{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .kidDot{
      width:10px; height:10px;
      border-radius: 999px;
      border:1px solid rgba(28,29,35,.12);
      background: var(--kid0);
    }
    .thumb{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.6);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.6);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .rowBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .tiny{
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.62);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 950;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .tiny:active{ transform: translateY(1px); }

    .empty{
      padding: 18px 14px 20px;
      color: var(--muted);
      font-weight: 900;
      line-height: 1.4;
    }

    .right{
      padding: 12px 14px 14px;
    }
    .cards{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .cards{ grid-template-columns: 1fr; }
    }

    .kcard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 16px;
      padding: 12px 12px;
      min-height: 92px;
    }
    .kcard .k{ color: var(--muted); font-weight: 950; font-size: 12px; }
    .kcard .v{ margin-top: 6px; font-weight: 1100; font-size: 18px; letter-spacing: -.2px; }
    .kcard .p{ margin-top: 6px; color: rgba(28,29,35,.72); font-weight: 900; font-size: 12px; line-height:1.35; }

    .help{
      margin-top: 10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      border-radius: 16px;
      padding: 12px 12px;
      font-size: 13px;
      line-height: 1.5;
      color: rgba(28,29,35,.84);
    }
    .help b{ color: rgba(28,29,35,.96); }
    .help code{
      display:inline-block;
      padding: 1px 6px;
      border-radius: 10px;
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.82);
      font-weight: 950;
      font-size: 12px;
    }

    dialog{
      border: 0;
      border-radius: 18px;
      padding:0;
      box-shadow: 0 40px 120px rgba(0,0,0,.28);
      width: min(720px, calc(100% - 22px));
    }
    dialog::backdrop{
      background: rgba(10,12,18,.34);
      backdrop-filter: blur(4px);
    }
    .modalTop{
      padding: 14px 14px 12px;
      border-bottom:1px solid rgba(28,29,35,.12);
      background:
        radial-gradient(700px 250px at 10% 0%, rgba(255,176,0,.14), transparent 60%),
        radial-gradient(700px 250px at 90% 0%, rgba(45,167,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.82));
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .modalTop .mh{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .modalTop .mh .h{
      font-weight: 1100;
      font-size: 16px;
      letter-spacing: -.2px;
    }
    .modalTop .mh .p{
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
    }
    .modalBody{
      padding: 12px 14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
    }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .form{ grid-template-columns: 1fr; }
    }
    .f{
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.74);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .f label{
      display:block;
      font-weight: 950;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .f input, .f textarea, .f select{
      width:100%;
      border:1px solid rgba(28,29,35,.14);
      background: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
      font-weight: 950;
      color: var(--ink);
    }
    .f textarea{
      resize: vertical;
      min-height: 92px;
      font-weight: 850;
      line-height:1.4;
    }
    .f.wide{ grid-column: 1 / -1; }

    .photoBox{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .preview{
      width:58px; height:58px;
      border-radius: 16px;
      border:1px solid rgba(28,29,35,.12);
      background: rgba(255,255,255,.7);
      overflow:hidden;
    }
    .preview img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .modalBtns{
      margin-top: 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .hint{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px dashed rgba(28,29,35,.18);
      background: rgba(255,255,255,.62);
      color: rgba(28,29,35,.74);
      font-size: 12px;
      line-height: 1.4;
      font-weight: 850;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app">
      <section class="panel">
        <div class="top">
          <div>
            <h1>우리집 육아기록</h1>
            <div class="sub">체온 / 투약 / 이유식(수유) 타임을 기록하고, 사진도 같은 줄에 썸네일로 붙습니다. 데이터는 이 기기(브라우저)에만 저장됩니다.</div>
          </div>
          <div class="badge" id="statusBadge">로컬 저장</div>
        </div>

        <div class="bar">
          <div class="leftbar">
            <div class="select" aria-label="아이 선택">
              <label for="kidSel">아이</label>
              <select id="kidSel"></select>
              <button class="btn" id="btnKids" type="button">아이관리</button>
            </div>
            <div class="search" aria-label="검색">
              <span style="font-weight:1000;color:rgba(28,29,35,.52)">검색</span>
              <input id="q" type="text" placeholder="예: 38.5 / 타이레놀 / 고구마 / 기침" />
            </div>
          </div>
          <div class="rightbar">
            <div class="chips" aria-label="필터">
              <div class="chip" data-type="all" data-on="1">전체</div>
              <div class="chip" data-type="temp" data-on="0">체온</div>
              <div class="chip" data-type="med" data-on="0">투약</div>
              <div class="chip" data-type="food" data-on="0">이유식/수유</div>
              <div class="chip" data-type="note" data-on="0">메모</div>
            </div>
            <button class="btn primary" id="btnAdd" type="button">기록 추가</button>
            <button class="btn" id="btnExport" type="button">내보내기</button>
            <button class="btn" id="btnImport" type="button">가져오기</button>
          </div>
        </div>

        <div class="list" id="list"></div>
      </section>

      <aside class="panel">
        <div class="top">
          <div>
            <h1>오늘 요약</h1>
            <div class="sub">오늘 기록을 빠르게 확인합니다. (선택된 아이 기준)</div>
          </div>
          <div class="badge" id="todayBadge">-</div>
        </div>
        <div class="right">
          <div class="cards">
            <div class="kcard">
              <div class="k">오늘 최고 체온</div>
              <div class="v" id="sMaxTemp">-</div>
              <div class="p" id="sMaxTempP">체온 기록이 없습니다.</div>
            </div>
            <div class="kcard">
              <div class="k">마지막 투약</div>
              <div class="v" id="sLastMed">-</div>
              <div class="p" id="sLastMedP">투약 기록이 없습니다.</div>
            </div>
            <div class="kcard">
              <div class="k">마지막 이유식/수유</div>
              <div class="v" id="sLastFood">-</div>
              <div class="p" id="sLastFoodP">이유식/수유 기록이 없습니다.</div>
            </div>
            <div class="kcard">
              <div class="k">오늘 총 기록</div>
              <div class="v" id="sCount">0</div>
              <div class="p" id="sCountP">필터/검색과 무관하게 오늘 전체를 계산합니다.</div>
            </div>
          </div>
          <div class="help">
            <b>빠른 사용법</b><br/>
            1) <code>기록 추가</code>에서 종류 선택<br/>
            2) 시간은 기본 <b>현재</b>, 필요하면 바꾸기<br/>
            3) 사진은 선택하면 자동으로 <b>썸네일</b>로 저장<br/><br/>
            <b>주의</b>: 브라우저 데이터 삭제/초기화하면 기록도 같이 사라질 수 있습니다. 중요하면 <code>내보내기</code>로 백업하세요.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <dialog id="entryDlg">
    <div class="modalTop">
      <div class="mh">
        <div class="h" id="dlgTitle">기록 추가</div>
        <div class="p">체온/투약/이유식(수유) 또는 간단 메모. 사진은 선택하면 같은 줄에 썸네일로 붙습니다.</div>
      </div>
      <button class="btn" id="dlgClose" type="button">닫기</button>
    </div>
    <div class="modalBody">
      <div class="form" id="form">
        <div class="f">
          <label for="fKid">아이</label>
          <select id="fKid"></select>
        </div>
        <div class="f">
          <label for="fType">종류</label>
          <select id="fType">
            <option value="temp">체온</option>
            <option value="med">투약</option>
            <option value="food">이유식/수유</option>
            <option value="note">메모</option>
          </select>
        </div>

        <div class="f">
          <label for="fWhen">시간</label>
          <input id="fWhen" type="datetime-local" />
        </div>
        <div class="f" id="typePrimary">
          <label id="fPrimaryLabel" for="fPrimary">값</label>
          <input id="fPrimary" type="text" placeholder="" />
        </div>

        <div class="f wide" id="typeSecondary" style="display:none">
          <label id="fSecondaryLabel" for="fSecondary">추가 정보</label>
          <input id="fSecondary" type="text" placeholder="" />
        </div>

        <div class="f wide">
          <label>사진(선택)</label>
          <div class="photoBox">
            <div class="preview" id="photoPreview" aria-label="사진 미리보기"></div>
            <div style="flex:1 1 auto">
              <input id="fPhoto" type="file" accept="image/*" />
              <div style="margin-top:6px;color:rgba(28,29,35,.62);font-size:12px;font-weight:900;line-height:1.35">
                사진은 자동으로 <b>작게 압축 저장</b>됩니다. 너무 많이 넣으면 저장공간이 찰 수 있어요.
              </div>
            </div>
          </div>
        </div>

        <div class="f wide">
          <label for="fNote">메모</label>
          <textarea id="fNote" placeholder="예: 밤에 열 올라서 해열제 투약. 물 많이 마심."></textarea>
        </div>
      </div>

      <div class="hint" id="typeHint"></div>

      <div class="modalBtns">
        <button class="btn" id="btnDelete" type="button" style="display:none">삭제</button>
        <button class="btn" id="btnSave" type="button">저장</button>
      </div>
    </div>
  </dialog>

  <dialog id="kidsDlg">
    <div class="modalTop">
      <div class="mh">
        <div class="h">아이 관리</div>
        <div class="p">아이 이름과 색을 관리합니다. 기록은 아이별로 분리됩니다.</div>
      </div>
      <button class="btn" id="kidsClose" type="button">닫기</button>
    </div>
    <div class="modalBody">
      <div class="form">
        <div class="f wide">
          <label>현재 아이 목록</label>
          <div id="kidsList" style="display:flex;flex-direction:column;gap:8px"></div>
        </div>
        <div class="f">
          <label for="kidName">새 아이 이름</label>
          <input id="kidName" type="text" placeholder="예: 첫째" />
        </div>
        <div class="f">
          <label for="kidColor">색</label>
          <select id="kidColor">
            <option value="--kid0">빨강</option>
            <option value="--kid1">파랑</option>
            <option value="--kid2">초록</option>
            <option value="--kid3">노랑</option>
          </select>
        </div>
      </div>
      <div class="modalBtns">
        <button class="btn primary" id="kidAdd" type="button">추가</button>
      </div>
    </div>
  </dialog>

  <input id="importFile" type="file" accept="application/json" style="display:none" />

  <script>
    (function(){
      "use strict";

      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const pad2 = (n) => String(n).padStart(2,"0");

      const LS_KEYS = {
        kids: "babycare.kids.v1",
        selectedKid: "babycare.selectedKid.v1",
        entries: "babycare.entries.v1"
      };

      function uuid(){
        if (crypto && crypto.randomUUID) return crypto.randomUUID();
        return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      }

      function ymd(d){
        return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
      }

      function hm(d){
        return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      }

      function fmtDayLabel(d){
        const w = ["일","월","화","수","목","금","토"][d.getDay()];
        return `${d.getFullYear()}.${pad2(d.getMonth()+1)}.${pad2(d.getDate())} (${w})`;
      }

      function toDatetimeLocalValue(ms){
        const d = new Date(ms);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      }

      function fromDatetimeLocalValue(v){
        const ms = Date.parse(v);
        return Number.isFinite(ms) ? ms : Date.now();
      }

      function safeJsonParse(s, fallback){
        try { return JSON.parse(s); } catch(_e) { return fallback; }
      }

      function saveLS(key, value){
        localStorage.setItem(key, JSON.stringify(value));
      }

      function loadLS(key, fallback){
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const v = safeJsonParse(raw, fallback);
        return v ?? fallback;
      }

      function isToday(ms){
        const d = new Date(ms);
        const t = new Date();
        return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate();
      }

      // IndexedDB for photos
      const PHOTO_DB = { name: "babycare.photos.v1", store: "photos" };
      let dbPromise = null;

      function openDb(){
        if (dbPromise) return dbPromise;
        dbPromise = new Promise((resolve) => {
          if (!("indexedDB" in window)) return resolve(null);
          const req = indexedDB.open(PHOTO_DB.name, 1);
          req.onupgradeneeded = () => {
            const db = req.result;
            if (!db.objectStoreNames.contains(PHOTO_DB.store)){
              db.createObjectStore(PHOTO_DB.store, { keyPath: "id" });
            }
          };
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => resolve(null);
        });
        return dbPromise;
      }

      async function putPhoto(blob){
        const db = await openDb();
        if (!db) return null;
        const id = uuid();
        await new Promise((resolve) => {
          const tx = db.transaction(PHOTO_DB.store, "readwrite");
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
          tx.objectStore(PHOTO_DB.store).put({ id, blob, ts: Date.now() });
        });
        return id;
      }

      async function getPhotoBlob(id){
        if (!id) return null;
        const db = await openDb();
        if (!db) return null;
        return await new Promise((resolve) => {
          const tx = db.transaction(PHOTO_DB.store, "readonly");
          const req = tx.objectStore(PHOTO_DB.store).get(id);
          req.onsuccess = () => resolve(req.result ? req.result.blob : null);
          req.onerror = () => resolve(null);
        });
      }

      async function delPhoto(id){
        if (!id) return;
        const db = await openDb();
        if (!db) return;
        await new Promise((resolve) => {
          const tx = db.transaction(PHOTO_DB.store, "readwrite");
          tx.oncomplete = () => resolve();
          tx.onerror = () => resolve();
          tx.objectStore(PHOTO_DB.store).delete(id);
        });
      }

      async function listAllPhotos(){
        const db = await openDb();
        if (!db) return [];
        return await new Promise((resolve) => {
          const out = [];
          const tx = db.transaction(PHOTO_DB.store, "readonly");
          const req = tx.objectStore(PHOTO_DB.store).openCursor();
          req.onsuccess = () => {
            const cur = req.result;
            if (!cur) return resolve(out);
            out.push(cur.value);
            cur.continue();
          };
          req.onerror = () => resolve(out);
        });
      }

      function blobToDataUrl(blob){
        return new Promise((resolve) => {
          const r = new FileReader();
          r.onload = () => resolve(String(r.result || ""));
          r.onerror = () => resolve("");
          r.readAsDataURL(blob);
        });
      }

      function dataUrlToBlob(dataUrl){
        try{
          const parts = dataUrl.split(",");
          const meta = parts[0] || "";
          const b64 = parts[1] || "";
          const m = /data:(.*?);base64/.exec(meta);
          const mime = m ? m[1] : "application/octet-stream";
          const bin = atob(b64);
          const bytes = new Uint8Array(bin.length);
          for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
          return new Blob([bytes], { type: mime });
        }catch(_e){
          return null;
        }
      }

      async function downscaleImageToJpeg(file, size){
        const bmp = await createImageBitmap(file);
        const s = Math.max(1, size|0);
        const canvas = document.createElement("canvas");
        canvas.width = s;
        canvas.height = s;
        const ctx = canvas.getContext("2d", { alpha: false });
        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0,s,s);

        const scale = Math.max(s / bmp.width, s / bmp.height);
        const w = Math.round(bmp.width * scale);
        const h = Math.round(bmp.height * scale);
        const x = Math.round((s - w)/2);
        const y = Math.round((s - h)/2);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = "high";
        ctx.drawImage(bmp, x, y, w, h);
        bmp.close();

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", 0.82));
        return blob;
      }

      function iconFor(type){
        if (type === "temp") return { cls: "temp", t: "T" };
        if (type === "med") return { cls: "med", t: "Rx" };
        if (type === "food") return { cls: "food", t: "F" };
        return { cls: "note", t: "N" };
      }

      function typeName(type){
        if (type === "temp") return "체온";
        if (type === "med") return "투약";
        if (type === "food") return "이유식/수유";
        return "메모";
      }

      // state
      let kids = loadLS(LS_KEYS.kids, null);
      if (!Array.isArray(kids) || kids.length === 0){
        kids = [
          { id: uuid(), name: "우리 아이", colorVar: "--kid0" }
        ];
        saveLS(LS_KEYS.kids, kids);
      }

      let selectedKid = localStorage.getItem(LS_KEYS.selectedKid) || kids[0].id;
      if (!kids.some(k => k.id === selectedKid)) selectedKid = kids[0].id;
      localStorage.setItem(LS_KEYS.selectedKid, selectedKid);

      let entries = loadLS(LS_KEYS.entries, []);
      if (!Array.isArray(entries)) entries = [];

      // UI refs
      const listEl = $("#list");
      const statusBadge = $("#statusBadge");
      const todayBadge = $("#todayBadge");
      const kidSel = $("#kidSel");
      const qEl = $("#q");
      const chips = $$(".chip");

      const entryDlg = $("#entryDlg");
      const dlgTitle = $("#dlgTitle");
      const dlgClose = $("#dlgClose");
      const fKid = $("#fKid");
      const fType = $("#fType");
      const fWhen = $("#fWhen");
      const fPrimary = $("#fPrimary");
      const fPrimaryLabel = $("#fPrimaryLabel");
      const fSecondary = $("#fSecondary");
      const fSecondaryLabel = $("#fSecondaryLabel");
      const typeSecondary = $("#typeSecondary");
      const fNote = $("#fNote");
      const fPhoto = $("#fPhoto");
      const photoPreview = $("#photoPreview");
      const typeHint = $("#typeHint");
      const btnSave = $("#btnSave");
      const btnDelete = $("#btnDelete");

      const kidsDlg = $("#kidsDlg");
      const kidsClose = $("#kidsClose");
      const kidsList = $("#kidsList");
      const kidName = $("#kidName");
      const kidColor = $("#kidColor");
      const kidAdd = $("#kidAdd");

      const btnAdd = $("#btnAdd");
      const btnExport = $("#btnExport");
      const btnImport = $("#btnImport");
      const importFile = $("#importFile");
      const btnKids = $("#btnKids");

      const sMaxTemp = $("#sMaxTemp");
      const sMaxTempP = $("#sMaxTempP");
      const sLastMed = $("#sLastMed");
      const sLastMedP = $("#sLastMedP");
      const sLastFood = $("#sLastFood");
      const sLastFoodP = $("#sLastFoodP");
      const sCount = $("#sCount");

      // modal state
      let editingId = null;
      let pendingPhotoBlob = null;
      let pendingKeepPhotoId = null;

      // thumbnail URL cache
      const photoUrlCache = new Map(); // id -> objectURL

      function kidColorVar(kidId){
        const k = kids.find(x => x.id === kidId);
        return k ? k.colorVar : "--kid0";
      }

      function buildKidOptions(sel){
        sel.innerHTML = "";
        for (const k of kids){
          const opt = document.createElement("option");
          opt.value = k.id;
          opt.textContent = k.name;
          sel.appendChild(opt);
        }
      }

      function refreshKidsUI(){
        buildKidOptions(kidSel);
        buildKidOptions(fKid);
        kidSel.value = selectedKid;
        fKid.value = selectedKid;

        kidsList.innerHTML = "";
        for (const k of kids){
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.alignItems = "center";
          row.style.justifyContent = "space-between";
          row.style.gap = "10px";
          row.style.border = "1px solid rgba(28,29,35,.12)";
          row.style.background = "rgba(255,255,255,.72)";
          row.style.borderRadius = "16px";
          row.style.padding = "10px 12px";

          const left = document.createElement("div");
          left.style.display = "flex";
          left.style.alignItems = "center";
          left.style.gap = "10px";
          const dot = document.createElement("div");
          dot.style.width = "12px";
          dot.style.height = "12px";
          dot.style.borderRadius = "999px";
          dot.style.border = "1px solid rgba(28,29,35,.12)";
          dot.style.background = `var(${k.colorVar})`;
          const name = document.createElement("div");
          name.textContent = k.name;
          name.style.fontWeight = "1000";
          left.appendChild(dot);
          left.appendChild(name);

          const right = document.createElement("div");
          right.style.display = "flex";
          right.style.gap = "8px";

          const selBtn = document.createElement("button");
          selBtn.className = "tiny";
          selBtn.type = "button";
          selBtn.textContent = (k.id === selectedKid) ? "\uc120\ud0dd\ub428" : "\uc120\ud0dd";
          selBtn.disabled = (k.id === selectedKid);
          selBtn.addEventListener("click", () => {
            selectedKid = k.id;
            localStorage.setItem(LS_KEYS.selectedKid, selectedKid);
            refreshKidsUI();
            render();
            kidsDlg.close();
          });

          const delBtn = document.createElement("button");
          delBtn.className = "tiny";
          delBtn.type = "button";
          delBtn.textContent = "\uc0ad\uc81c";
          delBtn.disabled = kids.length <= 1;
          delBtn.addEventListener("click", () => {
            if (kids.length <= 1) return;
            if (!confirm(`'${k.name}' \uc544\uc774\ub97c \uc0ad\uc81c\ud560\uae4c\uc694?\n(\uae30\ub85d\uc740 \ub0a8\uc544\uc788\uc9c0\ub9cc \ub354 \uc774\uc0c1 \uc120\ud0dd\ud560 \uc218 \uc5c6\uac8c \ub429\ub2c8\ub2e4)`)) return;
            kids = kids.filter(x => x.id !== k.id);
            saveLS(LS_KEYS.kids, kids);
            if (!kids.some(x => x.id === selectedKid)) {
              selectedKid = kids[0].id;
              localStorage.setItem(LS_KEYS.selectedKid, selectedKid);
            }
            refreshKidsUI();
            render();
          });

          right.appendChild(selBtn);
          right.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(right);
          kidsList.appendChild(row);
        }
      }

      // (app logic continues)
      function getActiveFilter(){
        const on = chips.filter(c => c.dataset.on === "1").map(c => c.dataset.type);
        if (on.includes("all")) return "all";
        return on.length ? on : "all";
      }

      function entryMatchesFilter(e, filter){
        if (filter === "all") return true;
        return e.type === filter || (Array.isArray(filter) && filter.includes(e.type));
      }

      function entryMatchesQuery(e, q){
        if (!q) return true;
        const s = [e.type, e.primary||"", e.secondary||"", e.note||""].join(" ").toLowerCase();
        return s.includes(q.toLowerCase());
      }

      function summarizeEntry(e){
        if (e.type === "temp"){
          const v = (e.primary || "").trim();
          return (v ? `${v}\u00b0C` : "\uccb4\uc628") + (e.secondary ? ` \u00b7 ${e.secondary}` : "");
        }
        if (e.type === "med"){
          const a = (e.primary || "").trim() || "\ud22c\uc57d";
          const b = (e.secondary || "").trim();
          return b ? `${a} \u00b7 ${b}` : a;
        }
        if (e.type === "food"){
          const a = (e.primary || "").trim() || "\uc774\uc720\uc2dd/\uc218\uc720";
          const b = (e.secondary || "").trim();
          return b ? `${a} \u00b7 ${b}` : a;
        }
        return (e.primary || "").trim() || "\uba54\ubaa8";
      }

      function kidNameById(id){
        const k = kids.find(x => x.id === id);
        return k ? k.name : "\uc544\uc774";
      }

      async function photoUrl(id){
        if (!id) return "";
        if (photoUrlCache.has(id)) return photoUrlCache.get(id);
        const blob = await getPhotoBlob(id);
        if (!blob) return "";
        const url = URL.createObjectURL(blob);
        photoUrlCache.set(id, url);
        return url;
      }

      function revokePhotoUrl(id){
        const url = photoUrlCache.get(id);
        if (url) URL.revokeObjectURL(url);
        photoUrlCache.delete(id);
      }

      function groupByDay(items){
        const map = new Map();
        for (const e of items){
          const key = ymd(new Date(e.ts));
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(e);
        }
        const days = Array.from(map.keys()).sort((a,b) => b.localeCompare(a));
        return days.map(d => ({ day: d, items: map.get(d).sort((a,b) => b.ts - a.ts) }));
      }

      function calcTodayStats(all){
        const kidItems = all.filter(e => e.kidId === selectedKid && isToday(e.ts));
        const tempItems = kidItems.filter(e => e.type === "temp");
        const medItems = kidItems.filter(e => e.type === "med");
        const foodItems = kidItems.filter(e => e.type === "food");

        const temps = tempItems.map(e => Number(String(e.primary||"").replace(/[^\d.]/g,"")))
          .filter(v => Number.isFinite(v) && v > 30 && v < 45);
        const maxTemp = temps.length ? Math.max(...temps) : 0;
        const lastMed = medItems.sort((a,b)=>b.ts-a.ts)[0] || null;
        const lastFood = foodItems.sort((a,b)=>b.ts-a.ts)[0] || null;

        todayBadge.textContent = fmtDayLabel(new Date());
        sCount.textContent = String(kidItems.length);

        if (maxTemp){
          sMaxTemp.textContent = maxTemp.toFixed(1) + "\u00b0C";
          sMaxTempP.textContent = `\uc624\ub298 \uccb4\uc628 \uae30\ub85d ${tempItems.length}\uac74 \uc911 \ucd5c\uace0\uac12`;
        } else {
          sMaxTemp.textContent = "-";
          sMaxTempP.textContent = "\uccb4\uc628 \uae30\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.";
        }
        if (lastMed){
          sLastMed.textContent = hm(new Date(lastMed.ts));
          sLastMedP.textContent = summarizeEntry(lastMed);
        } else {
          sLastMed.textContent = "-";
          sLastMedP.textContent = "\ud22c\uc57d \uae30\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.";
        }
        if (lastFood){
          sLastFood.textContent = hm(new Date(lastFood.ts));
          sLastFoodP.textContent = summarizeEntry(lastFood);
        } else {
          sLastFood.textContent = "-";
          sLastFoodP.textContent = "\uc774\uc720\uc2dd/\uc218\uc720 \uae30\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.";
        }
      }

      async function render(){
        statusBadge.textContent = `\uc544\uc774: ${kidNameById(selectedKid)} \u00b7 \ub85c\uceec \uc800\uc7a5`;
        const q = (qEl.value || "").trim();
        const filter = getActiveFilter();

        const filtered = entries
          .filter(e => e.kidId === selectedKid)
          .filter(e => entryMatchesFilter(e, filter))
          .filter(e => entryMatchesQuery(e, q))
          .sort((a,b) => b.ts - a.ts);

        calcTodayStats(entries);

        if (filtered.length === 0){
          listEl.innerHTML = `<div class="empty">\uae30\ub85d\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.<br/>\uc624\ub978\ucabd \uc704 <b>\uae30\ub85d \ucd94\uac00</b>\ub85c \uc2dc\uc791\ud558\uc138\uc694.</div>`;
          return;
        }

        const groups = groupByDay(filtered);
        listEl.innerHTML = "";

        for (const g of groups){
          const dayBox = document.createElement("div");
          dayBox.className = "day";
          const d = new Date(g.day + "T00:00:00");
          const head = document.createElement("div");
          head.className = "dayHead";
          const left = document.createElement("div");
          left.className = "d";
          left.textContent = fmtDayLabel(d);
          const right = document.createElement("div");
          right.className = "c";
          right.textContent = `${g.items.length}\uac74`;
          head.appendChild(left);
          head.appendChild(right);
          dayBox.appendChild(head);

          for (const e of g.items){
            const row = document.createElement("div");
            row.className = "row";

            const ic = document.createElement("div");
            const ico = iconFor(e.type);
            ic.className = `icon ${ico.cls}`;
            ic.textContent = ico.t;

            const meta = document.createElement("div");
            meta.className = "meta";
            const t = document.createElement("div");
            t.className = "t";
            const time = document.createElement("span");
            time.className = "time";
            time.textContent = hm(new Date(e.ts));
            const title = document.createElement("span");
            title.textContent = `${typeName(e.type)} \u00b7 ${summarizeEntry(e)}`;
            t.appendChild(title);
            t.appendChild(time);
            const s = document.createElement("div");
            s.className = "s";
            s.textContent = (e.note || "").trim() ? e.note : "";
            meta.appendChild(t);
            meta.appendChild(s);

            const trail = document.createElement("div");
            trail.className = "trail";

            const dot = document.createElement("div");
            dot.className = "kidDot";
            dot.title = kidNameById(e.kidId);
            dot.style.background = `var(${kidColorVar(e.kidId)})`;
            trail.appendChild(dot);

            if (e.photoId){
              const th = document.createElement("div");
              th.className = "thumb";
              const img = document.createElement("img");
              img.alt = "\uc0ac\uc9c4";
              th.appendChild(img);
              trail.appendChild(th);
              photoUrl(e.photoId).then((u) => { if (u) img.src = u; });
            }

            const btns = document.createElement("div");
            btns.className = "rowBtns";
            const edit = document.createElement("button");
            edit.className = "tiny";
            edit.type = "button";
            edit.textContent = "\uc5f4\uae30";
            edit.addEventListener("click", () => openEdit(e.id));
            btns.appendChild(edit);
            trail.appendChild(btns);

            row.appendChild(ic);
            row.appendChild(meta);
            row.appendChild(trail);
            dayBox.appendChild(row);
          }
          listEl.appendChild(dayBox);
        }
      }

      function setTypeUi(type){
        typeSecondary.style.display = "none";
        fSecondary.value = "";
        fPrimary.value = "";

        if (type === "temp"){
          fPrimaryLabel.textContent = "\uccb4\uc628(\u00b0C)";
          fPrimary.type = "number";
          fPrimary.step = "0.1";
          fPrimary.placeholder = "\uc608: 38.5";
          fSecondaryLabel.textContent = "\uce21\uc815 \ubd80\uc704/\uc0c1\ud0dc(\uc120\ud0dd)";
          fSecondary.placeholder = "\uc608: \uaca8\ub4dc\ub791\uc774 / \uadc0 / \uc218\uba74\uc911";
          typeSecondary.style.display = "block";
          typeHint.innerHTML = "<b>\uccb4\uc628</b>: \uc22b\uc790\ub9cc \ub123\uc5b4\ub3c4 \ub429\ub2c8\ub2e4. \uc608) 38.5";
        } else if (type === "med"){
          fPrimaryLabel.textContent = "\uc57d \uc774\ub984";
          fPrimary.type = "text";
          fPrimary.placeholder = "\uc608: \ud0c0\uc774\ub808\ub180";
          fSecondaryLabel.textContent = "\uc6a9\ub7c9/\ubc29\ubc95(\uc120\ud0dd)";
          fSecondary.placeholder = "\uc608: 5ml / 1\ud68c / \uacbd\uad6c";
          typeSecondary.style.display = "block";
          typeHint.innerHTML = "<b>\ud22c\uc57d</b>: \uc57d \uc774\ub984 + \uc6a9\ub7c9\uc744 \uc801\uc5b4\ub450\uba74 \ub098\uc911\uc5d0 \ud655\uc778\uc774 \ud3b8\ud569\ub2c8\ub2e4.";
        } else if (type === "food"){
          fPrimaryLabel.textContent = "\ubb34\uc5c7\uc744 \uba39\uc5c8\ub098";
          fPrimary.type = "text";
          fPrimary.placeholder = "\uc608: \uace0\uad6c\ub9c8 \uc774\uc720\uc2dd / \ubd84\uc720";
          fSecondaryLabel.textContent = "\uc591(\uc120\ud0dd)";
          fSecondary.placeholder = "\uc608: 120ml / 80g";
          typeSecondary.style.display = "block";
          typeHint.innerHTML = "<b>\uc774\uc720\uc2dd/\uc218\uc720</b>: \uba54\ub274 + \uc591\uc744 \uc801\uc5b4\ub450\uba74 \ud328\ud134 \uc7a1\uae30 \uc88b\uc2b5\ub2c8\ub2e4.";
        } else {
          fPrimaryLabel.textContent = "\uc81c\ubaa9(\uc120\ud0dd)";
          fPrimary.type = "text";
          fPrimary.placeholder = "\uc608: \ucee8\ub514\uc158";
          typeHint.innerHTML = "<b>\uba54\ubaa8</b>: \uae30\uce68, \uc218\uba74, \ubc30\ubcc0 \ub4f1 \uc790\uc720\ub86d\uac8c \uae30\ub85d\ud558\uc138\uc694.";
        }
      }

      function clearPhotoPreview(){
        photoPreview.innerHTML = "";
      }

      function setPhotoPreviewUrl(url){
        photoPreview.innerHTML = "";
        if (!url) return;
        const img = document.createElement("img");
        img.alt = "\ubbf8\ub9ac\ubcf4\uae30";
        img.src = url;
        photoPreview.appendChild(img);
      }

      async function openAdd(){
        editingId = null;
        pendingPhotoBlob = null;
        pendingKeepPhotoId = null;
        btnDelete.style.display = "none";
        dlgTitle.textContent = "\uae30\ub85d \ucd94\uac00";

        fKid.value = selectedKid;
        fType.value = "temp";
        fWhen.value = toDatetimeLocalValue(Date.now());
        fNote.value = "";
        fPhoto.value = "";
        clearPhotoPreview();
        setTypeUi("temp");
        entryDlg.showModal();
        fPrimary.focus();
      }

      async function openEdit(id){
        const e = entries.find(x => x.id === id);
        if (!e) return;
        editingId = id;
        pendingPhotoBlob = null;
        pendingKeepPhotoId = e.photoId || null;
        btnDelete.style.display = "inline-block";
        dlgTitle.textContent = "\uae30\ub85d \ubcf4\uae30/\uc218\uc815";

        fKid.value = e.kidId;
        fType.value = e.type;
        setTypeUi(e.type);
        fWhen.value = toDatetimeLocalValue(e.ts);
        fPrimary.value = e.primary || "";
        fSecondary.value = e.secondary || "";
        fNote.value = e.note || "";
        fPhoto.value = "";
        clearPhotoPreview();
        if (e.photoId){
          const u = await photoUrl(e.photoId);
          if (u) setPhotoPreviewUrl(u);
        }
        entryDlg.showModal();
      }

      async function saveEntry(){
        const kidId = fKid.value;
        const type = fType.value;
        const ts = fromDatetimeLocalValue(fWhen.value || toDatetimeLocalValue(Date.now()));
        const primary = (fPrimary.value || "").trim();
        const secondary = (fSecondary.value || "").trim();
        const note = (fNote.value || "").trim();

        if (type === "temp"){
          const v = Number(String(primary).replace(/[^\d.]/g,""));
          if (!primary || !Number.isFinite(v) || v < 30 || v > 45){
            alert("\uccb4\uc628\uc740 30~45 \ubc94\uc704\uc758 \uc22b\uc790\ub85c \uc785\ub825\ud574 \uc8fc\uc138\uc694. \uc608) 38.5");
            return;
          }
        }
        if (type === "med" && !primary){
          alert("\ud22c\uc57d\uc740 \uc57d \uc774\ub984\uc744 \uc785\ub825\ud574 \uc8fc\uc138\uc694.");
          return;
        }
        if (type === "food" && !primary){
          alert("\uc774\uc720\uc2dd/\uc218\uc720\ub294 \uba54\ub274(\ub610\ub294 \ubd84\uc720/\ubaa8\uc720 \ub4f1)\ub97c \uc785\ub825\ud574 \uc8fc\uc138\uc694.");
          return;
        }

        let photoId = pendingKeepPhotoId || null;
        if (pendingPhotoBlob){
          if (photoId) {
            await delPhoto(photoId);
            revokePhotoUrl(photoId);
          }
          photoId = await putPhoto(pendingPhotoBlob);
        }

        if (editingId){
          const idx = entries.findIndex(x => x.id === editingId);
          if (idx >= 0){
            entries[idx] = { ...entries[idx], kidId, type, ts, primary, secondary, note, photoId };
          }
        } else {
          entries.push({ id: uuid(), kidId, type, ts, primary, secondary, note, photoId });
        }

        saveLS(LS_KEYS.entries, entries);
        entryDlg.close();
        await render();
      }

      async function deleteEntry(){
        if (!editingId) return;
        const e = entries.find(x => x.id === editingId);
        if (!e) return;
        if (!confirm("\uc774 \uae30\ub85d\uc744 \uc0ad\uc81c\ud560\uae4c\uc694?")) return;
        entries = entries.filter(x => x.id !== editingId);
        saveLS(LS_KEYS.entries, entries);
        if (e.photoId){
          await delPhoto(e.photoId);
          revokePhotoUrl(e.photoId);
        }
        entryDlg.close();
        await render();
      }

      async function handlePhotoInput(){
        const f = fPhoto.files && fPhoto.files[0];
        if (!f) return;
        if (!f.type.startsWith("image/")){
          alert("\uc774\ubbf8\uc9c0 \ud30c\uc77c\ub9cc \uc120\ud0dd\ud574 \uc8fc\uc138\uc694.");
          fPhoto.value = "";
          return;
        }
        try{
          const blob = await downscaleImageToJpeg(f, 320);
          if (!blob){
            alert("\uc0ac\uc9c4 \ucc98\ub9ac\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.");
            return;
          }
          pendingPhotoBlob = blob;
          const url = URL.createObjectURL(blob);
          setPhotoPreviewUrl(url);
          setTimeout(() => URL.revokeObjectURL(url), 2500);
        }catch(_e){
          alert("\uc0ac\uc9c4 \ucc98\ub9ac\uc5d0 \uc2e4\ud328\ud588\uc2b5\ub2c8\ub2e4.");
        }
      }

      function toggleChip(type){
        const chip = chips.find(c => c.dataset.type === type);
        if (!chip) return;
        if (type === "all"){
          chips.forEach(c => c.dataset.on = (c.dataset.type === "all") ? "1" : "0");
          return;
        }
        const allChip = chips.find(c => c.dataset.type === "all");
        if (allChip) allChip.dataset.on = "0";
        chip.dataset.on = (chip.dataset.on === "1") ? "0" : "1";
        const any = chips.some(c => c.dataset.type !== "all" && c.dataset.on === "1");
        if (!any && allChip){
          allChip.dataset.on = "1";
        }
      }

      async function exportData(withPhotos){
        const payload = { schema: "babycare.export.v1", exportedAt: new Date().toISOString(), kids, selectedKid, entries };
        if (withPhotos){
          const photos = await listAllPhotos();
          const out = [];
          for (const p of photos){
            const dataUrl = await blobToDataUrl(p.blob);
            if (dataUrl) out.push({ id: p.id, dataUrl, ts: p.ts || 0 });
          }
          payload.photos = out;
        }

        const json = JSON.stringify(payload, null, 2);
        const blob = new Blob([json], { type: "application/json" });
        const a = document.createElement("a");
        const stamp = ymd(new Date()).replaceAll("-","");
        a.download = withPhotos ? `babycare_export_${stamp}_with_photos.json` : `babycare_export_${stamp}.json`;
        a.href = URL.createObjectURL(blob);
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 1000);
      }

      async function importData(file){
        const text = await file.text();
        const payload = safeJsonParse(text, null);
        if (!payload || payload.schema !== "babycare.export.v1"){
          alert("\uac00\uc838\uc624\uae30 \uc2e4\ud328: \uc9c0\uc6d0\ud558\uc9c0 \uc54a\ub294 \ud30c\uc77c \ud615\uc2dd\uc785\ub2c8\ub2e4.");
          return;
        }
        if (!confirm("\uac00\uc838\uc624\uae30\ub97c \uc2e4\ud589\ud560\uae4c\uc694?\n\ud604\uc7ac \uae30\uae30 \uae30\ub85d\uc740 \uc720\uc9c0\ub418\uace0, \uac00\uc838\uc628 \uae30\ub85d\uc774 \ud569\uccd0\uc9d1\ub2c8\ub2e4.")) return;

        const incomingKids = Array.isArray(payload.kids) ? payload.kids : [];
        const kidIdMap = new Map();
        for (const k of incomingKids){
          if (!k || !k.id || !k.name) continue;
          const same = kids.find(x => x.name === k.name && x.colorVar === (k.colorVar || "--kid0"));
          if (same) kidIdMap.set(k.id, same.id);
          else {
            const nk = { id: uuid(), name: String(k.name), colorVar: k.colorVar || "--kid0" };
            kids.push(nk);
            kidIdMap.set(k.id, nk.id);
          }
        }
        saveLS(LS_KEYS.kids, kids);

        const photoIdMap = new Map();
        if (Array.isArray(payload.photos) && payload.photos.length){
          for (const p of payload.photos){
            if (!p || !p.id || !p.dataUrl) continue;
            const b = dataUrlToBlob(String(p.dataUrl));
            if (!b) continue;
            const newId = await putPhoto(b);
            if (newId) photoIdMap.set(p.id, newId);
          }
        }

        const incomingEntries = Array.isArray(payload.entries) ? payload.entries : [];
        const sig = (e) => [e.kidId, e.type, e.ts, e.primary||"", e.secondary||"", e.note||""].join("|");
        const seen = new Set(entries.map(sig));

        for (const e of incomingEntries){
          if (!e || !e.type || !e.ts) continue;
          const ne = {
            id: uuid(),
            kidId: kidIdMap.get(e.kidId) || selectedKid,
            type: e.type,
            ts: Number(e.ts) || Date.now(),
            primary: e.primary || "",
            secondary: e.secondary || "",
            note: e.note || "",
            photoId: e.photoId ? (photoIdMap.get(e.photoId) || null) : null
          };
          const s = sig(ne);
          if (seen.has(s)) continue;
          seen.add(s);
          entries.push(ne);
        }

        saveLS(LS_KEYS.entries, entries);
        refreshKidsUI();
        await render();
        alert("\uac00\uc838\uc624\uae30 \uc644\ub8cc");
      }

      // events
      btnAdd.addEventListener("click", openAdd);
      dlgClose.addEventListener("click", () => entryDlg.close());
      btnSave.addEventListener("click", saveEntry);
      btnDelete.addEventListener("click", deleteEntry);
      fType.addEventListener("change", () => setTypeUi(fType.value));
      fPhoto.addEventListener("change", handlePhotoInput);

      btnKids.addEventListener("click", () => { kidName.value = ""; kidsDlg.showModal(); });
      kidsClose.addEventListener("click", () => kidsDlg.close());

      kidAdd.addEventListener("click", () => {
        const name = (kidName.value || "").trim();
        if (!name){ alert("\uc544\uc774 \uc774\ub984\uc744 \uc785\ub825\ud574 \uc8fc\uc138\uc694."); return; }
        const cv = kidColor.value || "--kid0";
        kids.push({ id: uuid(), name, colorVar: cv });
        saveLS(LS_KEYS.kids, kids);
        kidName.value = "";
        refreshKidsUI();
        render();
      });

      kidSel.addEventListener("change", () => {
        selectedKid = kidSel.value;
        localStorage.setItem(LS_KEYS.selectedKid, selectedKid);
        render();
      });

      qEl.addEventListener("input", () => {
        clearTimeout(qEl._t);
        qEl._t = setTimeout(render, 120);
      });

      chips.forEach(c => c.addEventListener("click", () => { toggleChip(c.dataset.type); render(); }));

      btnExport.addEventListener("click", async () => {
        const withPhotos = confirm("\ub0b4\ubcf4\ub0b4\uae30: \uc0ac\uc9c4\uae4c\uc9c0 \ud3ec\ud568\ud560\uae4c\uc694?\n- \ud655\uc778: \uc0ac\uc9c4 \ud3ec\ud568(\ud30c\uc77c\uc774 \ucee4\uc9c8 \uc218 \uc788\uc74c)\n- \ucde8\uc18c: \uae30\ub85d\ub9cc");
        await exportData(withPhotos);
      });

      btnImport.addEventListener("click", () => importFile.click());
      importFile.addEventListener("change", async () => {
        const f = importFile.files && importFile.files[0];
        importFile.value = "";
        if (!f) return;
        await importData(f);
      });

      // init
      refreshKidsUI();
      render();
      openDb().then(() => {}).catch(() => {});
    })();

  </script>
</body>
</html>
