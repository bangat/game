<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>게임 대기실</title>
    <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff" as="font" type="font/woff" crossorigin>
    <style>
        @font-face {
            font-family: 'GmarketSans';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff') format('woff');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'GmarketSans';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansBold.woff') format('woff');
            font-weight: 700;
            font-style: normal;
        }

        :root {
            --bg-color: #F3F7FD; --primary-color: #4A8DFF; --accent-color: #FFC84A;
            --text-color-dark: #333D4B; --text-color-light: #ffffff;
            --danger-color: #F76363; --success-color: #30D394;
            --panel-bg: #ffffff; --panel-border: #E5E8EB;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%; height: 100%; overflow: hidden; font-family: 'GmarketSans', sans-serif;
            background-color: var(--bg-color); display: flex; flex-direction: column;
            justify-content: center; align-items: center; -webkit-user-select: none; user-select: none; touch-action: manipulation;
        }
        .view { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .hidden { display: none !important; }

        .menu-btn {
            width: 100%; max-width: 320px; padding: 15px; font-size: 1.2em; font-weight: 700; letter-spacing: 1px;
            font-family: 'GmarketSans', sans-serif; border-radius: 12px; border: none; cursor: pointer;
            margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.15s ease-out;
        }
        .menu-btn:active { transform: scale(0.97); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .menu-btn.primary { background-color: var(--primary-color); color: var(--text-color-light); }
        .menu-btn.secondary { background-color: #E9EEF2; color: var(--text-color-dark); }
        .menu-btn:disabled { background-color: #ccc !important; color: #888 !important; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .spinner { margin: 20px auto; border: 4px solid rgba(0, 0, 0, 0.1); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #lobby-view { padding: 15px; align-items: center; }
        .lobby-panel { display: flex; flex-direction: column; width: 100%; max-width: 500px; height: calc(100% - 80px); background: var(--panel-bg); border-radius: 16px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--panel-border); }
        .lobby-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
        .lobby-header h1 { font-size: 1.8em; font-weight: 700; color: var(--text-color-dark); }
        #room-list-container { width: 100%; flex-grow: 1; overflow-y: auto; }
        
        .room-item {
            display: flex; flex-direction: column; background-color: #fff; border: 1px solid var(--panel-border);
            border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .room-main-info { padding: 15px; }
        .room-item .room-name { font-size: 1.3em; font-weight: 700; margin-bottom: 15px; }
        .room-detail-line { display: flex; align-items: center; font-size: 0.95em; margin-top: 8px; padding: 5px 0; }
        .room-detail-line .detail-label { color: #888; font-weight: 500; width: 50px; }
        .room-detail-line .detail-value { font-weight: 700; color: var(--text-color-dark); }
        .status-players { justify-content: space-between; }
        .status-wrapper, .players-wrapper { display: flex; align-items: center; }
        .room-status.waiting { color: var(--success-color); }
        .room-status.playing { color: var(--danger-color); }
        .room-item .join-btn.primary { width: 100%; border-radius: 0; margin: 0; padding: 15px; font-size: 1.1em; border-top: none; }
        .room-item .join-btn:disabled { background-color: #f0f0f0 !important; color: #aaa !important; border-top: 1px solid #e0e0e0; }
        
        #lobby-bottom-actions { width: 100%; max-width: 500px; margin-top: 15px; display: flex; gap: 10px; }
        #lobby-bottom-actions .menu-btn { width: 50%; margin-bottom: 0; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; z-index: 200; text-align: center; background-color: rgba(0,0,0,0.6); }
        .modal-content { background: var(--panel-bg); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 400px; overflow: hidden; }
        .modal-header { background-color: var(--primary-color); padding: 15px; }
        .modal-header h2 { color: var(--text-color-light); font-size: 1.8em; font-weight: 700; letter-spacing: 2px; }
        .modal-body { padding: 25px; }
        
        #player-list { margin-top: 20px; font-size: 1.1em; width: 100%; max-width: 320px; }
        .player-item { background-color: #F3F7FD; color: var(--text-color-dark); padding: 12px; border-radius: 8px; margin-bottom: 8px; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
        .player-avatar-img {
            width: 28px;
            height: 28px;
            object-fit: contain;
            vertical-align: middle;
        }
        .player-avatar-emoji {
            font-size: 1.5em;
            line-height: 1;
        }

        #profile-avatar {
            word-break: break-all;
        }

        #profile-avatar-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }

        .player-item:hover { background-color: #e9eff8; }
        .player-item.is-host::after { content: ' (방장)'; color: var(--primary-color); font-weight: 700; }
        
        .lobby-modal-footer { display: flex; gap: 10px; padding: 15px; border-top: 1px solid var(--panel-border); }
        .lobby-modal-footer .menu-btn {
            margin-bottom: 0;
            flex: 1;
            min-width: 0;
            padding: 12px 10px;
            font-size: 1.05em;
            font-weight: 700;
            max-width: none; /* 최대 너비 제한 해제 */
        }
        #waiting-overlay .modal-body { display: flex; flex-direction: column; }
        #waiting-overlay #player-list { flex-grow: 1; overflow-y: auto; margin-top: 20px; }
        
        #game-select-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 25px; }
        .game-select-btn { aspect-ratio: 1 / 1; font-size: 1.2em; font-weight: 700; border-radius: 12px; border: 3px solid transparent; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .game-select-btn:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        .game-select-btn .icon { font-size: 2em; }

        #selected-game-display { background-color: #e9eff8; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-weight: 700; text-align: center; color: var(--text-color-dark); width: 100%; max-width: 320px; margin-left: auto; margin-right: auto; }
        #selected-game-display .placeholder { color: #777; }

        /* --- ★★★ 수정된 부분 시작 ★★★ --- */
        /* 대기실 오버레이의 여백 제거 및 정렬 방식 변경 */
        #waiting-overlay {
            padding: 0;
            justify-content: flex-start;
            align-items: flex-start;
        }

        /* 대기실 모달을 화면에 꽉 채우도록 설정 */
        .modal-content.in-game-lobby {
            width: 100%;
            height: 100%;
            max-width: none;
            max-height: none;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            transition: max-width 0.3s ease;
        }
        /* --- ★★★ 수정된 부분 종료 ★★★ --- */

        .in-game-lobby .modal-header h2 { margin-bottom: 2px; }
        .in-game-lobby .modal-header .game-subtitle { font-size: 0.7em; color: rgba(255,255,255,0.8); font-weight: 500; }
        .in-game-lobby .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* 남는 공간 모두 차지 */
            min-height: 0; /* flex 자식 요소의 높이 축소를 위함 */
        }
        
        /* 플레이어 목록 (모바일: 가로 스크롤) */
        #player-list-wrapper { padding: 15px; border-bottom: 1px solid var(--panel-border); background-color: #f8f9fa; }
        #player-list-horizontal { display: flex; overflow-x: auto; gap: 15px; -ms-overflow-style: none; scrollbar-width: none; }
        #player-list-horizontal::-webkit-scrollbar { display: none; }
        .player-slot-compact { flex-shrink: 0; width: 65px; text-align: center; cursor: pointer; }
        .player-slot-compact .avatar { width: 50px; height: 50px; margin: 0 auto 5px; background-color: #e9ecef; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8em; position: relative; }
        .player-slot-compact .avatar img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        .player-slot-compact.is-host .avatar::after { content: '👑'; position: absolute; bottom: -5px; right: -5px; font-size: 0.8em; background: var(--accent-color); padding: 2px; border-radius: 50%; }
        .player-slot-compact .nickname { font-size: 0.8em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 채팅 UI */
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; padding: 10px; overflow-y: auto; }
        .chat-message { display: flex; margin-bottom: 12px; max-width: 80%; align-self: flex-start; }
        .chat-message.my-message { align-self: flex-end; }
        .chat-message .sender-avatar { width: 32px; height: 32px; border-radius: 50%; font-size: 1.5em; display: flex; justify-content: center; align-items: center; flex-shrink: 0; margin-right: 8px; }
        .chat-message.my-message .sender-avatar { display: none; }
        .chat-message .sender-avatar img { width: 100%; height: 100%; border-radius: 50%; }
        .chat-message .msg-body { display: flex; flex-direction: column; }
        .chat-message .sender { font-weight: 700; font-size: 0.85em; color: #555; margin-bottom: 3px; }
        .chat-message.my-message .sender { display: none; }
        .chat-message .content { padding: 8px 12px; border-radius: 18px; background-color: #e9ecef; display: inline-block; word-break: break-word; text-align: left; }
        .chat-message.my-message .content { background-color: var(--primary-color); color: white; border-top-right-radius: 4px; }
        .chat-message:not(.my-message) .content { border-top-left-radius: 4px; }
        
        /* 채팅 입력창 */
        #chat-controls { display: flex; gap: 8px; padding: 10px; align-items: center; position: relative; border-top: 1px solid var(--panel-border); }
        #emoji-toggle-btn { font-size: 1.6em; background: none; border: none; cursor: pointer; padding: 5px; color: #555; }
        #chat-input { flex-grow: 1; border: none; background-color: #f1f3f5; border-radius: 20px; padding: 10px 15px; font-size: 0.95em; font-family: 'GmarketSans', sans-serif; min-width: 0; }
        #chat-input:focus { outline: none; }
        #send-chat-btn { padding: 10px; font-size: 1.2em; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; cursor: pointer; width: 40px; height: 40px; display:flex; justify-content:center; align-items:center; flex-shrink: 0; }
        #send-chat-btn:disabled { background-color: #ccc; }

        #emoji-popover {
            display: none;
            position: absolute;
            bottom: calc(100% + 5px);
            left: 5px;
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            z-index: 10;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        #emoji-popover.active {
            display: grid;
            opacity: 1;
            transform: translateY(0);
        }
        
        #emoji-popover button { background: none; border: none; font-size: 1.8em; cursor: pointer; padding: 5px; transition: transform 0.1s; }
        #emoji-popover button:active { transform: scale(0.9); }
        
        /* PC/태블릿 반응형 스타일 (화면이 768px보다 클 때) */
        
        #player-list-vertical-wrapper { display: none; }

                .system-message {
            text-align: center;
            font-size: 0.85em;
            font-weight: 700;
            color: #e5a743; /* 노란색 계열 */
            margin: 10px 0;
        }
        
    </style>
</head>
<body>
    <audio id="click-sound" src="https://blog.kakaocdn.net/dna/dC0WAE/dJMb84DsZw6/AAAAAAAAAAAAAAAAAAAAAC8XpuPuNVEsdp6Ia-d35XR-m3FCZxObUR5uFI1tk2iv/%EB%B2%84%ED%8A%BC%EC%82%AC%EC%9A%B4%EB%93%9C.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1761922799&allow_ip=&allow_referer=&signature=RdbjxdP75HLHSpBIhymVkYpUOA0%D&attach=1&knm=tfile.mp3" preload="auto"></audio>
    <div id="lobby-view" class="view">
        <div class="lobby-panel">
            <div class="lobby-header">
                <h1>게임 대기실</h1>
            </div>
            <div id="room-list-container"></div>
        </div>
        <div id="lobby-bottom-actions">
            <button id="back-to-index-btn" class="menu-btn secondary">메인으로</button>
            <button id="create-room-btn" class="menu-btn primary">방만들기</button>
        </div>
    </div>

    <div id="waiting-overlay" class="overlay" style="display: none;"></div>
    <div id="info-overlay" class="overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header"><h2 id="info-title">알림</h2></div>
            <div class="modal-body">
                <p id="info-message" style="margin-bottom: 25px;"></p>
                <button id="info-confirm-btn" class="menu-btn primary" style="margin: 0; max-width: 200px;">확인</button>
            </div>
        </div>
    </div>


<div id="profile-modal" class="overlay" style="display: none;">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-body" style="padding: 25px;">
                <div id="profile-header" style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div id="profile-avatar-container" style="font-size: 3.5em; width: 70px; height: 70px; display:flex; justify-content:center; align-items:center;">
                        <span id="profile-avatar"></span>
                    </div>
                    <div id="profile-info-text" style="text-align: left;">
                        <h3 id="profile-nickname" style="margin: 0 0 5px; font-size: 1.5em;"></h3>
                        <span id="profile-level" style="font-size: 1em; color: #555; font-weight: 700;"></span>
                    </div>
                </div>
                <div id="profile-stats-section" style="padding: 15px 0; border-top: 1px solid var(--panel-border); border-bottom: 1px solid var(--panel-border);">
                    <div id="profile-stats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                        <div class="stat-item">
                            <h4 style="color: #888; font-size: 0.9em; margin-bottom: 4px;">승리</h4>
                            <p id="profile-wins" style="font-size: 1.3em; font-weight: 700; color: #333; margin: 0;"></p>
                        </div>
                        <div class="stat-item">
                            <h4 style="color: #888; font-size: 0.9em; margin-bottom: 4px;">패배</h4>
                            <p id="profile-losses" style="font-size: 1.3em; font-weight: 700; color: #333; margin: 0;"></p>
                        </div>
                        <div class="stat-item">
                            <h4 style="color: #888; font-size: 0.9em; margin-bottom: 4px;">승률</h4>
                            <p id="profile-winrate" style="font-size: 1.3em; font-weight: 700; color: #333; margin: 0;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="lobby-modal-footer" style="padding: 20px;">
                <button id="profile-close-btn" class="menu-btn secondary" style="margin:0;">닫기</button>
            </div>
        </div>
    </div>

    <div id="game-select-modal" class="overlay" style="display: none; background-color: rgba(0,0,0,0.8);">
      <div id="game-mode-modal" class="overlay" style="display: none; background-color: rgba(0,0,0,0.8);">
        <div class="modal-content">
            <div class="modal-header"><h2>어떤 모드로 할까요?</h2></div>
            <div class="modal-body" style="padding: 25px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button id="mode-turn-btn" class="game-select-btn" style="background-color: #4A8DFF20; color: #4A8DFF;">
                    <span class="icon">🔄</span>
                    <span>턴제 대결</span>
                </button>
                <button id="mode-survival-btn" class="game-select-btn" style="background-color: #F7636320; color: #F76363;">
                    <span class="icon">🔥</span>
                    <span>서바이벌</span>
                </button>
            </div>
            <div class="lobby-modal-footer" style="padding: 15px 25px 25px;">
                <button id="cancel-mode-select-btn" class="menu-btn secondary" style="margin:0;">취소</button>
            </div>
        </div>
    </div>
        <div class="modal-content">
            <div class="modal-header"><h2>어떤 게임을 할까요?</h2></div>
            <div class="modal-body" id="game-select-options"></div>
            <div class="lobby-modal-footer" style="padding: 15px 25px 25px;">
                <button id="cancel-game-select-btn" class="menu-btn secondary" style="margin:0;">취소</button>
            </div>
             </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        (function() {
    const devtools = {
        isOpen: false,
        orientation: undefined
    };
    const threshold = 160;
    const emitEvent = (isOpen, orientation) => {
        window.dispatchEvent(new CustomEvent('devtoolschange', {
            detail: {
                isOpen,
                orientation
            }
        }));
    };
    const main = ({emitEvents = true} = {}) => {
        const widthThreshold = window.outerWidth - window.innerWidth > threshold;
        const heightThreshold = window.outerHeight - window.innerHeight > threshold;
        const orientation = widthThreshold ? 'vertical' : 'horizontal';
        if (!(heightThreshold && widthThreshold) && ((window.Firebug && window.Firebug.chrome && window.Firebug.chrome.isInitialized) || widthThreshold || heightThreshold)) {
            if (!devtools.isOpen || devtools.orientation !== orientation) {
                if (emitEvents) {
                    emitEvent(true, orientation);
                }
            }
            devtools.isOpen = true;
            devtools.orientation = orientation;
        } else {
            if (devtools.isOpen) {
                if (emitEvents) {
                    emitEvent(false, undefined);
                }
            }
            devtools.isOpen = false;
            devtools.orientation = undefined;
        }
    };
    main({emitEvents: false});
    setInterval(main, 500);
    window.addEventListener('devtoolschange', event => {
        if (event.detail.isOpen) {
            document.body.innerHTML = '<div style="color:white; font-size:2em; text-align:center; padding-top:100px;">Developer tools are not allowed.</div>';
        }
    });
    document.addEventListener('contextmenu', e => e.preventDefault());
    function blockKeys(e) {
        if (
            e.keyCode === 123 ||
            (e.ctrlKey && e.shiftKey && (e.keyCode === 'I'.charCodeAt(0) || e.keyCode === 'J'.charCodeAt(0) || e.keyCode === 'C'.charCodeAt(0))) ||
            (e.ctrlKey && e.keyCode === 'U'.charCodeAt(0))
        ) {
            e.preventDefault();
        }
    }
    window.addEventListener('keydown', blockKeys);
    function checkDebugger() {
        const before = new Date().getTime();
        debugger;
        const after = new Date().getTime();
        if (after - before > 100) {
            document.body.innerHTML = '<div style="color:white; font-size:2em; text-align:center; padding-top:100px;">Developer tools are not allowed.</div>';
        }
    }
    if (document.readyState === 'complete') {
        checkDebugger();
        setInterval(checkDebugger, 1000);
    } else {
        window.addEventListener('load', () => {
            checkDebugger();
            setInterval(checkDebugger, 1000);
        });
    }
})();



        const clickSound = document.getElementById('click-sound');
        const playClickSound = () => {
            clickSound.currentTime = 0;
            clickSound.play().catch(e => console.log("Sound play failed:", e));
        };
 
        function playSound(id) {
            const sound = document.getElementById(id);
            if (sound) {
                sound.currentTime = 0;
                // play()가 실패해도 오류가 나지 않도록 .catch()를 추가합니다.
                sound.play().catch(error => {
                    console.warn("사운드 자동재생이 차단되었습니다:", error);
                });
            }
        }

        const firebaseConfig = {
            apiKey: "AIzaSyCmNAKmgF_L3o0QyOGh_oFAq_rMRtUyklw", authDomain: "goodluck-7c14b.firebaseapp.com",
            databaseURL: "https://goodluck-7c14b-default-rtdb.firebaseio.com", projectId: "goodluck-7c14b",
            storageBucket: "goodluck-7c14b.firebasestorage.app", messagingSenderId: "858281658455",
            appId: "1:858281658455:web:9131280a459be983933b12"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        auth.onAuthStateChanged(user => {
            if (user) {
                myPlayerId = user.uid;
                myNickname = localStorage.getItem('userNickname');
                myAvatar = localStorage.getItem('userAvatar');

                     initializeLobby();

              document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === 'visible') {
                        firebase.database().goOnline();
                    } else {
                        firebase.database().goOffline();
                    }
                });

                backToIndexBtn.addEventListener('click', () => { playClickSound(); window.location.href = 'index.html'; });
                document.getElementById('profile-close-btn').addEventListener('click', () => {
                    playClickSound();
                    document.getElementById('profile-modal').style.display = 'none';
                });
                createRoomBtn.addEventListener('click', () => { playClickSound(); createNewPublicRoom(); });

            } else if (sessionStorage.getItem('isGuest') === 'true') {
               
                myPlayerId = localStorage.getItem('myPlayerId');
                myNickname = localStorage.getItem('userNickname');
                myAvatar = localStorage.getItem('userAvatar');

                initializeLobby();

                document.addEventListener("visibilitychange", () => {
                    if (document.visibilityState === 'visible') {
                        firebase.database().goOnline();
                    } else {
                        firebase.database().goOffline();
                    }
                });

                backToIndexBtn.addEventListener('click', () => { playClickSound(); window.location.href = 'index.html'; });
                document.getElementById('profile-close-btn').addEventListener('click', () => {
                    playClickSound();
                    document.getElementById('profile-modal').style.display = 'none';
                });
                createRoomBtn.addEventListener('click', () => { playClickSound(); createNewPublicRoom(); });

            } else {
    
                alert("로그인 정보가 없습니다. 메인 화면으로 돌아갑니다.");
                window.location.href = 'index.html';
            }
        });
    

        const gameRoomsRef = database.ref('memoryGameRooms');
        
        const lobbyView = document.getElementById('lobby-view'),
              backToIndexBtn = document.getElementById('back-to-index-btn'),
              createRoomBtn = document.getElementById('create-room-btn'),
              roomListContainer = document.getElementById('room-list-container'),
              waitingOverlay = document.getElementById('waiting-overlay'),
              infoOverlay = document.getElementById('info-overlay'),
              infoTitle = document.getElementById('info-title'),
              infoMessage = document.getElementById('info-message'),
              infoConfirmBtn = document.getElementById('info-confirm-btn'),
              gameSelectModal = document.getElementById('game-select-modal');
        
const availableGames = [
        { id: 'memory', name: '메모리게임', icon: '🧠', color: '#4CAF50', file: '메모리게임.html' },
        { id: 'maze', name: '미로찾기', icon: '🚀', color: '#34495e', file: '미로찾기멀티.html' },
        { id: 'alkkagi', name: '알까기', icon: '⚪', color: '#8d6e63', file: '알까기.html' },
        { id: 'reversi', name: '리버시', icon: '⚫', color: '#00897B', file: '리버시.html' },
        { id: 'fker', name: '인디언포커', icon: '🃏', color: '#C9372C', file: '인디언포커.html' },
        { id: 'candysoap', name: '캔디솝', icon: '🍬', color: '#FF69B4', file: '캔디솝.html' } 
    ];

        let myPlayerId, myNickname, myAvatar, roomRef, currentRoomData, isHost = false;
        let lobbyListener = null; 

       

        function showInfoModal(title, message, onConfirm) {
            infoTitle.textContent = title;
            infoMessage.textContent = message;
            infoConfirmBtn.onclick = () => {
                playClickSound();
                infoOverlay.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            infoOverlay.style.display = 'flex';
        }

        function cleanupOldRoomState() {
            if (roomRef) {
                roomRef.child('chat').off(); 
                roomRef.off(); 
                roomRef.onDisconnect().cancel(); 
            }
            roomRef = null; currentRoomData = null; isHost = false;
        }

        function startLobbyListener() {
            stopLobbyListener();
            roomListContainer.innerHTML = `<div class="spinner"></div>`;
            const query = gameRoomsRef.orderByChild('createdAt').limitToLast(20);
            lobbyListener = query.on('value', snapshot => {
                roomListContainer.innerHTML = '';
                let roomCount = 0; 

                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const room = childSnapshot.val();
                        const roomKey = childSnapshot.key;
        
                        if (!room || !room.players || Object.keys(room.players).length === 0) {
                            console.log(`유령 방(${roomKey})을 발견하여 자동으로 삭제합니다.`);
                            gameRoomsRef.child(roomKey).remove(); 
                            return; 
                        }
                        
                        roomCount++; 
                        const playerCount = Object.keys(room.players).length;
                        
                        let maxPlayers = 4; // 기본 최대 4명
                        if (room.selectedGame === 'alkkagi' || room.selectedGame === 'reversi' || room.selectedGame === 'fker') {
                            maxPlayers = 2; // 2인 전용 게임
                        }
                       

                        const isPlaying = room.gameState === 'playing' || room.gameState === 'launching';
                        const isFull = playerCount >= maxPlayers;
                        const game = room.selectedGame ? availableGames.find(g => g.id === room.selectedGame) : null;
                        const gameInfo = game ? `${game.icon} ${game.name}` : `<span style="color:#999">선택중...</span>`;
                        const statusText = isPlaying ? '게임중' : '대기중';
                        const statusClass = isPlaying ? 'playing' : 'waiting';

                        const roomItem = document.createElement('div');
                        roomItem.className = 'room-item';
                        roomItem.innerHTML = `
                            <div class="room-main-info">
                                <div class="room-name">${room.roomName}</div>
                                <div class="room-detail-line game"><span class="detail-label">게임</span><span class="detail-value">${gameInfo}</span></div>
                                <div class="room-detail-line status-players">
                                    <div class="status-wrapper"><span class="detail-label">상태</span><span class="detail-value room-status ${statusClass}">[ ${statusText} ]</span></div>
                                    <div class="players-wrapper"><span class="detail-label">인원</span><span class="detail-value">${playerCount} / ${maxPlayers}</span></div>
                                </div>
                            </div>
                            <button class="menu-btn join-btn primary" data-room-id="${childSnapshot.key}" ${isFull || isPlaying ? 'disabled' : ''}>참가하기</button>
                        `;
                        roomListContainer.prepend(roomItem);
                    });
                }
    
                if (roomCount === 0) {
                    roomListContainer.innerHTML = `<p style="text-align:center; color:#888; padding-top: 40px;">현재 참여 가능한 방이 없습니다.<br>새로운 방을 만들어보세요!</p>`;
                } else {
                    document.querySelectorAll('.join-btn').forEach(btn => btn.addEventListener('click', e => { playClickSound(); joinRoom(e.target.dataset.roomId); }));
                }
            });
        }

        function stopLobbyListener() {
            if (lobbyListener) { gameRoomsRef.off('value', lobbyListener); lobbyListener = null; }
        }

        function createNewPublicRoom() {
            gameRoomsRef.orderByChild('hostId').equalTo(myPlayerId).once('value', snapshot => {
                const creationAction = () => {
                    stopLobbyListener();
                    cleanupOldRoomState();
                    isHost = true;
                    const newRoomData = { 
                        roomName: `${myNickname}님의 방`, hostId: myPlayerId, 
                        players: { [myPlayerId]: { nickname: myNickname, avatar: myAvatar, score: 0, isHost: true }}, 
                        gameState: 'waiting', createdAt: firebase.database.ServerValue.TIMESTAMP, selectedGame: null
                    };
                    roomRef = gameRoomsRef.push();
                    roomRef.onDisconnect().remove();
                    roomRef.set(newRoomData).then(() => { listenToRoomChanges(); showGameSelectModal(); });
                };

                if (snapshot.exists()) {
                    const existingRoomId = Object.keys(snapshot.val())[0];
                    gameRoomsRef.child(existingRoomId).remove().then(creationAction);
                } else {
                    creationAction();
                }
            });
        }

        function joinRoom(roomId) {
            stopLobbyListener();
            cleanupOldRoomState();
            isHost = false;
            roomRef = gameRoomsRef.child(roomId);

            roomRef.transaction(currentData => {
                if (currentData === null) {
                    return null; 
                }
                
                let maxPlayers = 4;
                if (currentData.selectedGame === 'alkkagi' || currentData.selectedGame === 'reversi' || currentData.selectedGame === 'fker') {
                    maxPlayers = 2;
                }

                if (currentData.gameState !== 'waiting' || (currentData.players && Object.keys(currentData.players).length >= maxPlayers)) {
                    return; 
                }
        
                if (!currentData.players) {
                    currentData.players = {}; 
                }
                currentData.players[myPlayerId] = { nickname: myNickname, avatar: myAvatar, score: 0, isHost: false };
                
                return currentData; 
            }, 
            (error, committed, snapshot) => {
                if (error) {
                    console.error("Transaction Error:", error);
                    showInfoModal("입장 실패", "데이터베이스 오류가 발생했습니다.");
                    startLobbyListener();
                } else if (committed) {
                    roomRef.child('players/' + myPlayerId).onDisconnect().remove();
                    listenToRoomChanges();
                } else {
                    const roomData = snapshot.val();
                    if (roomData === null) {
                         showInfoModal("입장 실패", "방이 사라졌습니다. 다른 방을 선택해주세요.");
                    } else {
                         showInfoModal("입장 실패", "방이 꽉 찼거나 이미 게임이 시작되었습니다.");
                    }
                    startLobbyListener();
                }
            });
        }

        function listenToRoomChanges() {
            lobbyView.classList.add('hidden');
            let previousPlayers = null;
            let isFirstRun = true;

            roomRef.on('value', snapshot => {
                if (!snapshot.exists()) {
                    if (roomRef) roomRef.off();
                    showInfoModal("방이 해체되었습니다", "방장이 게임을 떠나 대기실로 이동합니다.", () => {
                        cleanupOldRoomState();
                        waitingOverlay.style.display = 'none';
                        lobbyView.classList.remove('hidden');
                        startLobbyListener();
                    });
                    return;
                }
                
                const latestRoomData = snapshot.val();
                const currentPlayers = latestRoomData.players || {};

                // --- [핵심 수정] 플레이어 목록에 '실제 변경'이 있을 때만 입장/퇴장 감지 ---
                // previousPlayers가 null이 아니고, JSON 문자열로 비교했을 때 다를 경우에만 실행
                if (previousPlayers !== null && JSON.stringify(previousPlayers) !== JSON.stringify(currentPlayers)) {
                    const currentPlayerIds = Object.keys(currentPlayers);
                    const previousPlayerIds = Object.keys(previousPlayers);

                    // 새로 입장한 플레이어
                    const newPlayerIds = currentPlayerIds.filter(id => !previousPlayerIds.includes(id));
                    newPlayerIds.forEach(id => {
                        const nickname = currentPlayers[id]?.nickname;
                        if (nickname) {
                            addSystemMessage(`🔔 ${nickname}님이 입장했습니다.`);
                            triggerVibration();
                             playSound('enter-sound'); // 사운드 기능은 일단 주석 처리 (필요시 해제)
                        }
                    });

                    // 퇴장한 플레이어
                    const leftPlayerIds = previousPlayerIds.filter(id => !currentPlayerIds.includes(id));
                    leftPlayerIds.forEach(id => {
                        const nickname = previousPlayers[id]?.nickname; 
                        if (nickname) {
                            addSystemMessage(`🔔 ${nickname}님이 퇴장했습니다.`);
                            triggerVibration();
                             playSound('leave-sound'); // 사운드 기능은 일단 주석 처리 (필요시 해제)
                        }
                    });
                }
                
                // --- 상태 업데이트 및 UI 렌더링 (항상 실행) ---
                previousPlayers = currentPlayers; 
                currentRoomData = latestRoomData; 

                if (isFirstRun) {
                    updateInGameLobbyUI();
                    setupChat(); 
                    isFirstRun = false;
                } else {
                    updateLobbyPlayersAndGame();
                }

                if (latestRoomData.gameState === 'launching' && latestRoomData.launchUrl) {
                    if (isHost) roomRef.onDisconnect().cancel();
                    else roomRef.child('players/' + myPlayerId).onDisconnect().cancel();
                    roomRef.off();
                    window.location.href = latestRoomData.launchUrl;
                }
            });
        }

        function updateInGameLobbyUI() {
            const { players, selectedGame, roomName } = currentRoomData;
            const playerEntries = Object.entries(players);

            let gameSubtitleHTML = `<div class="game-subtitle">`;
            if (selectedGame) {
                const game = availableGames.find(g => g.id === selectedGame);
                gameSubtitleHTML += `${game.icon} ${game.name}`;
            } else {
                gameSubtitleHTML += `게임 선택 대기중...`;
            }
            gameSubtitleHTML += `</div>`;

            let playerListHorizontalHTML = '';
            playerEntries.forEach(([pid, p]) => {
                const avatarHTML = p.avatar.startsWith('http') ? `<img src="${p.avatar}" alt="av">` : p.avatar;
                const clickAttribute = (pid === myPlayerId || pid.startsWith('guest_')) ? '' : `data-player-id="${pid}"`;
                playerListHorizontalHTML += `
                    <div class="player-slot-compact ${p.isHost ? 'is-host' : ''}" ${clickAttribute}>
                        <div class="avatar">${avatarHTML}</div>
                        <div class="nickname">${p.nickname}</div>
                    </div>`;
            });


            let playerListVerticalHTML = '';
            playerEntries.forEach(([pid, p]) => {
                let avatarHTML = p.avatar.startsWith('http') ? `<img src="${p.avatar}" class="player-avatar-img">` : `<span class="player-avatar-emoji">${p.avatar}</span>`;
                const clickAttribute = (pid === myPlayerId || pid.startsWith('guest_')) ? '' : `data-player-id="${pid}"`;
                playerListVerticalHTML += `<div class="player-item ${p.isHost ? 'is-host' : ''}" ${clickAttribute}>${avatarHTML} <span class="nickname">${p.nickname} ${pid === myPlayerId ? ' (나)' : ''}</span></div>`;
            });

            let canStart = false;
            if (selectedGame === 'candysoap') {
                canStart = playerEntries.length >= 1; // 캔디솝은 1명부터 시작 가능
            } else if (selectedGame === 'reversi' || selectedGame === 'fker') {
                canStart = playerEntries.length === 2; // 리버시/인디언포커는 2명만 가능
            } else {
                canStart = playerEntries.length >= 2 && selectedGame; // 그 외 게임은 2명 이상
            }

            const startGameBtnHTML = isHost ? `<button id="start-game-btn" class="menu-btn primary" ${!canStart ? 'disabled' : ''}>시작</button>` : '';
            waitingOverlay.innerHTML = `
                <div class="modal-content in-game-lobby">
                    <div class="modal-header">
                        <h2>${roomName}</h2>
                        ${gameSubtitleHTML}
                    </div>
                    <div class="modal-body">
                        <div id="player-list-wrapper">
                            <div id="player-list-horizontal">${playerListHorizontalHTML}</div>
                        </div>
                        <div id="player-list-vertical-wrapper">
                            ${playerListVerticalHTML}
                        </div>
                        <div id="chat-container"></div>
                    </div>
                    <div id="chat-controls">
                        <button id="emoji-toggle-btn">😀</button>
 <div id="emoji-popover">
    <button>👍</button><button>😂</button><button>😮</button><button>👋</button>
    <button>😏</button><button>👌</button><button>😭</button><button>🤗</button>
    <button>💖</button><button>😡</button><button>🤔</button><button>😱</button></div>
                        <input type="text" id="chat-input" placeholder="메시지 입력.." maxlength="50" autocomplete="off" autocorrect="off">
                        <button id="send-chat-btn">➤</button>
                    </div>
                    <div class="lobby-modal-footer">
                        <button id="leave-room-btn" class="menu-btn secondary">나가기</button>
                        ${startGameBtnHTML}
                        ${isHost ? `<button id="game-select-btn" class="menu-btn secondary">게임변경</button>` : ''}
                    </div>
                </div>`;
            waitingOverlay.style.display = 'flex';
            
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-chat-btn');
            const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
            const emojiPopover = document.getElementById('emoji-popover');
            
            const sendMessage = (messageContent) => {
                if (!messageContent.trim() || !roomRef) return;
                const messageData = {
                    senderId: myPlayerId,
                    senderNickname: myNickname,
                    content: messageContent.trim(),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                roomRef.child('chat').push(messageData);
                chatInput.value = '';
            };

            sendBtn.onclick = () => { playClickSound(); sendMessage(chatInput.value); };
            chatInput.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(chatInput.value); }};
            emojiToggleBtn.onclick = (e) => { playClickSound(); e.stopPropagation(); emojiPopover.classList.toggle('active'); };
            
            emojiPopover.querySelectorAll('button').forEach(emojiBtn => {
                emojiBtn.onclick = () => { playClickSound(); sendMessage(emojiBtn.textContent); emojiPopover.classList.remove('active'); };
            });

            if(isHost) {
                document.getElementById('start-game-btn')?.addEventListener('click', () => { playClickSound(); startGame(); });
                document.getElementById('game-select-btn')?.addEventListener('click', () => { playClickSound(); showGameSelectModal(); });
            }

            document.querySelectorAll('.player-slot-compact[data-player-id], .player-item[data-player-id]').forEach(item => {
                item.addEventListener('click', () => { playClickSound(); showPlayerProfileModal(item.dataset.playerId); });
            });

            document.getElementById('leave-room-btn').addEventListener('click', () => {
                playClickSound();
                waitingOverlay.style.display = 'none';
                if (roomRef) roomRef.child('players/' + myPlayerId).remove(); 
                cleanupOldRoomState(); 
                lobbyView.classList.remove('hidden');
                startLobbyListener(); 
            });
        }

 function updateLobbyPlayersAndGame() {
            if (!currentRoomData) return;
            const { players, selectedGame } = currentRoomData;
            const playerEntries = Object.entries(players);

            const gameSubtitle = document.querySelector('.in-game-lobby .game-subtitle');
            if (gameSubtitle) {
                if (selectedGame) {
                    const game = availableGames.find(g => g.id === selectedGame);
                    gameSubtitle.innerHTML = `${game.icon} ${game.name}`;
                } else {
                    gameSubtitle.innerHTML = `게임 선택 대기중...`;
                }
            }
            
            let playerListHorizontalHTML = '';
            playerEntries.forEach(([pid, p]) => {
                const avatarHTML = p.avatar.startsWith('http') ? `<img src="${p.avatar}" alt="av">` : p.avatar;
                const clickAttribute = (pid === myPlayerId || pid.startsWith('guest_')) ? '' : `data-player-id="${pid}"`;
                playerListHorizontalHTML += `<div class="player-slot-compact ${p.isHost ? 'is-host' : ''}" ${clickAttribute}><div class="avatar">${avatarHTML}</div><div class="nickname">${p.nickname}</div></div>`;
            });
            const horizontalList = document.getElementById('player-list-horizontal');
            if(horizontalList) horizontalList.innerHTML = playerListHorizontalHTML;
            
            let playerListVerticalHTML = '';
            playerEntries.forEach(([pid, p]) => {
                let avatarHTML = p.avatar.startsWith('http') ? `<img src="${p.avatar}" class="player-avatar-img">` : `<span class="player-avatar-emoji">${p.avatar}</span>`;
                const clickAttribute = (pid === myPlayerId || pid.startsWith('guest_')) ? '' : `data-player-id="${pid}"`;
                playerListVerticalHTML += `<div class="player-item ${p.isHost ? 'is-host' : ''}" ${clickAttribute}>${avatarHTML} <span class="nickname">${p.nickname} ${pid === myPlayerId ? ' (나)' : ''}</span></div>`;
            });
            const verticalWrapper = document.getElementById('player-list-vertical-wrapper');
            if(verticalWrapper) verticalWrapper.innerHTML = playerListVerticalHTML;

            document.querySelectorAll('.player-slot-compact[data-player-id], .player-item[data-player-id]').forEach(item => {
                item.addEventListener('click', () => { playClickSound(); showPlayerProfileModal(item.dataset.playerId); });
            });

                      const startGameBtn = document.getElementById('start-game-btn');
            if (startGameBtn) {
              
                let canStart = false;
                if (selectedGame === 'candysoap') {
                    canStart = playerEntries.length >= 1; // 캔디솝은 1명부터 시작 가능
                } else if (selectedGame === 'reversi' || selectedGame === 'fker') {
                    canStart = playerEntries.length === 2; // 리버시/인디언포커는 2명만 가능
                } else {
                    canStart = playerEntries.length >= 2 && selectedGame; 
                }
                startGameBtn.disabled = !canStart;
            }
        }

                function triggerVibration() {
            if ('vibrate' in navigator) {
                navigator.vibrate(200); // 100ms 동안 진동
            }
        }

        function addSystemMessage(message) {
            const chatDisplay = document.getElementById('chat-container');
            if (!chatDisplay) return;

            const msgElement = document.createElement('div');
            msgElement.className = 'system-message';
            msgElement.textContent = message;
            
            chatDisplay.appendChild(msgElement);
            chatDisplay.scrollTop = chatDisplay.scrollHeight;
        }

        function setupChat() {
            const chatDisplay = document.getElementById('chat-container');
            const chatInput = document.getElementById('chat-input');
const sendBtn = document.getElementById('send-chat-btn');
const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
const emojiPopover = document.getElementById('emoji-popover');

const sendMessage = (messageContent) => {
    if (!messageContent.trim() || !roomRef) return;
    const messageData = {
        senderId: myPlayerId,
        senderNickname: myNickname,
        content: messageContent.trim(),
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };
    roomRef.child('chat').push(messageData);
    chatInput.value = '';
    chatInput.focus(); 
};

sendBtn.onclick = () => { playClickSound(); sendMessage(chatInput.value); };
chatInput.onkeypress = (e) => { if (e.key === 'Enter') { e.preventDefault(); sendMessage(chatInput.value); }};
emojiToggleBtn.onclick = (e) => { playClickSound(); e.stopPropagation(); emojiPopover.classList.toggle('active'); };

emojiPopover.querySelectorAll('button').forEach(emojiBtn => {
    emojiBtn.onclick = () => { playClickSound(); sendMessage(emojiBtn.textContent); emojiPopover.classList.remove('active'); };
});

            const chatRef = roomRef.child('chat').limitToLast(50);
            chatRef.on('child_added', snapshot => {
                const msg = snapshot.val();
        
                const senderInfo = currentRoomData.players[msg.senderId];
                if (!chatDisplay || !senderInfo) return; 

                const avatarHTML = senderInfo.avatar.startsWith('http') 
                    ? `<img src="${senderInfo.avatar}" alt="av">` 
                    : senderInfo.avatar;

                const msgElement = document.createElement('div');
                msgElement.classList.add('chat-message');
                if (msg.senderId === myPlayerId) msgElement.classList.add('my-message');
                
                msgElement.innerHTML = `
                    <div class="sender-avatar">${avatarHTML}</div>
                    <div class="msg-body">
                        <div class="sender">${msg.senderNickname}</div>
                        <div class="content"></div>
                    </div>`;

               const escapeHtml = (unsafe) => {
                    return unsafe
                         .replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
                };
                msgElement.querySelector('.content').innerHTML = escapeHtml(msg.content);
                
                chatDisplay.appendChild(msgElement);
                chatDisplay.scrollTop = chatDisplay.scrollHeight;
            });
        }

        
function startGame() {
    if (!isHost || !currentRoomData) return;
    const game = availableGames.find(g => g.id === currentRoomData.selectedGame);
    if (!game) return;

    const playerCount = Object.keys(currentRoomData.players).length;

    if (game.id === 'candysoap' && playerCount >= 2) {
        const modeModal = document.getElementById('game-mode-modal');
        modeModal.style.display = 'flex';

        const launchGameWithMode = (mode) => {
            modeModal.style.display = 'none';
                    const launchUrl = `${game.file}?roomId=${roomRef.key}&mode=${mode}`;
            roomRef.update({ gameState: 'launching', launchUrl: launchUrl });
        };

        document.getElementById('mode-turn-btn').onclick = () => launchGameWithMode('turn');
        document.getElementById('mode-survival-btn').onclick = () => launchGameWithMode('survival');
        document.getElementById('cancel-mode-select-btn').onclick = () => modeModal.style.display = 'none';

        return; 
    }

    if ((game.id === 'reversi' || game.id === 'fker') && playerCount !== 2) {
        alert(`${game.name} 게임은 2명일 때만 시작할 수 있습니다.`);
        return;
    }

    const launchUrl = `${game.file}?roomId=${roomRef.key}`;
    roomRef.update({ gameState: 'launching', launchUrl: launchUrl });
}


                
    

        function showGameSelectModal() {
            const optionsContainer = document.getElementById('game-select-options');
            optionsContainer.innerHTML = '';
            availableGames.forEach(game => {
                const btn = document.createElement('button');
                btn.className = 'game-select-btn';
                btn.style.backgroundColor = game.color + '20';
                btn.style.color = game.color;
                btn.innerHTML = `<span class="icon">${game.icon}</span><span>${game.name}</span>`;
                btn.onclick = () => { playClickSound(); selectGame(game.id); };
                optionsContainer.appendChild(btn);
            });

            document.getElementById('cancel-game-select-btn').onclick = () => {
                playClickSound();
                gameSelectModal.style.display = 'none';
            };
            gameSelectModal.style.display = 'flex';
        }

        function selectGame(gameId) {
            if (isHost && roomRef) { roomRef.update({ selectedGame: gameId }); }
            gameSelectModal.style.display = 'none';
        }

        function showPlayerProfileModal(playerId) {
            if (playerId.startsWith('guest_')) {
                showInfoModal("알림", "게스트 유저는 전적 정보를 볼 수 없습니다.");
                return;
            }
            const playersRef = database.ref(`users/${playerId}`);
            playersRef.once('value', snapshot => {
                if (snapshot.exists()) {
                    displayProfileData(snapshot.val());
                    document.getElementById('profile-modal').style.display = 'flex';
                } else {
                    showInfoModal("오류", "플레이어 정보를 불러오는 데 실패했습니다.");
                }
            });
        }

        function initializeLobby() {
            gameRoomsRef.orderByChild('hostId').equalTo(myPlayerId).once('value', snapshot => {
                if (snapshot.exists()) {
                      const existingRoomId = Object.keys(snapshot.val())[0];
                    console.log(`기존 유령 방(${existingRoomId})을 삭제하고 새로 시작합니다.`);
                    gameRoomsRef.child(existingRoomId).remove().then(() => {
                        startLobbyListener();
                    });
                } else {
                
                    startLobbyListener();
                }
            });
        }

        function displayProfileData(data) {
            const profileModal = document.getElementById('profile-modal');
            const stats = data.stats || {};
            const totalWins = Object.values(stats).reduce((sum, game) => sum + (game.wins || 0), 0);
            const totalLosses = Object.values(stats).reduce((sum, game) => sum + (game.losses || 0), 0);
            const totalGames = totalWins + totalLosses;
            const winRate = totalGames > 0 ? ((totalWins / totalGames) * 100).toFixed(1) + '%' : '-';
            
            const avatarContainer = profileModal.querySelector('#profile-avatar-container');
            if (data.avatar && data.avatar.startsWith('http')) {
                avatarContainer.innerHTML = `<img src="${data.avatar}" alt="프로필 이미지">`;
            } else {
                avatarContainer.innerHTML = `<span id="profile-avatar">${data.avatar || '👤'}</span>`;
            }

            profileModal.querySelector('#profile-nickname').textContent = data.nickname;
            profileModal.querySelector('#profile-level').textContent = `Lv. ${data.level || 1}`;
            profileModal.querySelector('#profile-wins').textContent = `${totalWins} 승`;
            profileModal.querySelector('#profile-losses').textContent = `${totalLosses} 패`;
            profileModal.querySelector('#profile-winrate').textContent = winRate;
        }

       
    });
    </script>
</body>
</html>
