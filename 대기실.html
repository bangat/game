<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ÎåÄÍ∏∞Ïã§</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff" as="font" type="font/woff" crossorigin>
    <style>
        :root {
            --bg-color: #F3F7FD; --primary-color: #4A8DFF; --accent-color: #FFC84A;
            --text-color-dark: #333D4B; --text-color-light: #ffffff;
            --danger-color: #F76363; --panel-bg: #ffffff; --panel-border: #E5E8EB;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%; height: 100%; overflow: hidden; font-family: 'GmarketSans', sans-serif;
            background-color: var(--bg-color); color: var(--text-color-dark);
        }
        .view {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            padding: 0; /* Î∂àÌïÑÏöîÌïú Ïó¨Î∞± Ï†úÍ±∞ */
        }
        .spinner { border: 4px solid rgba(0,0,0,0.1); border-radius: 50%; border-top: 4px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
       .lobby-header { width: 100%; display: flex; justify-content: flex-start; align-items: center; padding: 15px 20px; flex-shrink: 0; border-bottom: 1px solid var(--panel-border); }
      .lobby-panel { display: flex; flex-direction: column; width: 100%; /* max-width: 500px; */ height: 100%; background: var(--panel-bg); border-radius: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 1px solid var(--panel-border); }
       #my-profile-btn { display: flex; align-items: center; gap: 12px; background: none; border: none; cursor: pointer; padding: 0; border-radius: 20px; }
        #my-profile-avatar { width: 48px; height: 48px; font-size: 2.4em; display: flex; justify-content: center; align-items: center; }
        #my-profile-avatar img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        #my-profile-nickname { font-weight: 700; }
        #my-profile-points {
            font-size: 0.8em;
            font-weight: 700;
            color: #6a4a3a;
            background-color: #ffdeaa;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }

        #room-list-container { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .room-item { display: flex; align-items: center; justify-content: space-between; background-color: #fff; border: 1px solid var(--panel-border); border-radius: 12px; margin-bottom: 15px; padding: 15px; }
        .room-info h3 { font-size: 1.2em; margin-bottom: 8px; }
        .room-info p { font-size: 0.9em; color: #666; }
        .join-btn { flex-shrink: 0; padding: 10px 20px; font-size: 1em; max-width: 80px; }
        #lobby-bottom-actions { width: 100%; padding: 20px; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid var(--panel-border); }
        .menu-btn { width: 100%; padding: 15px; font-size: 1.2em; font-weight: 700; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .menu-btn.primary { background-color: var(--primary-color); color: var(--text-color-light); }
        .menu-btn.secondary { background-color: #E9EEF2; color: var(--text-color-dark); }
        .menu-btn:disabled { background-color: #ccc !important; cursor: not-allowed; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 200; background-color: rgba(0,0,0,0.6); }
        .overlay.active { display: flex; }
        .modal-content { background: var(--panel-bg); border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 90%; max-width: 400px; overflow: hidden; }
        .modal-header { padding: 15px 20px; background-color: var(--primary-color); color: white; border-radius: 16px 16px 0 0; }
        .modal-header h2 { font-size: 1.5em; }
        .modal-body { padding: 25px; max-height: 70vh; overflow-y: auto;}
        .modal-footer { display: flex; gap: 10px; padding: 0 25px 25px; }
        .modal-footer .menu-btn { margin: 0; }
        
        #profile-dashboard-header { display: flex; align-items: center; gap: 15px; padding-bottom: 20px; }
        #profile-dashboard-avatar { font-size: 3.5em; width: 64px; height: 64px; display: flex; justify-content: center; align-items: center;}
        #profile-dashboard-avatar img { width: 100%; height: 100%; object-fit: contain; border-radius: 50%; }
        #profile-dashboard-nickname { font-size: 1.5em; }
        #profile-menu-buttons { display: flex; flex-direction: column; gap: 10px; padding-top: 20px; border-top: 1px solid var(--panel-border); }
        
        #game-select-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .game-select-btn { aspect-ratio: 1 / 1; font-size: 1.2em; border-radius: 12px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 5px; }
        .game-select-btn .icon { font-size: 2em; }
        .game-select-btn:hover { transform: translateY(-5px); border-color: var(--accent-color); }
        
      #ranking-modal .modal-content { width: 100%; height: 100%; max-width: none; max-height: none; border-radius: 0; display: flex; flex-direction: column; }
        #ranking-modal .modal-body { padding: 0; display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .back-btn { background: none; border: none; color: white; font-size: 2.5em; cursor: pointer; padding: 0 10px; }
        
        #ranking-tabs { flex-shrink: 0; display: flex; padding: 10px; gap: 8px; overflow-x: auto; background-color: #f8f9fa; border-bottom: 1px solid var(--panel-border); }
        .tab-btn { padding: 10px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; border: none; background: #e9ecef; white-space: nowrap; }
        .tab-btn.active { background-color: var(--primary-color); color: white; }
        
        #ranking-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .ranking-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { display: flex; align-items: center; background-color: #fff; border-radius: 12px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .rank-col-rank { font-size: 1.2em; font-weight: 700; color: #888; width: 35px; text-align: center; flex-shrink: 0; }
        .rank-col-profile { display: flex; align-items: center; gap: 10px; flex-grow: 1; min-width: 0; }
        .rank-avatar { width: 42px; height: 42px; font-size: 2em; flex-shrink: 0; }
        .rank-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: contain; }
        .profile-text .nickname { font-size: 1em; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .profile-text .level { font-size: 0.8em; color: #666; }

        .rank-col-stats { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 8px; text-align: right; }
        .stat-item { padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 700; white-space: nowrap; }
        .stat-item.wins { background-color: #E3F2FD; color: #1E88E5; }
        .stat-item.losses { background-color: #FFEBEE; color: #E53935; }
        .stat-item.winrate { background-color: #F3E5F5; color: #8E24AA; }
        .stat-item.plays { background-color: #E8EAF6; color: #3949AB; }
        .stat-item.points { background-color: #FFF8E1; color: #FF8F00; }

        #game-mode-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 3px solid var(--panel-border);
        }
        .game-mode-tab-btn {
            flex: 1;
            padding: 12px 10px;
            font-size: 1.1em;
            font-weight: 700;
            background: none;
            border: none;
            cursor: pointer;
            color: #888;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px; /* Î∂ÄÎ™® border-bottomÍ≥º Í≤πÏπòÍ≤å */
            transition: all 0.2s ease;
        }
        .game-mode-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        
    </style>
</head>
<body>
    <audio id="click-sound" src="https://blog.kakaocdn.net/dna/dC0WAE/dJMb84DsZw6/AAAAAAAAAAAAAAAAAAAAAC8XpuPuNVEsdp6Ia-d35XR-m3FCZxObUR5uFI1tk2iv/%EB%B2%84%ED%8A%BC%EC%82%AC%EC%9A%B4%EB%93%9C.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1761922799&allow_ip=&allow_referer=&signature=RdbjxdP75HLHSpBIhymVkYpUOA0%3D&attach=1&knm=tfile.mp3" preload="auto"></audio>
    <div id="lobby-view" class="view">
        <div class="lobby-panel">
            <div class="lobby-header">
                <button id="my-profile-btn">
                    <span id="my-profile-avatar"></span>
                    <span id="my-profile-nickname">...</span>
                    <span id="my-profile-points"></span>
                </button>
            </div>
            <div id="room-list-container"><div class="spinner"></div></div>
            <div id="lobby-bottom-actions">
                <div style="display: flex; gap: 10px;">
                    <button id="ranking-btn" class="menu-btn secondary">üèÜ Îû≠ÌÇπ</button>
                    <button id="shop-btn" class="menu-btn secondary">üíé ÏÉÅÏ†ê</button>
                </div>
                 <button id="create-room-btn" class="menu-btn primary">Î∞© ÎßåÎì§Í∏∞</button>
            </div>
        </div>
    </div>

    <div id="profile-dashboard-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>ÎÇ¥ Ï†ïÎ≥¥</h2></div>
            <div class="modal-body">
                <div id="profile-dashboard-header">
                    <span id="profile-dashboard-avatar"></span>
                    <div>
                        <h3 id="profile-dashboard-nickname"></h3>
                        <p>Lv. <span id="profile-dashboard-level">1</span> (<span id="profile-points">0</span> P)</p>
                    </div>
                </div>
                <div id="profile-menu-buttons">
                    <button class="menu-btn secondary" onclick="alert('ÌîÑÎ°úÌïÑÎ£∏ÏùÄ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§.')">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ï</button>
                    <button class="menu-btn secondary" onclick="alert('Í≤åÏûÑÏÑ§Ï†ïÏùÄ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§.')">Í≤åÏûÑ ÏÑ§Ï†ï</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="logout-btn" class="menu-btn secondary" style="background-color: var(--danger-color); color: white;">Î°úÍ∑∏ÏïÑÏõÉ</button>
                <button class="menu-btn secondary" data-close>Îã´Í∏∞</button>
            </div>
        </div>
    </div>

    <div id="confirm-exit-modal" class="overlay">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <h3 style="font-size: 1.4em; margin-bottom: 15px;">Í≤åÏûÑÏùÑ Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?</h3>
            </div>
            <div class="modal-footer" style="padding: 20px;">
                <button class="menu-btn secondary" data-close>Ï∑®ÏÜå</button>
                <button id="exit-confirm-btn" class="menu-btn primary" style="background-color: var(--danger-color);">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    
    <div id="ranking-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between;">
                <button class="back-btn" data-close>‚Äπ</button>
                <h2 style="flex-grow: 1; text-align: center; margin: 0;">üèÜÎ™ÖÏòàÏùò Ï†ÑÎãπ</h2>
                <div style="width: 40px;"></div> </div>
            <div class="modal-body">
                <div id="ranking-tabs"></div>
                <div id="ranking-content"></div>
            </div>
            </div>
    </div>


    
    <div id="game-select-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between;">
                <button class="back-btn" data-close>‚Äπ</button>
                <h2 style="flex-grow: 1; text-align: center; margin: 0;">Í≤åÏûÑ ÏÑ†ÌÉù</h2>
                <div style="width: 40px;"></div> </div>
            <div class="modal-body">
                <div id="game-mode-tabs">
                    <button class="game-mode-tab-btn active" data-mode="multi">Í∞ôÏù¥ ÌïòÍ∏∞</button>
                    <button class="game-mode-tab-btn" data-mode="solo">ÌòºÏûê ÌïòÍ∏∞</button>
                </div>
                <div id="game-select-options"></div>
            </div>
            <div class="modal-footer">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
   <script>
        function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return str.replace(/[&<>"']/g, m => map[m]);
    }
            document.addEventListener('contextmenu', event => event.preventDefault());
 document.addEventListener('keydown', event => {
    if (event.key === 'F12' ||
         (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
         (event.ctrlKey && event.key.toUpperCase() === 'U')) {
       event.preventDefault();
     }
 });
 setInterval(() => { try { debugger; } catch (e) {} }, 1000);

    document.addEventListener('DOMContentLoaded', () => {
        const confirmExitModal = document.getElementById('confirm-exit-modal'); // ‚ú® Î™®Îã¨ ÏÑ†ÌÉù

        // ‚ú® [ÏàòÏ†ï] Î™®Î∞îÏùº Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäº: Ïù¥Ï†ú Î™®Îã¨ÏùÑ ÎùÑÏõÅÎãàÎã§.
        history.pushState(null, '', location.href);
        window.addEventListener('popstate', (e) => {
            history.pushState(null, '', location.href); // Îí§Î°úÍ∞ÄÍ∏∞ Î∞©ÏßÄÎäî Ïú†ÏßÄ
            showModal(confirmExitModal); // ‚ú® Î™®Îã¨ ÌëúÏãú Ìï®Ïàò ÏÇ¨Ïö©
        });
        // ‚ú® [ÏàòÏ†ï] ÎÅù

        const firebaseConfig = {
            apiKey: "AIzaSyCmNAKmgF_L3o0QyOGh_oFAq_rMRtUyklw",
            authDomain: "goodluck-7c14b.firebaseapp.com",
            databaseURL: "https://goodluck-7c14b-default-rtdb.firebaseio.com",
            projectId: "goodluck-7c14b",
            storageBucket: "goodluck-7c14b.appspot.com",
            messagingSenderId: "858281658455",
            appId: "1:858281658455:web:9131280a459be983933b12"
        };

 



        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const usersRef = db.ref('users');
        const roomsRef = db.ref('rooms');

        const myProfileBtn = document.getElementById('my-profile-btn');
        const myProfileAvatar = document.getElementById('my-profile-avatar');
        const myProfileNickname = document.getElementById('my-profile-nickname');
        const roomListContainer = document.getElementById('room-list-container');
        const createRoomBtn = document.getElementById('create-room-btn');
        
        const profileModal = document.getElementById('profile-dashboard-modal');
        const rankingModal = document.getElementById('ranking-modal');
        const gameSelectModal = document.getElementById('game-select-modal');
        const logoutBtn = document.getElementById('logout-btn');
        const clickSound = document.getElementById('click-sound');

        let currentUser, currentUserData, roomListener;

  const availableGames = [
            { id: 'alkkagi', name: 'ÏïåÍπåÍ∏∞', icon: '‚ö™', file: 'ÏïåÍπåÍ∏∞.html', maxPlayers: 2, color: '#8d6e63', canSolo: true },
            { id: 'bomber', name: 'ÌÅ¨Î†àÏù¥ÏßÄ Î¥ÑÎ≤Ñ', icon: 'üïπÔ∏è', file: 'Î¥ÑÎ≤ÑÎß®.html', maxPlayers: 4, color: '#f39c12', canSolo: false },
            { id: 'shisenSho', name: 'ÏÇ¨Ï≤úÏÑ±', icon: 'üÄÑ', file: 'ÏÇ¨Ï≤úÏÑ±.html', maxPlayers: 2, color: '#D32F2F', canSolo: false }, 
            { id: 'quiz', name: 'AI Ïä§ÌîºÎìúÌÄ¥Ï¶à', icon: '‚ùì', file: 'aiÌÄ¥Ï¶à.html', maxPlayers: 4, color: '#8E44AD', canSolo: true },
            { id: 'memoryGame', name: 'Î©îÎ™®Î¶¨', icon: 'üß†', file: 'Î©îÎ™®Î¶¨Í≤åÏûÑ.html', maxPlayers: 4, color: '#4CAF50', canSolo: false },
            { id: 'reversi', name: 'Î¶¨Î≤ÑÏãú', icon: '‚ö´', file: 'Î¶¨Î≤ÑÏãú.html', maxPlayers: 2, color: '#00897B', canSolo: true },
            { id: 'indianpoker', name: 'Ïù∏ÎîîÏñ∏Ìè¨Ïª§', icon: 'üÉè', file: 'Ïù∏ÎîîÏñ∏Ìè¨Ïª§.html', maxPlayers: 2, color: '#C9372C', canSolo: false },
            { id: 'candysoap', name: 'Ï∫îÎîîÏÜù', icon: 'üç¨', file: 'Ï∫îÎîîÏÜù.html', isSolo: true, color: '#FF69B4', canSolo: true },
            { id: 'linePuzzle', name: 'ÎùºÏù∏ ÌçºÏ¶ê', icon: 'üé®', file: 'ÎùºÏù∏ÌçºÏ¶ê.html', isSolo: true, color: '#3498DB', canSolo: true },
            { id: 'crossingKnights', name: 'ÌÅ¨Î°úÏã± ÎÇòÏù¥Ï∏†', icon: '‚ôû', file: 'ÌÅ¨Î°úÏã±ÎÇòÏù¥Ï∏†.html', maxPlayers: 2, color: '#4a4e69', canSolo: false }
        ];

               // ‚ú® [Ïã†Í∑ú] 4Î∞©Ìñ• ÏïÑÎ∞îÌÉÄ ÏÑ∏Ìä∏ Ï†ïÏùò (ÎåÄÍ∏∞Ïã§/ÏÉÅÏ†ê/Í≤åÏûÑÎ∞©ÏóêÏÑúÎäî front Ïù¥ÎØ∏ÏßÄÎßå ÏÇ¨Ïö©)
        const AVATAR_SETS = {
            'penguin_parka': { // Firebase profile/avatarÏóê Ï†ÄÏû•Îê† Í≥†Ïú† ID
                front: './ÏïÑÎ∞îÌÉÄÌè¥Îçî/Ìé≠Í∑ÑÏ†ïÎ©¥.png'
                // (Ïù¥ ÌååÏùºÏóêÏÑúÎäî frontÎßå ÌïÑÏöîÌï©ÎãàÎã§)
            },
            // ‚ú® [Ïã†Í∑ú] Í∞ïÏïÑÏßÄ ÏÑ∏Ìä∏ Ï∂îÍ∞Ä
            'puppy_set': { 
                front: './ÏïÑÎ∞îÌÉÄÌè¥Îçî/Í∞ïÏïÑÏßÄÏ†ïÎ©¥.png'
            }
        };

        function cleanupMyGhostRooms(myId) {
            roomsRef.once('value', snapshot => {
                if (!snapshot.exists()) return;

                snapshot.forEach(child => {
                    const room = { key: child.key, ...child.val() };
                    if (room.hostId === myId && room.status === 'playing') {
                        roomsRef.child(room.key).remove();
                        console.log(`Ïú†Î†πÎ∞© [${room.key}]ÏùÑ(Î•º) ÏÇ≠Ï†úÌñàÏäµÎãàÎã§.`);
                    }
                });
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                cleanupMyGhostRooms(user.uid);
                usersRef.child(user.uid).on('value', snapshot => {
                    if (snapshot.exists()) {
                        currentUserData = snapshot.val();
                        updateLobbyUI();
                        if (!roomListener) listenToRooms();
                    }
                });
            } else {
                window.location.replace('index.html');
            }
        });

        function updateLobbyUI() {
            if (!currentUserData || !currentUserData.profile) return;
            const profile = currentUserData.profile;
            const avatar = profile.avatar;

            // ‚ú® [ÏàòÏ†ï] 4Î∞©Ìñ• ÏïÑÎ∞îÌÉÄ ÏÑ∏Ìä∏(ID), Ïù¥ÎØ∏ÏßÄ, Ïù¥Î™®ÏßÄ ÏàúÏúºÎ°ú ÌôïÏù∏
            const avatarSet = AVATAR_SETS[avatar]; // Ïòà: 'penguin_parka'
            if (avatarSet) {
                myProfileAvatar.innerHTML = `<img src="${avatarSet.front}" alt="avatar">`;
            } else if (avatar.startsWith('http') || avatar.includes('.')) {
                myProfileAvatar.innerHTML = `<img src="${avatar}" alt="avatar">`;
            } else {
                myProfileAvatar.textContent = avatar;
            }
            myProfileNickname.textContent = profile.nickname;
            
            const myProfilePoints = document.getElementById('my-profile-points');
            myProfilePoints.textContent = `üí∞ ${(profile.points || 0).toLocaleString()} P`;
        }
        
        function listenToRooms() {
            if (roomListener) roomsRef.off('value', roomListener);
            
            roomListener = roomsRef.orderByChild('createdAt').limitToLast(30).on('value', snapshot => {
                roomListContainer.innerHTML = '';
                if (!snapshot.exists()) {
                    roomListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ÌôúÏÑ±ÌôîÎêú Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§.<br>ÏÉàÎ°úÏö¥ Î∞©ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>';
                    return;
                }
                const rooms = [];
                const now = Date.now();
                const oneHour = 60 * 60 * 1000;

                snapshot.forEach(child => {
                    const room = { key: child.key, ...child.val() };
                    if (!room.players || Object.keys(room.players).length === 0) {
                        roomsRef.child(room.key).remove(); 
                        return;
                    }
                    if (room.status === 'playing' && (now - room.createdAt > oneHour)) {
                        roomsRef.child(room.key).remove();
                        return;
                    }
                    rooms.push(room);
                });
                
                if (rooms.length === 0) {
                    roomListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ÌôúÏÑ±ÌôîÎêú Î∞©Ïù¥ ÏóÜÏäµÎãàÎã§.<br>ÏÉàÎ°úÏö¥ Î∞©ÏùÑ ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!</p>';
                    return;
                }

                rooms.reverse().forEach(room => {
                    const game = availableGames.find(g => g.id === room.gameType);
                    if (!game || !room.players) return;
                    
                    const playerCount = Object.keys(room.players).length;
                    const isFull = playerCount >= game.maxPlayers;
                    const isPlaying = room.status === 'playing';

                    const roomEl = document.createElement('div');
                    roomEl.className = 'room-item';
                    roomEl.innerHTML = `
                        <div class="room-info">
                            <h3>${escapeHTML(room.roomName)}</h3>
                            <p>${game.icon} ${game.name} | ${isPlaying ? 'Í≤åÏûÑÏ§ë' : 'ÎåÄÍ∏∞Ï§ë'} | ${playerCount}/${game.maxPlayers}</p>
                        </div>
                        <button class="menu-btn primary join-btn" ${isFull || isPlaying ? 'disabled' : ''}>Ï∞∏Í∞Ä</button>
                    `;
                    roomEl.querySelector('.join-btn').addEventListener('click', () => {
                        clickSound.play();
                        window.location.href = `Í≤åÏûÑÎ∞©.html?roomId=${room.key}`;
                    });
                    roomListContainer.appendChild(roomEl);
                });
            });
        }
        
        // ‚ñº‚ñº‚ñº [ÏàòÏ†ï] Î∞© ÎßåÎì§Í∏∞ Î≤ÑÌäº: Î™®Îã¨ÏùÑ Ïó¥Í≥† 'multi' ÌÉ≠ÏùÑ Í∏∞Î≥∏ÏúºÎ°ú Î†åÎçîÎßÅ ‚ñº‚ñº‚ñº
        createRoomBtn.addEventListener('click', () => { 
            clickSound.play(); 
            showModal(gameSelectModal, () => renderGameOptions('multi')); // 'multi'Î•º Í∏∞Î≥∏Í∞íÏúºÎ°ú
        });
        // ‚ñ≤‚ñ≤‚ñ≤ [ÏàòÏ†ï] Î∞© ÎßåÎì§Í∏∞ Î≤ÑÌäº ‚ñ≤‚ñ≤‚ñ≤

        document.getElementById('ranking-btn').addEventListener('click', () => { clickSound.play(); showModal(rankingModal, showRanking) });
        document.getElementById('shop-btn').addEventListener('click', () => { clickSound.play(); window.location.href = 'Ìè¨Ïù∏Ìä∏ÏÉÅÏ†ê.html'; });
        
        function showModal(modal, onShow) { 
            if (onShow) onShow();
            modal.classList.add('active'); 
        }
        function closeAllModals() { document.querySelectorAll('.overlay').forEach(m => m.classList.remove('active')); }

        document.querySelectorAll('[data-close]').forEach(btn => {
            btn.addEventListener('click', () => {
                clickSound.play();
                btn.closest('.overlay').classList.remove('active');
            });
        });

        myProfileBtn.addEventListener('click', () => {
            clickSound.play();
            if (!currentUserData) return;
            const profile = currentUserData.profile;
            const avatarEl = document.getElementById('profile-dashboard-avatar');
            // ‚ú® [ÏàòÏ†ï] 4Î∞©Ìñ• ÏïÑÎ∞îÌÉÄ ÏÑ∏Ìä∏(ID), Ïù¥ÎØ∏ÏßÄ, Ïù¥Î™®ÏßÄ ÏàúÏúºÎ°ú ÌôïÏù∏
            const avatarSet = AVATAR_SETS[profile.avatar];
            if (avatarSet) {
                avatarEl.innerHTML = `<img src="${avatarSet.front}" alt="avatar">`;
            } else if (profile.avatar.startsWith('http') || profile.avatar.includes('.')) {
                avatarEl.innerHTML = `<img src="${profile.avatar}" alt="avatar">`;
            } else {
                avatarEl.textContent = profile.avatar;
            }

            document.getElementById('profile-dashboard-nickname').textContent = profile.nickname;
            document.getElementById('profile-dashboard-level').textContent = profile.level || 1;
            document.getElementById('profile-points').textContent = profile.points || 0;
            
            showModal(profileModal);
        });

        // ‚ñº‚ñº‚ñº [ÏàòÏ†ï] Í≤åÏûÑ ÌÉ≠ Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
        document.querySelectorAll('.game-mode-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                clickSound.play();
                const mode = btn.dataset.mode;
                renderGameOptions(mode);
            });
        });

        // ‚ñº‚ñº‚ñº [ÏàòÏ†ï] Í≤åÏûÑ Î≤ÑÌäº ÏÉùÏÑ± Î°úÏßÅÏùÑ 'renderGameOptions' Ìï®ÏàòÎ°ú Î∂ÑÎ¶¨ ‚ñº‚ñº‚ñº
        const gameOptionsContainer = document.getElementById('game-select-options');

        function renderGameOptions(mode) {
            // 1. ÌÉ≠ ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.game-mode-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // 2. Í≤åÏûÑ Î™©Î°ù ÌïÑÌÑ∞ÎßÅ
            let gamesToShow;
            if (mode === 'multi') {
                gamesToShow = availableGames.filter(game => !game.isSolo);
            } else { // 'solo'
                gamesToShow = availableGames.filter(game => game.canSolo);
            }

            // 3. Î≤ÑÌäº Îã§Ïãú Í∑∏Î¶¨Í∏∞
            gameOptionsContainer.innerHTML = '';
            gamesToShow.forEach(game => {
                const btn = document.createElement('button');
                btn.className = 'game-select-btn';
                btn.style.backgroundColor = game.color + '20';
                btn.style.color = game.color;
                btn.innerHTML = `<span class="icon">${game.icon}</span><span>${game.name}</span>`;
                
                // 4. [ÌïµÏã¨] ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î≥ÄÍ≤Ω
                btn.onclick = () => {
                    clickSound.play();
                    // AI Ïä§ÌîºÎìú ÌÄ¥Ï¶àÎäî ÏÜîÎ°ú Î™®Îìú Ïãú Í≤åÏûÑÎ∞©ÏùÑ Í±∞Ï≥êÏïº Ï¥àÍ∏∞Ìôî Î°úÏßÅÏù¥ Ïã§ÌñâÎê®
                    if (game.id === 'quiz' && mode === 'solo') {
                        window.location.href = `Í≤åÏûÑÎ∞©.html?roomId=solo_quiz_temp&mode=solo`; // ‚ú® Í≤åÏûÑÎ∞©ÏùÑ Í≤ΩÏú†ÌïòÎèÑÎ°ù ÏàòÏ†ï
                    }
                    else if (mode === 'solo') {
                        // Îã§Î•∏ ÌòºÏûê ÌïòÍ∏∞Îäî Î∞îÎ°ú Í≤åÏûÑ ÌååÏùºÎ°ú Ïù¥Îèô
                        window.location.href = `${game.file}?mode=solo`;
                    } else {
                        // Í∞ôÏù¥ ÌïòÍ∏∞Îäî Î∞© ÏÉùÏÑ± (Í∏∞Ï°¥ Î°úÏßÅ)
                        createNewRoom(game.id);
                    }
                    closeAllModals();
                };
                gameOptionsContainer.appendChild(btn);
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ [ÏàòÏ†ï] Í≤åÏûÑ Î≤ÑÌäº ÏÉùÏÑ± Î°úÏßÅ ‚ñ≤‚ñ≤‚ñ≤


        function createNewRoom(gameId) {
            const newRoomRef = roomsRef.push();
            newRoomRef.set({
                roomName: `${currentUserData.profile.nickname}Ïùò Î∞©`,
                hostId: currentUser.uid,
                gameType: gameId,
                status: 'waiting',
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {
                    [currentUser.uid]: {
                        nickname: currentUserData.profile.nickname,
                        avatar: currentUserData.profile.avatar,
                        isHost: true
                    }
                }
            }).then(() => {
                window.location.href = `Í≤åÏûÑÎ∞©.html?roomId=${newRoomRef.key}`;
            });
        }
        
        function showRanking() {
            const rankingTabs = document.getElementById('ranking-tabs');
            rankingTabs.innerHTML = '';
            const gameTabs = [{ id: 'points', name: 'ÌÜµÌï© Îû≠ÌÇπ' }, ...availableGames.filter(g => !g.isSolo)];
            
            gameTabs.forEach((game, index) => {
                const tab = document.createElement('button');
                tab.className = 'tab-btn';
                tab.textContent = game.name;
                if (index === 0) tab.classList.add('active');
                tab.onclick = () => {
                    clickSound.play();
                    rankingTabs.querySelector('.active')?.classList.remove('active');
                    tab.classList.add('active');
                    loadRanking(game.id);
                };
                rankingTabs.appendChild(tab);
            });
            loadRanking('points');
        }

       // ‚ñº‚ñº‚ñº [ÏàòÏ†ï] AI ÌÄ¥Ï¶à Îû≠ÌÇπÏóê 'ÏµúÍ≥† Ï†êÏàò' Î∞òÏòÅ ‚ñº‚ñº‚ñº
        function loadRanking(gameId) {
            const rankingContent = document.getElementById('ranking-content');
            rankingContent.innerHTML = `<div class="spinner"></div>`;
            
            usersRef.once('value', snapshot => {
                let users = [];
                snapshot.forEach(child => {
                    const user = child.val();
                    if (user.profile?.nickname) { users.push(user); }
                });

                // [ÏàòÏ†ï] Ï†ïÎ†¨ Î°úÏßÅ Î∂ÑÍ∏∞
                if (gameId === 'points') {
                    // ÌÜµÌï© Îû≠ÌÇπ: Ìè¨Ïù∏Ìä∏ Í∏∞Ï§Ä Ï†ïÎ†¨
                    users.sort((a, b) => (b.profile.points || 0) - (a.profile.points || 0));
                } else if (gameId === 'quiz') {
                    // AI ÌÄ¥Ï¶à Îû≠ÌÇπ: ÏµúÍ≥† Ï†êÏàò(highscore) Í∏∞Ï§Ä Ï†ïÎ†¨
                    users = users.filter(user => user.gameStats?.quiz?.plays > 0); // 1Ìöå Ïù¥ÏÉÅ ÌîåÎ†àÏù¥ ÌïÑÌÑ∞ÎßÅ
                    users.sort((a, b) => (b.gameStats?.quiz?.highscore || 0) - (a.gameStats?.quiz?.highscore || 0));
                } else {
                    // ÎÇòÎ®∏ÏßÄ Í≤åÏûÑ Îû≠ÌÇπ: ÏäπÎ¶¨(wins) Í∏∞Ï§Ä Ï†ïÎ†¨
                    users = users.filter(user => user.gameStats?.[gameId]?.plays > 0); // 1Ìöå Ïù¥ÏÉÅ ÌîåÎ†àÏù¥ ÌïÑÌÑ∞ÎßÅ
                    users.sort((a, b) => (b.gameStats?.[gameId]?.wins || 0) - (a.gameStats?.[gameId]?.wins || 0));
                }

                rankingContent.innerHTML = '<div class="ranking-list"></div>';
                const rankingList = rankingContent.querySelector('.ranking-list');

                if (users.length === 0) {
                    rankingList.innerHTML = `<p style="text-align:center; color:#888; padding: 40px;">Îû≠ÌÇπ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>`;
                    return;
                }

                users.slice(0, 100).forEach((user, i) => {
                    const profile = user.profile;
                    const gameStats = user.gameStats;
                   // ‚ú® [ÏàòÏ†ï] 4Î∞©Ìñ• ÏïÑÎ∞îÌÉÄ ÏÑ∏Ìä∏(ID), Ïù¥ÎØ∏ÏßÄ, Ïù¥Î™®ÏßÄ ÏàúÏúºÎ°ú ÌôïÏù∏
                    const avatarSet = AVATAR_SETS[profile.avatar];
                    let avatarHTML = '';
                    if (avatarSet) {
                        avatarHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                    } else if (profile.avatar.startsWith('http') || profile.avatar.includes('.')) {
                        avatarHTML = `<img src="${profile.avatar}" alt="avatar">`;
                    } else {
                        avatarHTML = profile.avatar; // Ïù¥Î™®ÏßÄ
                    }
                    let statsHTML = '';

                    // [ÏàòÏ†ï] ÌëúÏãúÌï† Ïä§ÌÉØ Î∂ÑÍ∏∞
                    if (gameId === 'points') {
                        // ÌÜµÌï© Îû≠ÌÇπ Ïä§ÌÉØ
                        const totalWins = Object.values(gameStats || {}).reduce((sum, game) => sum + (game.wins || 0), 0);
                        const totalLosses = Object.values(gameStats || {}).reduce((sum, game) => sum + (game.losses || 0), 0);
                        // ‚ú® [Ï∂îÍ∞Ä] Ï¥ù ÌîåÎ†àÏù¥ Ïàò Î∞è Î¨¥ÏäπÎ∂Ä Í≥ÑÏÇ∞
                        const totalPlays = Object.values(gameStats || {}).reduce((sum, game) => sum + (game.plays || 0), 0);
                        const totalDraws = Math.max(0, totalPlays - (totalWins + totalLosses));
                        statsHTML = `
                            <div class="stat-item wins">${totalWins}Ïäπ</div>
                            <div class="stat-item losses">${totalLosses}Ìå®</div>
                            <div class="stat-item plays">${totalDraws}Î¨¥</div>
                            <div class="stat-item points">${(profile.points || 0).toLocaleString()} P</div>`;
                    } else if (gameId === 'quiz') {
                        // AI ÌÄ¥Ï¶à Ïä§ÌÉØ: ÏµúÍ≥† Ï†êÏàò Ìè¨Ìï®
                        const game = gameStats?.quiz || { wins: 0, losses: 0, plays: 0, highscore: 0 };
                        statsHTML = `
                            <div class="stat-item points">ÏµúÍ≥† ${game.highscore}Ï†ê</div>
                            <div class="stat-item wins">${game.wins}Ïäπ</div>
                            <div class="stat-item losses">${game.losses}Ìå®</div>
                            <div class="stat-item plays">${game.plays || 0}Ìöå</div>`;
                  } else {
                        // ‚ú® [ÏàòÏ†ï] ÎÇòÎ®∏ÏßÄ Í≤åÏûÑ Ïä§ÌÉØ (ÏÇ¨Ï≤úÏÑ± Ìè¨Ìï®)
                        const game = gameStats?.[gameId] || { wins: 0, losses: 0, draws: 0, plays: 0 }; // draws Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä

                        const wins = game.wins || 0;
                        const losses = game.losses || 0;
                        const plays = game.plays || 0;
                        // ‚ú® [ÏàòÏ†ï] Î¨¥ÏäπÎ∂Ä(draws) ÌïÑÎìúÎ•º ÏßÅÏ†ë ÏÇ¨Ïö©ÌïòÎèÑÎ°ù Î≥ÄÍ≤Ω (ÏÇ¨Ï≤úÏÑ±.htmlÍ≥º ÏùºÏπò)
                        const draws = game.draws || 0;
                        const winRate = plays > 0 ? ((wins / plays) * 100).toFixed(0) + '%' : '0%';

                        statsHTML = `
                            <div class="stat-item wins">${wins}Ïäπ</div>
                            <div class="stat-item losses">${losses}Ìå®</div>
                            <div class="stat-item plays">${draws}Î¨¥</div> <div class="stat-item winrate">${winRate}</div>`;
                    }
                    
                    const rankItem = document.createElement('div');
                    rankItem.className = 'rank-item';
                    rankItem.innerHTML = `
                        <div class="rank-col-rank">${i + 1}</div>
                        <div class="rank-col-profile">
                            <div class="rank-avatar">${avatarHTML}</div>
                            <div class="profile-text">
                                <div class="nickname">${escapeHTML(profile.nickname)}</div>
                                <div class="level">Lv. ${profile.level || 1}</div>
                            </div>
                        </div>
                        <div class="rank-col-stats">${statsHTML}</div>`;
                    rankingList.appendChild(rankItem);
                });
            });
        }
        // ‚ñ≤‚ñ≤‚ñ≤ [ÏàòÏ†ï] AI ÌÄ¥Ï¶à Îû≠ÌÇπÏóê 'ÏµúÍ≥† Ï†êÏàò' Î∞òÏòÅ ‚ñ≤‚ñ≤‚ñ≤

        logoutBtn.addEventListener('click', () => {
            clickSound.play();
            auth.signOut();
            closeAllModals();
        });

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
            return str.replace(/[&<>"']/g, m => map[m]);
        }
    });
    </script>
</body>
</html>