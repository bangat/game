<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>ëŒ€ê¸°ì‹¤</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff" as="font" type="font/woff" crossorigin>
    <style>
        :root {
            --bg-color: #FFFBEB; /* ë”°ëœ»í•œ í¬ë¦¼ìƒ‰ ë°°ê²½ */
            --primary-color: #FF6B6B; /* í™œê¸°ì°¬ ì½”ë„ìƒ‰ */
            --secondary-color: #4ECDC4; /* ìƒì¾Œí•œ í‹¸(teal)ìƒ‰ */
            --accent-color: #FFD93D; /* ë°ì€ ë…¸ë€ìƒ‰ */
            --text-color-dark: #574141; /* ì–´ë‘ìš´ ê°ˆìƒ‰ */
            --text-color-light: #ffffff;
            --danger-color: #F76363;
            --panel-bg: #FFFFFF;
            --panel-border: #F0EAD2; /* ì—°í•œ ë² ì´ì§€ìƒ‰ í…Œë‘ë¦¬ */
            --panel-shadow: #E4DCCF; /* íŒ¨ë„ ê·¸ë¦¼ì */
            --font-main: 'GmarketSans', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            -webkit-user-select: none; user-select: none;
            touch-action: manipulation;
        }
        .view {
            width: 100%; height: 100%; 
            overflow-x: hidden; /* í˜ì´ì§€ ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        .spinner {
            border: 5px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ------------------------- */
        /* == ì•„ì¼€ì´ë“œ ìŠ¤íƒ€ì¼ ë²„íŠ¼ == */
        /* ------------------------- */
        .menu-btn {
            width: 100%; padding: 16px; font-size: 1.25em; font-weight: 900;
            font-family: var(--font-main);
            border-radius: 16px; border: none; cursor: pointer;
            transition: all 0.1s ease-out;
            border-bottom: 5px solid; /* 3D íš¨ê³¼ë¥¼ ìœ„í•œ ì•„ë˜ìª½ í…Œë‘ë¦¬ */
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
            /* [ì¶”ê°€] <a> íƒœê·¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .menu-btn:active { transform: translateY(3px); border-bottom-width: 2px; }
        
        .menu-btn.primary {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border-bottom-color: #C04A4A;
        }

        .menu-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-color-light);
            border-bottom-color: #379A93;
        }
        .menu-btn.accent {
            background-color: var(--accent-color);
            color: var(--text-color-dark);
            border-bottom-color: #D1B030;
            text-shadow: none;
        }
         .menu-btn.light {
            background-color: #F8F9FA;
            color: var(--text-color-dark);
            border-bottom-color: #BDBDBD;
        }
        .menu-btn:disabled {
            background-color: #BDBDBD !important;
            color: #757575 !important;
            border-bottom-color: #8D8D8D !important;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ------------------------- */
        /* == ëŒ€ê¸°ì‹¤ ë ˆì´ì•„ì›ƒ == */
        /* ------------------------- */
        .lobby-panel {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
        }

        .lobby-header {
            width: 100%; padding: 10px 12px; flex-shrink: 0;
            background: #FFFAE0;
            border-bottom: 3px solid var(--panel-border);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 8px;
        }
        
        .header-actions {
            display: flex; gap: 5px; flex-shrink: 0;
            align-items: center; 
        }
        #my-profile-btn {
            display: flex; align-items: center; gap: 8px;
            background: none; border: none; cursor: pointer;
            padding: 5px; border-radius: 30px;
            transition: background-color 0.2s;
            min-width: 0;
        }
        #my-profile-btn:active { background-color: var(--panel-border); }

       #my-profile-avatar {
            width: 44px; height: 44px; font-size: 2.2em;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px;
            border: 3px solid var(--text-color-dark);
            background-color: var(--panel-bg);
            overflow: hidden;
            position: relative;
        }
        #my-profile-avatar img { width: 100%; height: 100%; object-fit: contain; }
        #my-profile-info { 
            text-align: left; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1px;
            min-width: 0;
            max-width: 120px;
        }
 
        #my-profile-nickname { font-weight: 700; font-size: 0.95em; }
        #my-profile-points {
            font-size: 0.85em; font-weight: 700; color: #9A6A3A;
            background-color: var(--accent-color);
            padding: 1px 6px; border-radius: 20px;
            border: 1px solid #D1B030;
            align-self: flex-start;
            white-space: nowrap;
        }
        

        #room-list-container {
            display: flex; flex-direction: column;
            flex-grow: 1; overflow-y: auto; padding: 0 12px 20px;
            min-height: 0;
            background: url('data:image/svg+xml,%3Csvg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63-21c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-54 56c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-5 15c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm34-50c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-22c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-44 14c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm22-22c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 87c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-11-12c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm-15 22c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z" fill="%23F0EAD2" fill-opacity="0.6" fill-rule="evenodd"/%3E%3C/svg%3E');
        }

        .room-item {
            display: flex; align-items: center; justify-content: space-between;
            background-color: var(--panel-bg);
            border: 3px solid var(--text-color-dark);
            border-radius: 20px; margin-bottom: 20px;
            padding: 15px;
            box-shadow: 6px 6px 0px 0px var(--panel-shadow);
            transition: all 0.1s;
        }
       .room-item:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px 0px var(--panel-shadow); }

        .room-info { flex-grow: 1; min-width: 0; }
        .room-info h3 {
            font-size: 1.15em; margin-bottom: 6px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .room-info p {
            font-size: 0.85em; color: #555; font-weight: 700;
        }
        .room-status {
            display: flex; flex-direction: column; align-items: center;
            flex-shrink: 0; margin-left: 10px;
            background: #FFF8E1; padding: 5px 10px; border-radius: 12px;
            border: 2px solid var(--panel-border);
        }
        .room-status span { font-size: 1.2em; font-weight: 900; }
        .room-status small { font-size: 0.8em; }

        .join-btn {
            flex-shrink: 0; padding: 10px 16px; font-size: 1.0em;
            max-width: 90px;
            margin-left: 15px;
            border-radius: 12px; border-bottom-width: 4px;
        }

        /* ------------------------- */
        /* == ì ‘ì† ì¸ì› ì¹´ìš´í„° (ë§í¬) == */
        /* ------------------------- */
        .header-user-count {
            display: flex;
            align-items: center;
            height: 38px;
            padding: 0 15px;
            font-size: 0.85em;
            font-weight: 700;
            color: var(--text-color-dark);
            background-color: #FFF8E1; 
            border: 3px solid var(--panel-border); 
            border-radius: 16px;
            margin: 10px 12px 10px; 
            width: calc(100% - 24px);
            box-shadow: 2px 2px 0px 0px var(--panel-shadow);
            cursor: pointer; 
            transition: background-color 0.2s;
            /* [ì‹ ê·œ] <a> íƒœê·¸ ìŠ¤íƒ€ì¼ */
            text-decoration: none;
        }
         .header-user-count:active { 
            background-color: var(--panel-border);
        } 
        .header-user-count strong {
            color: var(--primary-color);
            font-size: 1.2em;
            margin-right: 5px;
        }

        /* ------------------------- */
        /* == í—¤ë” ì•¡ì…˜ ë²„íŠ¼ (ë§í¬) == */
        /* ------------------------- */
        .header-btn .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.65em;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .header-btn {
            position: relative;
            width: 44px; height: 44px;
            font-size: 1.5em;
            display: flex; justify-content: center; align-items: center;
            border-radius: 16px;
            border: 3px solid var(--text-color-dark);
            padding: 0;
            box-shadow: 4px 4px 0px 0px var(--panel-shadow);
            transition: all 0.1s;
            border-bottom-width: 4px;
            text-decoration: none;
        }
        /* [ì‹ ê·œ] ë²„íŠ¼ë³„ ìƒ‰ìƒ ë° ë§í¬ ìŠ¤íƒ€ì¼ */
        #friend-btn {
            background-color: var(--primary-color);
            color: var(--text-color-light);
            border-bottom-color: #C04A4A;
        }
        #ranking-btn {
            background-color: var(--secondary-color);
            color: var(--text-color-light);
            border-bottom-color: #379A93;
        }
        #shop-btn {
            background-color: var(--accent-color);
            color: var(--text-color-dark);
            border-bottom-color: #D1B030;
        }
        
        .header-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        /* ------------------------- */
        /* == ëŒ€ê¸°ì‹¤ ì±„íŒ… == */
        /* ------------------------- */
       #lobby-chat-container {
            width: 100%;
            flex-grow: 1;
            min-height: 0;
            flex-shrink: 0;
            display: none;
            flex-direction: column;
            background-color: var(--bg-color);
            border-top: 3px solid var(--panel-border);
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 15px;
            display: flex;
            flex-direction: column-reverse;
        }
        .chat-message {
            margin-bottom: 8px;
            max-width: 90%;
            align-self: flex-start;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .chat-message.my-message {
            align-self: flex-end;
        }
        
        .chat-content {
            padding: 6px 12px;
            border-radius: 12px;
            background-color: var(--bg-color);
            border: 2px solid var(--panel-border);
            word-wrap: break-word;
        }
        .chat-content.my-message {
            background-color: var(--accent-color);
            border-color: #D1B030;
        }
        .chat-content strong {
            color: var(--primary-color);
            margin-right: 5px;
        }
        .chat-content.my-message strong {
            color: #9A6A3A;
        }

        #chat-input-area {
            display: flex;
            padding: 10px;
            border-top: 3px solid var(--panel-border);
            gap: 8px;
        }
        #chat-input {
            flex-grow: 1;
            border: 2px solid var(--text-color-dark);
            border-radius: 12px;
            padding: 12px;
            font-size: 1em;
            font-family: var(--font-main);
            min-width: 0;
        }
        #chat-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        #chat-send-btn {
            flex-shrink: 0;
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1em;
            padding: 0 20px;
            border: none; border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            border-bottom: 4px solid #C04A4A;
            cursor: pointer;
        }
        #chat-send-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        
        .chat-date-divider {
            font-size: 0.8em;
            font-weight: 700;
            color: #9A6A3A;
            text-align: center;
            margin: 15px 0 10px;
            padding: 4px 10px;
            border-radius: 12px;
            background-color: #FFFAE0;
            border: 2px dashed var(--panel-border);
            width: 80%;
            align-self: center;
        }

        .chat-time {
            font-size: 0.75em;
            color: #888;
            flex-shrink: 0;
            margin-bottom: 2px;
        }
        
        /* ------------------------- */
        /* == í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ë°” == */
        /* ------------------------- */
        #lobby-bottom-actions {
            width: 100%;
            display: flex;
            gap: 10px;
            padding: 15px;
            flex-shrink: 0;
            background-color: #FFFAE0;
            border-top: 3px solid var(--panel-border);
        }
        #lobby-bottom-actions .menu-btn {
            font-size: 1.1em;
            padding: 14px;
        }
        #toggle-chat-btn { flex: 1; }
        #create-room-btn { flex: 2; }

        /* ------------------------- */
        /* == ì±„íŒ… í† ê¸€ ë¡œì§ == */
        /* ------------------------- */
        .lobby-panel.chat-active #lobby-chat-container {
            display: flex;
        }
        .lobby-panel.chat-active #room-list-container {
            display: none;
        }

        /* ------------------------- */
        /* == ëª¨ë‹¬ ê³µí†µ ìŠ¤íƒ€ì¼ == */
        /* ------------------------- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }
        
        .modal-content {
            background: var(--panel-bg);
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%; max-width: 420px;
            overflow: hidden;
            border: 4px solid var(--text-color-dark);
            box-shadow: 8px 8px 0px 0px var(--text-color-dark);
        }
        .modal-header {
            padding: 15px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-bottom: 4px solid #379A93;
        }
        /* [ì¶”ê°€] ë’¤ë¡œê°€ê¸° ë²„íŠ¼(ëª¨ë‹¬) */
        .back-btn {
            background: none; border: none; color: white;
            font-size: 2.5em; cursor: pointer; padding: 0 10px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            text-decoration: none;
        }

        .modal-body { padding: 15px; max-height: 70vh; overflow-y: auto;}
        
        .modal-footer {
            display: flex; gap: 10px; padding: 0 25px 25px;
            background-color: #F8F9FA;
            padding: 20px;
            border-top: 3px solid var(--panel-border);
        }
        .modal-footer .menu-btn { margin: 0; font-size: 1.1em; }
        #game-select-modal .modal-footer {
            display: none;
        }
        #game-select-modal .modal-content {
            max-width: 95vw;
        }

        /* ------------------------- */
        /* == í”„ë¡œí•„ ëª¨ë‹¬ == */
        /* ------------------------- */
        #profile-dashboard-header {
            display: flex; align-items: center; gap: 20px; padding-bottom: 20px;
            justify-content: center; text-align: center; flex-direction: column;
        }
        #profile-dashboard-avatar {
            font-size: 4em; width: 80px; height: 80px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; border: 4px solid var(--text-color-dark);
            background: var(--bg-color);
            overflow: hidden;
        }
        #profile-dashboard-avatar img { width: 100%; height: 100%; object-fit: contain; }
        #profile-dashboard-nickname { font-size: 1.6em; }
        #profile-dashboard-header p {
            font-size: 1.1em; font-weight: 700;
            background-color: var(--accent-color);
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #D1B030;
        }
        #profile-menu-buttons {
            display: flex; flex-direction: column; gap: 12px;
            padding-top: 20px; border-top: 2px dashed var(--panel-border);
        }
        #logout-btn {
            background-color: var(--danger-color);
            border-bottom-color: #A94442;
       }

        /* ------------------------- */
        /* == í† ìŠ¤íŠ¸ ì•Œë¦¼ == */
        /* ------------------------- */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            pointer-events: none;
        }
        .toast-message {
            background-color: rgba(40, 40, 40, 0.85);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 700;
            animation: toast-fade 3s ease-out forwards;
        }
        @keyframes toast-fade {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* ------------------------- */
        /* == ê²Œì„ ì„¤ì • ëª¨ë‹¬ (í† ê¸€) == */
        /* ------------------------- */
        .settings-list {
            list-style: none;
            padding: 10px 0;
        }
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 2px dashed var(--panel-border);
        }
        .setting-item:last-child {
            border-bottom: none;
        }
        .setting-label {
            font-size: 1.1em;
            font-weight: 700;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--secondary-color);
        }
        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* ------------------------- */
        /* == ì•„ë°”íƒ€ ì„ íƒ ëª¨ë‹¬ == */
        /* ------------------------- */
        #avatar-select-modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }
        #avatar-select-grid-wrapper {
            margin-top: 1rem;
            border: 2px solid var(--panel-border);
            border-radius: 0.5rem;
            padding: 10px;
            margin-bottom: 1rem;
        }
        #avatar-select-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .char-option {
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease-in-out;
            background-color: #f8f9fa;
            padding: 2px;
        }
        .char-option img {
            width: 90%;
            height: 90%;
            object-fit: contain;
        }
        .char-option.selected {
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--accent-color);
        }

        
        .game-mode-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: transparent;
        }
            
        /* [ì‹ ê·œ] ê²Œì„ ì•„ì´ì½˜ ìƒ‰ìƒ í´ë˜ìŠ¤ */
        .game-list-icon.game-alkkagi { background-color: #8d6e63; }
        .game-list-icon.game-bomber { background-color: #f39c12; }
        .game-list-icon.game-shisenSho { background-color: #D32F2F; }
        .game-list-icon.game-quiz { background-color: #8E44AD; }
        .game-list-icon.game-memoryGame { background-color: #4CAF50; }
        .game-list-icon.game-reversi { background-color: #00897B; }
        .game-list-icon.game-indianpoker { background-color: #C9372C; }
        .game-list-icon.game-candysoap { background-color: #FF69B4; }
        .game-list-icon.game-linePuzzle { background-color: #3498DB; }
        .game-list-icon.game-crossingKnights { background-color: #4a4e69; }
        .game-list-icon.game-tetris { background-color: #2980b9; }
        
        .game-list-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            background-color: #F8F9FA;
            border-radius: 12px;
            border: 2px solid var(--panel-border);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .game-list-item:active {
            background-color: #E9ECEF;
            border-color: #DDD;
        }

        .game-list-icon {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4em;
            color: white;
            background-color: #ccc;
        }

        .game-list-info {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .game-list-name {
            font-size: 0.95em;
            font-weight: 900;
            color: var(--text-color-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-list-desc {
            font-size: 0.8em;
            font-weight: 700;
            color: #777;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-list-arrow {
            flex-shrink: 0;
            font-size: 1.6em;
            font-weight: 300;
            color: #AAA;
        }
        
        /* ------------------------- */
        /* == ì¢…ë£Œ í™•ì¸ ëª¨ë‹¬ == */
        /* ------------------------- */
        #confirm-exit-modal .modal-body {
            padding: 35px 25px; text-align: center;
        }
        #confirm-exit-modal h3 {
            font-size: 1.5em; margin-bottom: 15px; font-weight: 900;
        }
        #confirm-exit-modal .modal-footer {
            background-color: #F8F9FA;
        }
        #exit-confirm-btn {
            background-color: var(--danger-color);
            border-bottom-color: #A94442;
        }

        /* ------------------------- */
        /* == ì…ì¥ ì´í™íŠ¸ ìŠ¤íƒ€ì¼ == */
        /* ------------------------- */
        .entry-effect-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        @keyframes teal-pulse-anim {
            0%, 100% {
                box-shadow: 0 0 10px 2px var(--secondary-color), inset 0 0 10px 2px var(--secondary-color);
                opacity: 0.6;
            }
            50% {
                box-shadow: 0 0 15px 5px var(--secondary-color), inset 0 0 15px 5px var(--secondary-color);
                opacity: 1;
            }
        }
        .effect-sparkle-persistent {
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            animation: teal-pulse-anim 2.5s ease-in-out infinite; 
            z-index: 10;
        }
        @keyframes star-fall {
            0% { transform: translateY(-20px); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(50px); opacity: 0; }
        }
        .effect-spotlight-persistent {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
            z-index: 5;
        }
        .effect-spotlight-persistent::before {
            content: ''; position: absolute; top: 0; left: 50%;
            width: 2px; height: 2px; background: #FFF; border-radius: 50%;
            box-shadow: -20px 10px #FFF, 15px 25px #FFF, 0px 40px #FFF, -10px 55px #FFF, 25px 5px #FFF, -5px 30px #FFF;
            animation: star-fall 1.5s linear infinite;
            animation-delay: -0.5s;
        }
        .effect-spotlight-persistent::after {
            content: ''; position: absolute; top: 0; left: 50%;
            width: 2px; height: 2px; background: #FFF; border-radius: 50%;
            box-shadow: 10px 18px #FFF, -15px 35px #FFF, 5px 50px #FFF, -25px 8px #FFF, 20px 22px #FFF, -8px 42px #FFF;
            animation: star-fall 2.5s linear infinite;
        }
        #my-profile-avatar.effect-spotlight-equipped-bg {
            background-color: #341f4b;
            transition: background-color 0.5s ease;
        }
 
        /* ------------------------- */
        /* == ê²Œì„ ì„ íƒ ëª¨ë‹¬ (ëª¨ë°”ì¼ ìµœì í™”) == */
        /* ------------------------- */
        #game-select-modal .modal-content {
            max-width: 95vw;
        }

        #game-select-modal .modal-header {
            padding: 15px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-bottom: 4px solid #379A93;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }

        #game-select-modal .modal-header h2 {
            font-size: 1.25em;
            margin: 0;
            color: white;
            text-align: center;
            flex-grow: 1;
        }

        #game-select-modal .back-btn {
            color: white;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 0 10px;
        }

        #game-select-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            max-height: 60vh;
            overflow-y: auto;
        }

        #game-mode-tabs {
            display: flex;
            gap: 6px;
            padding: 10px 12px; /* [ì¶”ê°€] ì—¬ë°± */
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--panel-border);
            flex-shrink: 0;
        }

        .game-mode-tab-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.9em;
            font-weight: 700;
            border-radius: 10px;
            border: 2px solid var(--panel-border);
            background: white;
            color: #888;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .game-mode-tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
        }

        #game-select-options {
            flex-grow: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-content: start;
        }

       /* ------------------------- */
        /* == í‚¤íŒ¨ë“œ ì»¤ìŠ¤í…€ ëª¨ë‹¬ == */
        /* ------------------------- */
        #keypad-preview-area {
            position: relative;
            width: 100%;
            height: 163px; /* [ìˆ˜ì •] 170px -> 150px */
            background-color: #222;
            background-image: linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border-bottom: 3px solid var(--panel-border);
            overflow: hidden; /* ë²„íŠ¼ì´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ */
        }
        #tetris-keypad-clone {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        /* --- [ì‹ ê·œ] í…ŒíŠ¸ë¦¬ìŠ¤ ë²„íŠ¼ CSS (ëŒ€ê¸°ì‹¤ìš©) --- */
        /* (í…ŒíŠ¸ë¦¬ìŠ¤.htmlì—ì„œ ë ˆì´ì•„ì›ƒ ë¶€ë¶„ë§Œ ê°€ì ¸ì˜´) */
        #keypad-custom-modal .touch-btn {
            width: clamp(55px, 15vw, 75px); /* [ìˆ˜ì •] 70px -> 75px */
            height: clamp(55px, 15vw, 75px); /* [ìˆ˜ì •] 70px -> 75px */
            display: flex; justify-content: center; align-items: center;
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            font-weight: bold; color: var(--text-color-light);
            background: rgba(255, 107, 107, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            
            /* [ì‹ ê·œ] ê°œë³„ ë“œë˜ê·¸ë¥¼ ìœ„í•´ position: absolute ì¶”ê°€ */
            position: absolute;
            cursor: move;
            touch-action: none; /* ë“œë˜ê·¸ ì¤‘ í™”ë©´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            z-index: 10;
        }
        /* [ì‹ ê·œ] 'ê¸°ë³¸' ëª¨ë“œì²˜ëŸ¼ íŠ¹ì • ë²„íŠ¼ë§Œ ë„“ê²Œ ì„¤ì • */
        #keypad-custom-modal .pos-down,
        #keypad-custom-modal .pos-drop {
            /* (ê¸°ë³¸ ë²„íŠ¼ ë„ˆë¹„ * 2) + ê¸°ë³¸ ëª¨ë“œì˜ ì—´ ê°„ê²©(25px) */
            width: calc( (clamp(55px, 15vw, 75px) * 2) + 25px );
        }
        
        /* [ì‚­ì œ] .keypad-cluster ê´€ë ¨ CSSëŠ” ëª¨ë‹¬ì—ì„œ ëª¨ë‘ ì œê±° */

        /* [ì‹ ê·œ] game-mode-tabsê°€ ì„¸íŒ… ëª¨ë‹¬ì—ì„œë„ ì˜ ë³´ì´ê²Œ */
        #game-settings-modal .game-mode-tabs {
            display: flex;
            gap: 6px;
            width: 100%;
        }
        #game-settings-modal .game-mode-tab-btn {
            flex: 1;
            padding: 10px;
            font-size: 1em;
            font-weight: 700;
            border-radius: 10px;
            border: 2px solid var(--panel-border);
            background: white;
            color: #888;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        #game-settings-modal .game-mode-tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        #game-mode-tabs {
            padding-top: 10px !important; /* [ìˆ˜ì •] */
            padding-bottom: 10px !important; /* [ìˆ˜ì •] */
        }

        /* === [ì‹ ê·œ] 2ë§Œ í¬ì¸íŠ¸ í”„ë¦¬ë¯¸ì—„ ë ˆì¸ë³´ìš° ìŠ¤í‚¨ === */

/* 1. ë¬´ì§€ê°œ ìƒ‰ìƒ íë¦„ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes premium-rainbow-flow {
    0% { border-color: #ff0000; box-shadow: 0 0 10px #ff0000, inset 0 0 5px #ff0000; }
    15% { border-color: #ff7300; box-shadow: 0 0 15px #ff7300, inset 0 0 5px #ff7300; }
    30% { border-color: #fffb00; box-shadow: 0 0 10px #fffb00, inset 0 0 5px #fffb00; }
    45% { border-color: #48ff00; box-shadow: 0 0 15px #48ff00, inset 0 0 5px #48ff00; }
    60% { border-color: #00ffd5; box-shadow: 0 0 10px #00ffd5, inset 0 0 5px #00ffd5; }
    75% { border-color: #002bff; box-shadow: 0 0 15px #002bff, inset 0 0 5px #002bff; }
    90% { border-color: #7a00ff; box-shadow: 0 0 10px #7a00ff, inset 0 0 5px #7a00ff; }
    100% { border-color: #ff009d; box-shadow: 0 0 15px #ff009d, inset 0 0 5px #ff009d; }
}

/* 2. íŒŒí‹°í´(ë°˜ì§ì„) íš¨ê³¼ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes sparkle-pop {
    0% { transform: scale(0.8); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(0.8); opacity: 0.5; }
}

/* 3. ë§í’ì„  ë³¸ì²´ ìŠ¤íƒ€ì¼ */
.bubble_rainbow_premium {
    background-color: #FFFFFF !important; /* ë°°ê²½ì€ ê¹”ë”í•˜ê²Œ í°ìƒ‰ */
    color: #333 !important;
    font-weight: 900 !important; /* ê¸€ì ë‘ê»ê²Œ */
    border: 3px solid #ff0000 !important; /* ì´ˆê¸° ìƒ‰ìƒ */
    border-radius: 12px !important;
    position: relative !important;
    overflow: visible !important; /* íŒŒí‹°í´ì´ ë°–ìœ¼ë¡œ íŠ€ì–´ë‚˜ì˜¤ê²Œ */
    
    /* ì• ë‹ˆë©”ì´ì…˜ ì ìš© (0.5ì´ˆë§ˆë‹¤ ìƒ‰ìƒ ë³€ê²½ - ë§¤ìš° ë¹ ë¥´ê³  í™”ë ¤í•¨) */
    animation: premium-rainbow-flow 3s linear infinite alternate !important;
}

/* 4. ìºì¹˜ë§ˆì¸ë“œ ë¨¸ë¦¬ ìœ„ ë§í’ì„  ê¼¬ë¦¬ ìƒ‰ìƒ (íˆ¬ëª… ì²˜ë¦¬ ë˜ëŠ” ìƒ‰ìƒ ë”°ë¼ê°€ê¸°) */
.speech-bubble-item.bubble_rainbow_premium::after { border-top-color: transparent !important; }
.speech-bubble-item.bubble_rainbow_premium::before { border-top-color: transparent !important; }

/* 5. ê²Œì„ë°©(ëŒ€ê¸°ì‹¤) ì±„íŒ…ì°½ í…Œë‘ë¦¬ ì ìš© */
.content.bubble_rainbow_premium {
    border-width: 3px !important;
}

/* 6. (ì˜µì…˜) ë§í’ì„  ì£¼ë³€ì— ë°˜ì§ì´ ì¶”ê°€ (ê°€ìƒ ìš”ì†Œ í™œìš©) */
.bubble_rainbow_premium::before {
    content: 'âœ¨';
    position: absolute;
    top: -8px; right: -8px;
    font-size: 1.2em;
    animation: sparkle-pop 0.8s infinite;
    z-index: 10;
}
.bubble_rainbow_premium::after {
    content: 'âœ¨';
    position: absolute;
    bottom: -8px; left: -8px;
    font-size: 0.8em;
    animation: sparkle-pop 1.2s infinite reverse;
    z-index: 10;
}

    </style>
</head>
<body>
    <div id="toast-container"></div>
    <audio id="click-sound" src="./ë´„ë²„ë§¨ì‚¬ìš´ë“œ/ë²„íŠ¼í´ë¦­.mp3" preload="auto"></audio>
    <audio id="invite-sound" src="./ë´„ë²„ë§¨ì‚¬ìš´ë“œ/ì´ˆëŒ€ì•Œë¦¼.mp3" preload="auto"></audio>
    <div id="lobby-view" class="view">
        <div class="lobby-panel">
            <div class="lobby-header">
                <button id="my-profile-btn">
                    <span id="my-profile-avatar"></span>
                    <div id="my-profile-info">
                        <span id="my-profile-nickname">...</span>
                        <span id="my-profile-points"></span>
                    </div>
                </button>
                <div class="header-actions">
                    <a href="ì¹œêµ¬.html" id="friend-btn" class="header-btn primary">ğŸ‘¥</a>
                    <a href="ë­í‚¹.html" id="ranking-btn" class="header-btn secondary">ğŸ†</a>
                    <a href="í¬ì¸íŠ¸ìƒì .html" id="shop-btn" class="header-btn accent">ğŸ’</a>
                </div>
            </div>
            <a href="ì¹œêµ¬.html" id="concurrent-users" class="header-user-count" style="text-decoration: none;">
                <strong>0</strong>ëª… ì ‘ì†
            </a>
            <div id="room-list-container">
                <div class="spinner"></div>
                <div id="room-list-wrapper"></div>
            </div>
            <div id="lobby-chat-container">
                <div id="chat-messages"></div>
                <div id="chat-input-area">
                    <input type="text" id="chat-input" placeholder="ì±„íŒ…ì„ ì…ë ¥í•˜ì„¸ìš”.. ">
                    <button id="chat-send-btn">ì „ì†¡</button>
                </div>
            </div>

            <div id="lobby-bottom-actions">
                <button id="toggle-chat-btn" class="menu-btn secondary">ğŸ’¬ ì±„íŒ…</button>
                <button id="create-room-btn" class="menu-btn primary">â• ë°© ë§Œë“¤ê¸°</button>
            </div>
        </div>
    </div>

    <div id="profile-dashboard-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>ë‚´ ì •ë³´</h2></div>
            <div class="modal-body">
                <div id="profile-dashboard-header">
                    <span id="profile-dashboard-avatar"></span>
                    <div>
                        <h3 id="profile-dashboard-nickname"></h3>
                        <p>Lv. <span id="profile-dashboard-level">1</span> (<span id="profile-points">0</span> P)</p>
                    </div>
                </div>
                <div id="profile-menu-buttons">
                    <button id="open-avatar-select-btn" class="menu-btn secondary">í”„ë¡œí•„ ì„¤ì •</button>
                    <button id="open-settings-btn" class="menu-btn secondary">ê²Œì„ ì„¤ì •</button>
                </div>
            </div>
            <div class="modal-footer">
                <button id="logout-btn" class="menu-btn secondary" style="background-color: var(--danger-color); color: white;">ë¡œê·¸ì•„ì›ƒ</button>
                <button class="menu-btn secondary" data-close>ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="avatar-select-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>í”„ë¡œí•„ ì„¤ì •</h2></div>
            <div class="modal-body">
                <p style="text-align: center; font-weight: 700;">ë³€ê²½í•  ì•„ë°”íƒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                <div id="avatar-select-grid-wrapper">
                    <div id="avatar-select-grid">
                        <div class="spinner" style="margin: 20px auto; grid-column: 1 / -1;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="menu-btn light" data-close>ì·¨ì†Œ</button>
                <button id="save-avatar-btn" class="menu-btn secondary">ë³€ê²½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="game-settings-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>ê²Œì„ ì„¤ì •</h2></div>
            <div class="modal-body">
                <ul class="settings-list">

                    <li class="setting-item" style="flex-direction: column; align-items: flex-start;">
                            <span class="setting-label" style="margin-bottom: 10px;">ğŸ® í…ŒíŠ¸ë¦¬ìŠ¤ í‚¤íŒ¨ë“œ</span>
                            <div id="keypad-layout-selector" class="game-mode-tabs" style="width:100%;">
                                <button class="game-mode-tab-btn active" data-layout="default">ê¸°ë³¸</button>
                                <button class="game-mode-tab-btn" data-layout="custom">ì»¤ìŠ¤í…€</button>
                            </div>
                        </li>
                        <li class="setting-item">
                            <span class="setting-label">ğŸ”§ ì»¤ìŠ¤í…€ ë ˆì´ì•„ì›ƒ</span>
                            <button id="open-keypad-custom-btn" class="menu-btn secondary" style="font-size: 0.9em; padding: 8px 12px; border-bottom-width: 3px; max-width: 120px;">ì„¤ì •í•˜ê¸°</button>
                        </li>

                    <li class="setting-item">
                        <span class="setting-label">ğŸ”” íš¨ê³¼ìŒ</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="sfx-toggle">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li class="setting-item">
                        <span class="setting-label">ğŸµ ë°°ê²½ìŒì•…</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="bgm-toggle">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li class="setting-item">
                        <span class="setting-label">ğŸ“³ ì§„ë™</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="vibration-toggle">
                            <span class="slider"></span>
                        </label>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="menu-btn light" data-close style="width: 100%;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <div id="confirm-exit-modal" class="overlay">
         <div class="modal-content" style="max-width: 350px;">
             <div class="modal-body" style="padding: 30px; text-align: center;">
                 <h3 style="font-size: 1.4em; margin-bottom: 15px;">ê²Œì„ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
             </div>
             <div class="modal-footer" style="padding: 20px;">
                 <button class="menu-btn secondary" data-close>ì·¨ì†Œ</button>
                 <button id="exit-confirm-btn" class="menu-btn primary" style="background-color: var(--danger-color);">í™•ì¸</button>
             </div>
         </div>
    </div>


     <div id="game-select-modal" class="overlay">
         <div class="modal-content">
             <div class="modal-header">
                 <button class="back-btn" data-close>â€¹</button>
                 <h2>ê²Œì„ ì„ íƒ</h2>
             </div>
             <div class="modal-body">
                 <div id="game-mode-tabs">
                     <button class="game-mode-tab-btn active" data-mode="multi">ê°™ì´ í•˜ê¸°</button>
                     <button class="game-mode-tab-btn" data-mode="solo">í˜¼ì í•˜ê¸°</button>
                 </div>
                 <div id="game-select-options"></div>
             </div>
             <div class="modal-footer">
             </div>
         </div>
     </div>
     
    <div id="message-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header">
                <button class="back-btn" data-close>â€¹</button>
                <h2 id="message-modal-nickname">...</h2>
                <div style="width: 40px;"></div>
            </div>
            <div class="modal-body">
                <div id="message-history">
                    <div class="spinner" style="margin: 20px auto;"></div>
                </div>
                <div id="message-input-area">
                    <input type="text" id="message-input" placeholder="ìª½ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="message-send-btn">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script src="ì•„ë°”íƒ€.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        // --- í—¬í¼ í•¨ìˆ˜ ---
        function showToast(message, duration = 3000, onClickCallback = null) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;

            let toastTimer = setTimeout(() => {
                toast.style.animation = 'toast-fade-out 0.5s ease-out forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, duration - 500);

            // [ì‹ ê·œ] í´ë¦­ ì½œë°± ê¸°ëŠ¥ ì¶”ê°€
            if (onClickCallback) {
                toast.style.cursor = 'pointer';
                toast.onclick = () => {
                    clearTimeout(toastTimer); // ìë™ì‚­ì œ íƒ€ì´ë¨¸ ì·¨ì†Œ
                    onClickCallback(); // í´ë¦­ ì‹œ ì½œë°± ì‹¤í–‰
                    
                    // ì¦‰ì‹œ í˜ì´ë“œì•„ì›ƒ
                    toast.style.animation = 'toast-fade-out 0.5s ease-out forwards';
                    toast.addEventListener('animationend', () => toast.remove());
                };
            }

            container.appendChild(toast);
            return toast; // toast DOM ìš”ì†Œë¥¼ ë°˜í™˜
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const formattedHours = (hours % 12) || 12;
            return `${ampm} ${formattedHours}:${minutes}`;
        }

        document.addEventListener('contextmenu', event => event.preventDefault());
        
        document.addEventListener('keydown', event => {
            if (event.key === 'F12' ||
                (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
                (event.ctrlKey && event.key.toUpperCase() === 'U')) {
            event.preventDefault();
            }
        });
        setInterval(() => { try { debugger; } catch (e) {} }, 1000);

        const defaultSettings = { sfx: true, bgm: true, vibration: true };
        let gameSettings = JSON.parse(localStorage.getItem('gameSettings')) || defaultSettings;
        localStorage.setItem('gameSettings', JSON.stringify(gameSettings));


        document.addEventListener('DOMContentLoaded', () => {
            const confirmExitModal = document.getElementById('confirm-exit-modal');
            
            // [ìˆ˜ì •] PWA ì„¤ì¹˜ ìœ ë„ ë¡œì§ (ëŒ€ê¸°ì‹¤ìš© - ê²½í•© ì¡°ê±´ í•´ê²°)
            try {
                const pwaModal = document.getElementById('pwa-install-modal');
                const pwaConfirmBtn = document.getElementById('pwa-install-confirm-btn');
                const pwaLaterBtn = document.getElementById('pwa-install-later-btn');

                // [ìˆ˜ì •] PWA ì„¤ì¹˜ ë²„íŠ¼ì„ 'ì¤€ë¹„ì¤‘...'ìœ¼ë¡œ ë¹„í™œì„±í™”
                pwaConfirmBtn.disabled = true;
                pwaConfirmBtn.textContent = 'ì¤€ë¹„ì¤‘...';

                // [ìˆ˜ì •] PWAê°€ ì•„ë‹ˆê³ , ë‹«ì€ ì  ì—†ìœ¼ë©´ ëª¨ë‹¬ì„ "ì¦‰ì‹œ" í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
                const showPwaModal = () => {
                    const isStandalone = window.matchMedia('(display-mode: fullscreen)').matches || window.navigator.standalone || localStorage.getItem('pwaInstalled') === 'true';
                    // âœ… PWAê°€ "ì•„ë‹ˆê³ "(!isStandalone), ë‹«ì€ ì ë„ ì—†ì„ ë•Œë§Œ ëª¨ë‹¬ í‘œì‹œ
                    if (!isStandalone && sessionStorage.getItem('pwaModalDismissed') !== 'true') {
                        console.log('ëŒ€ê¸°ì‹¤: PWA ì„¤ì¹˜ ê°€ëŠ¥, ëª¨ë‹¬ í‘œì‹œ.');
                        pwaModal.classList.add('active');
                    } else {
                        console.log(`ëŒ€ê¸°ì‹¤: PWA ëª¨ë‹¬ í‘œì‹œ ì•ˆ í•¨ (isStandalone: ${isStandalone})`);
                    }
                };

                // [ìˆ˜ì •] 1. PWAê°€ ì•„ë‹ˆë©´ "ì¦‰ì‹œ" ëª¨ë‹¬ í‘œì‹œ (ë²„íŠ¼ì€ ë¹„í™œì„±í™” ìƒíƒœ)
                showPwaModal();

                // [ìˆ˜ì •] 2. promptê°€ ì´ë¯¸ ì¤€ë¹„ë˜ì—ˆë‹¤ë©´ (index.htmlì—ì„œ ë„˜ì–´ì˜´) ë²„íŠ¼ í™œì„±í™”
                if (window.deferredPrompt) {
                    pwaConfirmBtn.disabled = false;
                    pwaConfirmBtn.textContent = 'ì„¤ì¹˜';
                }

                // [ìˆ˜ì •] 3. index.htmlì—ì„œ ë¯¸ì²˜ ì¡ì§€ ëª»í•˜ê³  ëŠ¦ê²Œ ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•´,
                // ëŒ€ê¸°ì‹¤ì—ì„œë„ 'beforeinstallprompt' ì´ë²¤íŠ¸ë¥¼ ìˆ˜ì‹  ëŒ€ê¸°í•©ë‹ˆë‹¤.
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    window.deferredPrompt = e; // [ìˆ˜ì •] ì´ë²¤íŠ¸ë¥¼ ì „ì—­ì— ì €ì¥
                    console.log('ëŒ€ê¸°ì‹¤: PWA ì„¤ì¹˜ ê°€ëŠ¥(beforeinstallprompt) ê°ì§€ë¨.');
                    
                    // [ì‹ ê·œ] ì„¤ì¹˜ê°€ ê°€ëŠ¥í•´ì¡Œìœ¼ë¯€ë¡œ ë²„íŠ¼ í™œì„±í™”
                    pwaConfirmBtn.disabled = false;
                    pwaConfirmBtn.textContent = 'ì„¤ì¹˜';
                    
                    // [ì‹ ê·œ] ëª¨ë‹¬ì´ ë‹«í˜€ìˆì—ˆë‹¤ë©´ ë‹¤ì‹œ ë„ì›€
                    showPwaModal();
                });

                // 4. ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
                pwaConfirmBtn.addEventListener('click', async () => {
                    if (gameSettings.sfx) clickSound.play();
                    const prompt = window.deferredPrompt;
                    if (!prompt) {
                        pwaModal.classList.remove('active');
                        return;
                    }
                    
                    prompt.prompt();
                    const { outcome } = await prompt.userChoice;
                    console.log(`PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê²°ê³¼: ${outcome}`);
                    
                    window.deferredPrompt = null;
                    pwaModal.classList.remove('active');
                    sessionStorage.setItem('pwaModalDismissed', 'true');
                });

                pwaLaterBtn.addEventListener('click', () => {
                    if (gameSettings.sfx) clickSound.play();
                    pwaModal.classList.remove('active');
                    sessionStorage.setItem('pwaModalDismissed', 'true');
                });

            } catch (e) {
                console.error('PWA ëª¨ë‹¬ ë¡œì§ (ëŒ€ê¸°ì‹¤) ì˜¤ë¥˜:', e);
            }
            // [ìˆ˜ì •] PWA ì„¤ì¹˜ ë¡œì§ ë

            let presenceTimeout = null;
            let myPresenceRef = null;

            document.addEventListener('visibilitychange', () => {
                if (!myPresenceRef) return;
                if (document.visibilityState === 'hidden') {
                    console.log('[Presence] ì•± ìˆ¨ê¹€. 5ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ íƒ€ì´ë¨¸ ì‹œì‘.');
                    if (presenceTimeout) clearTimeout(presenceTimeout);
                    presenceTimeout = setTimeout(() => {
                        console.log('[Presence] 5ë¶„ ê²½ê³¼. ìˆ˜ë™ìœ¼ë¡œ ì ‘ì† ìƒíƒœ ì œê±°.');
                        myPresenceRef.remove();
                        myPresenceRef.onDisconnect().cancel();
                    }, 300000);
                } else if (document.visibilityState === 'visible') {
                    console.log('[Presence] ì•± í™œì„±í™”. ìë™ ë¡œê·¸ì•„ì›ƒ íƒ€ì´ë¨¸ ì·¨ì†Œ.');
                    if (presenceTimeout) {
                        clearTimeout(presenceTimeout);
                        presenceTimeout = null;
                    }
                    myPresenceRef.set(true);
                    myPresenceRef.onDisconnect().remove();
                }
            });

            history.pushState(null, '', location.href);
            window.addEventListener('popstate', (e) => {
                history.pushState(null, '', location.href);
                showModal(confirmExitModal);
            });

            document.getElementById('exit-confirm-btn').addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                if (currentUser) {
                    presenceRef.child(currentUser.uid).remove();
                }
                auth.signOut().then(() => {
                    window.location.replace('index.html');
                });
            });

            const firebaseConfig = {
                apiKey: "AIzaSyCmNAKmgF_L3o0QyOGh_oFAq_rMRtUyklw",
                authDomain: "goodluck-7c14b.firebaseapp.com",
                databaseURL: "https://goodluck-7c14b-default-rtdb.firebaseio.com",
                projectId: "goodluck-7c14b",
                storageBucket: "goodluck-7c14b.appspot.com",
                messagingSenderId: "858281658455",
                appId: "1:858281658455:web:9131280a459be983933b12"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
            const usersRef = db.ref('users');
            const roomsRef = db.ref('rooms');
            const lobbyChatRef = db.ref('lobby-chat');
            const presenceRef = db.ref('status');

            const myProfileBtn = document.getElementById('my-profile-btn');
            const myProfileAvatar = document.getElementById('my-profile-avatar');
            const myProfileNickname = document.getElementById('my-profile-nickname');
            const roomListContainer = document.getElementById('room-list-container');
            const createRoomBtn = document.getElementById('create-room-btn');
            
            const profileModal = document.getElementById('profile-dashboard-modal');
            const gameSelectModal = document.getElementById('game-select-modal');
            const logoutBtn = document.getElementById('logout-btn');
            const clickSound = document.getElementById('click-sound');

            const avatarSelectModal = document.getElementById('avatar-select-modal');
            const openAvatarSelectBtn = document.getElementById('open-avatar-select-btn');
            const saveAvatarBtn = document.getElementById('save-avatar-btn');
            const avatarSelectGrid = document.getElementById('avatar-select-grid');

            const gameSettingsModal = document.getElementById('game-settings-modal');
            const openSettingsBtn = document.getElementById('open-settings-btn');

            const sfxToggle = document.getElementById('sfx-toggle');
            const bgmToggle = document.getElementById('bgm-toggle');
            const vibrationToggle = document.getElementById('vibration-toggle');

            // [ì‹ ê·œ] ì´ˆëŒ€ ìˆ˜ì‹  ëª¨ë‹¬
            const inviteReceivedModal = document.getElementById('invite-received-modal');
            const inviteModalTitle = document.getElementById('invite-modal-title');
            const inviteModalMessage = document.getElementById('invite-modal-message');
            const inviteAcceptBtn = document.getElementById('invite-accept-btn');
            const inviteDeclineBtn = document.getElementById('invite-decline-btn');
const inviteSound = document.getElementById('invite-sound');
          // --- [ìˆ˜ì •] í…ŒíŠ¸ë¦¬ìŠ¤ í‚¤íŒ¨ë“œ ì»¤ìŠ¤í…€ UI (ê°œë³„ ë²„íŠ¼ + ê²¹ì¹¨ ë²„ê·¸ ìˆ˜ì •) ---
            const keypadLayoutSelector = document.getElementById('keypad-layout-selector');
            const openKeypadCustomBtn = document.getElementById('open-keypad-custom-btn');
            const keypadCustomModal = document.getElementById('keypad-custom-modal');
            const saveKeypadBtn = document.getElementById('save-keypad-btn');
            const resetKeypadBtn = document.getElementById('reset-keypad-btn');
            const keypadPreviewArea = document.getElementById('keypad-preview-area');
            const draggableButtons = document.querySelectorAll('#keypad-preview-area .draggable-btn'); 
            const tetrisKeypadSettingsKey = 'tetrisKeypadSettings';
            
            const defaultKeypadPositions = {
                btnDown: { x: 14, y: 70 },
                btnLeft: { x: 5, y: 40 },
                btnRight: { x: 25, y: 40 },
                btnHold: { x: 55, y: 40 },
                btnRotate: { x: 75, y: 40 },
                btnDrop: { x: 65, y: 70 }
            };

            let tetrisKeypadSettings = {
                layout: 'default',
                custom: JSON.parse(JSON.stringify(defaultKeypadPositions)) 
            };

            let activeButton = null; 
            let dragOffsetX = 0;
            let dragOffsetY = 0;

            function onDragStart(e) {
                if (gameSettings.sfx) clickSound.play();
                activeButton = this; 
                activeButton.style.zIndex = 20;
                
                const touch = e.type === 'touchstart' ? e.touches[0] : e;
                const buttonRect = activeButton.getBoundingClientRect(); 
                
                dragOffsetX = touch.clientX - buttonRect.left;
                dragOffsetY = touch.clientY - buttonRect.top;
            }

            function onDragMove(e) {
                if (!activeButton) return; 
                e.preventDefault(); 

                const touch = e.type === 'touchmove' ? e.touches[0] : e;
                const previewRect = keypadPreviewArea.getBoundingClientRect();
                
                let x = touch.clientX - previewRect.left - dragOffsetX;
                let y = touch.clientY - previewRect.top - dragOffsetY;

                x = Math.max(0, Math.min(x, previewRect.width - activeButton.offsetWidth));
                y = Math.max(0, Math.min(y, previewRect.height - activeButton.offsetHeight));

                activeButton.style.left = `${x}px`;
                activeButton.style.top = `${y}px`;
            }

            function onDragEnd(e) {
                if (!activeButton) return; 
                activeButton.style.zIndex = 10;
                
                const previewRect = keypadPreviewArea.getBoundingClientRect();
                const buttonId = activeButton.dataset.key; 
                
                const currentX = parseFloat(activeButton.style.left);
                const currentY = parseFloat(activeButton.style.top);
                
                const xPercent = (currentX / previewRect.width) * 100;
                const yPercent = (currentY / previewRect.height) * 100;

                tetrisKeypadSettings.custom[buttonId] = { x: xPercent, y: yPercent };
                
                activeButton = null; 
            }

            draggableButtons.forEach(btn => { 
                btn.addEventListener('mousedown', onDragStart);
                btn.addEventListener('touchstart', onDragStart, { passive: false });
            });
            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('touchmove', onDragMove, { passive: false });
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchend', onDragEnd);
            
            function loadTetrisKeypadSettings() {
                const saved = localStorage.getItem(tetrisKeypadSettingsKey);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.custom && parsed.custom.btnLeft && typeof parsed.custom.btnLeft.x === 'number') {
                             tetrisKeypadSettings = parsed;
                        } else {
                            localStorage.removeItem(tetrisKeypadSettingsKey);
                        }
                    } catch(e) { 
                        console.error("í‚¤íŒ¨ë“œ ì„¤ì • ë¡œë“œ ì‹¤íŒ¨", e); 
                        localStorage.removeItem(tetrisKeypadSettingsKey);
                    }
                }
            }
            
            function saveTetrisKeypadSettings() {
                localStorage.setItem(tetrisKeypadSettingsKey, JSON.stringify(tetrisKeypadSettings));
                showToast('í‚¤íŒ¨ë“œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            function updateKeypadSelectorUI() {
                document.querySelectorAll('#keypad-layout-selector .game-mode-tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.layout === tetrisKeypadSettings.layout);
                });
            }
            
            function applyCustomLayoutToPreview() {
                loadTetrisKeypadSettings(); // [ìˆ˜ì •] ì €ì¥ëœ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
                
                const previewRect = keypadPreviewArea.getBoundingClientRect();
                
                // [ìˆ˜ì •] showModalì´ ë Œë”ë§ì„ ë³´ì¥í•˜ë¯€ë¡œ,
                // 0ì¸ì§€ ì²´í¬í•˜ëŠ” rAF ë£¨í”„ë¥¼ ì œê±°í•©ë‹ˆë‹¤.

                draggableButtons.forEach(btn => {
                    const key = btn.dataset.key;
                    const pos = (tetrisKeypadSettings.custom && tetrisKeypadSettings.custom[key]) 
                                ? tetrisKeypadSettings.custom[key] 
                                : defaultKeypadPositions[key];
                    
                    btn.style.left = `${(pos.x / 100) * previewRect.width}px`;
                    btn.style.top = `${(pos.y / 100) * previewRect.height}px`;
                });
            }

            keypadLayoutSelector.addEventListener('click', (e) => {
                if (e.target.classList.contains('game-mode-tab-btn')) {
                    if (gameSettings.sfx) clickSound.play();
                    const layout = e.target.dataset.layout;
                    tetrisKeypadSettings.layout = layout;
                    updateKeypadSelectorUI();
                    saveTetrisKeypadSettings();
                }
            });

            openKeypadCustomBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                
                showModal(keypadCustomModal, () => {
                    // [ìˆ˜ì •] ë Œë”ë§ ëŒ€ê¸° í›„ ì¢Œí‘œ ì ìš© (ê²¹ì¹¨ ë²„ê·¸ ìˆ˜ì •)
                    function waitForRenderAndApply() {
                        const previewRect = keypadPreviewArea.getBoundingClientRect();
                        if (previewRect.width > 0) {
                            applyCustomLayoutToPreview();
                        } else {
                            requestAnimationFrame(waitForRenderAndApply);
                        }
                    }
                    requestAnimationFrame(waitForRenderAndApply);
                });
            });

            saveKeypadBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                saveTetrisKeypadSettings();
                closeAllModals();
                showModal(gameSettingsModal);
            });
            
            resetKeypadBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                tetrisKeypadSettings.custom = JSON.parse(JSON.stringify(defaultKeypadPositions));
                applyCustomLayoutToPreview();
                showToast('í‚¤íŒ¨ë“œ ìœ„ì¹˜ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.');
            });

            const chatMessagesContainer = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');
            
            // [ì‹ ê·œ] ìª½ì§€ ëª¨ë‹¬ (íŒì—…ìš©)
            const messageModal = document.getElementById('message-modal');

            let currentUser, currentUserData, roomListener, lastMessageDate = null;
            let myFriendIds = {};
            
            // [ìˆ˜ì •] ì•Œë¦¼ í†µí•© ê´€ë¦¬ë¥¼ ìœ„í•œ ë³€ìˆ˜
            let friendRequestRef, messageInboxRef;
            let currentRequestCount = 0;
            let currentMessageCount = 0;
            let lastMessageTimestamp = 0;
            let currentFriendRequests = {};
            let isFirstRequestLoad = true;
            
            // [ì‹ ê·œ] ì´ˆëŒ€ ë¦¬ìŠ¤ë„ˆ
            let currentInvitationRef = null;
            let currentInvitationData = null; // ìˆ˜ë½/ê±°ì ˆ ì‹œ ì‚¬ìš©í•  ë°ì´í„°

            // [ìˆ˜ì •] ìª½ì§€ ê´€ë ¨ ë³€ìˆ˜ (íŒì—…ìš©)
            let currentMessagesRef = null;
            let currentMessageListener = null;
            let messagesLoaded = false;
            
            let selectedAvatarForChange = '';
            let myEquippedEffect = null;

             const availableGames = [
                 { id: 'tetris', name: 'í…ŒíŠ¸ë¦¬ìŠ¤', icon: 'ğŸ§±', file: 'í…ŒíŠ¸ë¦¬ìŠ¤.html', maxPlayers: 2, canSolo: true },
                 { id: 'shisenSho', name: 'ì‚¬ì²œì„±', icon: 'ğŸ€„', file: 'ì‚¬ì²œì„±.html', maxPlayers: 4, canSolo: true }, 
               { id: 'candysoap', name: 'ì• ë‹ˆíŒ¡', icon: 'ğŸ¬', file: 'ì• ë‹ˆíŒ¡.html', maxPlayers: 6,canSolo: true},
               { id: 'waterSort', name: 'ì›Œí„° í¼ì¦', icon: 'ğŸ§ª', file: 'ì›Œí„°í¼ì¦.html', maxPlayers: 4, canSolo: true },
                { id: 'catchmind', name: 'ìºì¹˜ë§ˆì¸ë“œ', icon: 'ğŸ¨', file: 'ìºì¹˜ë§ˆì¸ë“œ.html', maxPlayers: 6, canSolo: false },
              { id: 'alkkagi', name: 'ì•Œê¹Œê¸°', icon: 'âšª', file: 'ì•Œê¹Œê¸°.html', maxPlayers: 2, canSolo: true },
                 { id: 'bomber', name: 'í¬ë ˆì´ì§€ë´„ë²„', icon: 'ğŸ•¹ï¸', file: 'ë´„ë²„ë§¨.html', maxPlayers: 4, canSolo: false },
                 { id: 'quiz', name: 'AIìŠ¤í”¼ë“œí€´ì¦ˆ', icon: 'â“', file: 'aií€´ì¦ˆ.html', maxPlayers: 4, canSolo: true },
                          { id: 'bubbleshooter', name: 'ë²„ë¸”íŒ¡', icon: 'ğŸ”®', file: 'ë²„ë¸”íŒ¡.html', maxPlayers: 4 },
                { id: 'memoryGame', name: 'ë©”ëª¨ë¦¬ê²Œì„', icon: 'ğŸ§ ', file: 'ë©”ëª¨ë¦¬ê²Œì„.html', maxPlayers: 4, canSolo: false },
                { id: 'reversi', name: 'ë¦¬ë²„ì‹œ', icon: 'âš«', file: 'ë¦¬ë²„ì‹œ.html', maxPlayers: 2, canSolo: true },
                { id: 'indianpoker', name: 'ì¸ë””ì–¸í¬ì»¤', icon: 'ğŸƒ', file: 'ì¸ë””ì–¸í¬ì»¤.html', maxPlayers: 2, canSolo: false },
                { id: 'linePuzzle', name: 'ë¼ì¸ í¼ì¦', icon: 'ğŸ¨', file: 'ë¼ì¸í¼ì¦.html', isSolo: true, canSolo: true }
            ];

            function cleanupMyGhostRooms(myId) {
                roomsRef.orderByChild('hostId').equalTo(myId).once('value', snapshot => {
                    if (!snapshot.exists()) return;
                    console.log(`[ìœ ë ¹ë°© ì •ë¦¬] ${snapshot.numChildren()}ê°œì˜ ë‚´ ë°©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.`);
                    snapshot.forEach(child => {
                        const room = { key: child.key, ...child.val() };
                        roomsRef.child(room.key).remove();
                        console.log(`[ìœ ë ¹ë°© ì •ë¦¬] ${room.roomName} (ìƒíƒœ: ${room.status}) ë°©ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
                    });
                });
            }

            // [ìˆ˜ì •] í†µí•© ë±ƒì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            function updateTotalBadge() {
                const friendBtn = document.getElementById('friend-btn'); // <a> íƒœê·¸
                if (!friendBtn) return;
                
                // [ìˆ˜ì •] ì¹œêµ¬ ìš”ì²­ + ìª½ì§€ ê°œìˆ˜ í•©ì‚°
                const totalCount = currentRequestCount + currentMessageCount; 
                
                const badgeEl = friendBtn.querySelector('.badge');
                if (totalCount > 0) {
                    if (badgeEl) {
                        badgeEl.textContent = totalCount > 9 ? '9+' : totalCount;
                    } else {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge';
                        newBadge.textContent = totalCount > 9 ? '9+' : totalCount;
                        friendBtn.appendChild(newBadge);
                    }
                } else {
                    if (badgeEl) {
                        badgeEl.remove();
                    }
                }
            }


            auth.onAuthStateChanged(user => {
                if (user) {
                    
                    // [ìˆ˜ì •] 1. (ì´ˆëŒ€ì¥) "URL" ë˜ëŠ” "sessionStorage"ì—ì„œ roomIdë¥¼ í™•ì¸
                    const urlParams = new URLSearchParams(window.location.search);
                    const urlRoomId = urlParams.get('roomId');
                    // (index.htmlì—ì„œ ë¡œê·¸ì¸í•œ ê²½ìš° sessionStorageì— ì €ì¥ë¨)
                    const sessionRoomId = sessionStorage.getItem('invitedRoomId');
                    
                    const invitedRoomId = urlRoomId || sessionRoomId; // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì…ì¥

                    if (invitedRoomId) {
                        // 2. (ì´ˆëŒ€ì¥) roomIdê°€ ìˆìœ¼ë©´, "ì¦‰ì‹œ" ê²Œì„ë°©ìœ¼ë¡œ ì´ë™
                        console.log(`[ì´ˆëŒ€ì¥] ${invitedRoomId} ë°©ìœ¼ë¡œ ì¦‰ì‹œ ì´ë™í•©ë‹ˆë‹¤.`);
                        
                        // [ì¤‘ìš”] ì‚¬ìš©í–ˆìœ¼ë¯€ë¡œ sessionStorageì—ì„œ ì‚­ì œ
                        sessionStorage.removeItem('invitedRoomId'); 
                        
                        // [ì¤‘ìš”] URLì— ìˆë˜ roomId=... íŒŒë¼ë¯¸í„°ë¥¼ ì •ë¦¬í•˜ê³  ì´ë™
                        history.replaceState(null, '', 'ëŒ€ê¸°ì‹¤.html'); // URLì—ì„œ roomId ì œê±°
                        window.location.replace(`ê²Œì„ë°©.html?roomId=${invitedRoomId}`);
                        return; // [ì¤‘ìš”] auth ë¦¬ìŠ¤ë„ˆì˜ ë‚˜ë¨¸ì§€ ë¡œì§(ëŒ€ê¸°ì‹¤ í‘œì‹œ)ì„ ì¤‘ë‹¨
                    }
                    
                    // 3. (ê¸°ì¡´ ë¡œì§) ì´ˆëŒ€ì¥ì´ ì—†ì„ ë•Œë§Œ ëŒ€ê¸°ì‹¤ ë¡œì§ ì‹¤í–‰
                    myPresenceRef = presenceRef.child(user.uid);
                    myPresenceRef.set(true);
                    myPresenceRef.onDisconnect().remove();

                    presenceRef.on('value', snapshot => {
                        const userCount = snapshot.numChildren();
                        updateConcurrentUsers(userCount);
                    });

                    // [ìˆ˜ì •] 4. (index.htmlì—ì„œ ì´ë™ë¨) DBì—ì„œ í”„ë¡œí•„ì„ ì½ê³  localStorageì— ì €ì¥
                    currentUser = user;
                    cleanupMyGhostRooms(user.uid);
                    usersRef.child(user.uid).on('value', snapshot => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            myFriendIds = currentUserData.friends || {};

                            // [ì‹ ê·œ] localStorage ì„¤ì • (index.htmlì—ì„œ ì´ë™)
                            localStorage.setItem('myPlayerId', user.uid);
                            localStorage.setItem('userNickname', currentUserData.profile.nickname);
                            localStorage.setItem('userAvatar', currentUserData.profile.avatar);
                            
                            updateLobbyUI();
                            if (!roomListener) listenToRooms();
                            checkDailyLogin(user.uid, currentUserData.profile);
                            listenToLobbyChat();
                            
                            // [ìˆ˜ì •] ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆëŠ” ì—¬ê¸°ì„œ(í”„ë¡œí•„ ë¡œë“œ í›„) í˜¸ì¶œ
                            listenToNotifications(user.uid);
                        } else {
                            // [ì‹ ê·œ] DBì— í”„ë¡œí•„ì´ ì—†ëŠ” ë¹„ì •ìƒì  ìƒí™©
                            console.error("ì¸ì¦ì€ ë˜ì—ˆìœ¼ë‚˜ DBì— í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì•„ì›ƒí•©ë‹ˆë‹¤.");
                            auth.signOut(); // (auth.signOut()ì€ onAuthStateChangedë¥¼ ë‹¤ì‹œ í˜¸ì¶œ)
                        }
                    });
                } else {
                    window.location.replace('index.html');
                }
            });

           // [ìˆ˜ì •] ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ (ë±ƒì§€ ë° í† ìŠ¤íŠ¸)
            function listenToNotifications(uid) {
                // 1. ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
                if (friendRequestRef) friendRequestRef.off();
                if (messageInboxRef) messageInboxRef.off();
                if (currentInvitationRef) currentInvitationRef.off(); // [ì¶”ê°€]
                
                // [ì‹ ê·œ] ë±ƒì§€ìš© ë¦¬ìŠ¤ë„ˆ ì°¸ì¡°
                let friendBadgeRef = db.ref(`friend_requests/${uid}`);
                let messageBadgeRef = db.ref(`user_inboxes/${uid}`);

                // --- 1. ì¹œêµ¬ ìš”ì²­ ---
                // 1.1 ë±ƒì§€ìš© ë¦¬ìŠ¤ë„ˆ: 'value'ë¡œ í•­ìƒ ìµœì‹  ê°œìˆ˜ ë°˜ì˜
                friendRequestRef = friendBadgeRef.on('value', (snapshot) => {
                    currentRequestCount = snapshot.numChildren();
                    updateTotalBadge();
                });

                // 1.2 í† ìŠ¤íŠ¸ìš© ë¦¬ìŠ¤ë„ˆ: 'once'ë¡œ ì´ˆê¸°ê°’ ì„¤ì • í›„ 'child_added'ë¡œ ìƒˆ ìš”ì²­ ê°ì§€
                friendBadgeRef.once('value', (snapshot) => {
                    currentFriendRequests = snapshot.val() || {};
                    
                    // ì´ˆê¸° ë¡œë“œ í›„ "ìƒˆë¡œ ì¶”ê°€ë˜ëŠ”" ìš”ì²­ë§Œ ê°ì§€
                    friendBadgeRef.on('child_added', async (childSnap) => {
                        const newUid = childSnap.key;
                        if (!currentFriendRequests[newUid]) { // ì´ì „ì— ì—†ë˜ ìš”ì²­ì´ë©´
                            currentFriendRequests[newUid] = childSnap.val(); // ë¡œì»¬ ìºì‹œ ê°±ì‹ 
                            try {
                                const profileSnap = await usersRef.child(newUid).child('profile').once('value');
                                if (profileSnap.exists()) {
                                    showToast(`ğŸ’Œ ${escapeHTML(profileSnap.val().nickname)}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`);
                                }
                            } catch (e) { console.error(e); }
                        }
                    });
                });


                // --- 2. ìª½ì§€ ---
                // 2.1 ë±ƒì§€ìš© ë¦¬ìŠ¤ë„ˆ: 'value'ë¡œ í•­ìƒ ìµœì‹  ê°œìˆ˜ ë°˜ì˜
                messageInboxRef = messageBadgeRef.on('value', (snapshot) => {
                    currentMessageCount = snapshot.numChildren();
                    updateTotalBadge();
                });

                // 2.2 í† ìŠ¤íŠ¸ìš© ë¦¬ìŠ¤ë„ˆ: 'once'ë¡œ ë§ˆì§€ë§‰ íƒ€ì„ìŠ¤íƒ¬í”„ ì„¤ì • í›„ 'child_added' / 'child_changed' ê°ì§€
                messageBadgeRef.orderByChild('timestamp').limitToLast(1).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        snapshot.forEach(child => { // 1ê°œë§Œ ë°˜í™˜ë¨
                            lastMessageTimestamp = child.val().timestamp;
                        });
                    }

                    // [ìˆ˜ì •] ì´ì „ì— ì €ì¥ëœ lastMessageTimestamp "ë³´ë‹¤ 1ì´ë¼ë„ í°" ìƒˆ ë©”ì‹œì§€ë§Œ ê°ì§€
                    const startTimestamp = lastMessageTimestamp + 1;
                    
                    // ìƒˆ ëŒ€í™”(child_added) ê°ì§€
                    messageBadgeRef.orderByChild('timestamp').startAt(startTimestamp).on('child_added', (snap) => {
                        lastMessageTimestamp = snap.val().timestamp; // íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹ 
                        handleNewMessageAlert(snap.key, snap.val());
                    });
                    
                    // ê¸°ì¡´ ëŒ€í™”(child_changed) ê°ì§€
                    messageBadgeRef.orderByChild('timestamp').startAt(startTimestamp).on('child_changed', (snap) => {
                        lastMessageTimestamp = snap.val().timestamp; // íƒ€ì„ìŠ¤íƒ¬í”„ ê°±ì‹ 
                        handleNewMessageAlert(snap.key, snap.val());
                    });
                });

                // --- 3. [ì‹ ê·œ] ê²Œì„ ì´ˆëŒ€ ë¦¬ìŠ¤ë„ˆ ---
                currentInvitationRef = db.ref(`invitations/${uid}`);
                currentInvitationRef.on('child_added', (snapshot) => {
                    // ì´ë¯¸ ë‹¤ë¥¸ ì´ˆëŒ€ê°€ ì™€ìˆìœ¼ë©´ ë¬´ì‹œ (ê°„ë‹¨í•˜ê²Œ)
                    if (inviteReceivedModal.classList.contains('active')) return;

                    const inviteData = snapshot.val();
                    if (!inviteData) return;
                    
                    // ì´ˆëŒ€ ë°ì´í„° ì €ì¥
                    currentInvitationData = { key: snapshot.key, ...inviteData };

                    // ëª¨ë‹¬ ë‚´ìš© ì„¤ì •
                    inviteModalTitle.textContent = `ğŸ”” ${escapeHTML(inviteData.from_name)}ë‹˜ì˜ ì´ˆëŒ€ì¥`; // [ìˆ˜ì •]
                    // [ìˆ˜ì •] ë©˜íŠ¸ ìˆ˜ì • ë° (ë°© ì´ë¦„) ì œê±°
                    inviteModalMessage.innerHTML = `
                        <strong style="color: var(--primary-color); font-size: 1.1em;">${escapeHTML(inviteData.from_name)}</strong>ë‹˜ì´ 
                        <strong style="color: var(--secondary-color); font-size: 1.1em;">'${escapeHTML(inviteData.game_name)}'</strong> ê²Œì„ì— ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.<br>
                        ì°¸ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    `;
                    
                    // ëª¨ë‹¬ í‘œì‹œ
                    showModal(inviteReceivedModal);
                    
                    // [ìˆ˜ì •] íš¨ê³¼ìŒ ë³€ê²½
                    if (gameSettings.sfx && inviteSound) inviteSound.play();
                });
            }

           // [ìˆ˜ì •] ìƒˆ ìª½ì§€ í† ìŠ¤íŠ¸ ì•Œë¦¼ í•¸ë“¤ëŸ¬
            async function handleNewMessageAlert(senderUid, messageData) {
                // [ìˆ˜ì •] messageDataê°€ nullì¼ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ë°©ì–´ ì½”ë“œ
                if (!senderUid || !messageData || !messageData.lastMessage) return;


                if (messageModal.classList.contains('active') && messageModal.dataset.chattingWith === senderUid) {
                    return; 
                }

                try {
                    const profileSnap = await usersRef.child(senderUid).child('profile').once('value');
                    if (profileSnap.exists()) {
                        const nickname = escapeHTML(profileSnap.val().nickname);
                        
                        // [ìˆ˜ì •] í† ìŠ¤íŠ¸ ë©”ì‹œì§€ (í´ë¦­í•´ì„œ ë‹µì¥) í•˜ë‚˜ë§Œ ë‚¨ê¹€
                        const toastMessage = `âœ‰ï¸ ${nickname}ë‹˜: ${escapeHTML(messageData.lastMessage)} (í´ë¦­í•´ì„œ ë‹µì¥)`;
                        // [ìˆ˜ì •] í´ë¦­ ì‹œ ëª¨ë‹¬ì„ ì—´ë„ë¡ ì½œë°± í•¨ìˆ˜ ì „ë‹¬
                        showToast(toastMessage, 4000, () => {
                            openMessageModal(senderUid, nickname);
                        });
                        
                        // [ì‚­ì œ] ì¤‘ë³µ í† ìŠ¤íŠ¸ ì œê±°
                        // showToast(`âœ‰ï¸ ${nickname}ë‹˜: ${escapeHTML(messageData.lastMessage)}`);
                    }
                } catch (error) {
                    console.error("ìª½ì§€ ë°œì‹ ì í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:", error);
                }
            }
            
            function updateConcurrentUsers(count) {
                const userCountEl = document.querySelector('.header-user-count');
                if (userCountEl) {
                    userCountEl.innerHTML = `<strong>${count}</strong>ëª… ì ‘ì†ì¤‘`;
                    
                    // [ìˆ˜ì •] í´ë¦­ ì´ë²¤íŠ¸ -> <a> íƒœê·¸ì´ë¯€ë¡œ JS í´ë¦­ ì´ë²¤íŠ¸ ë¶ˆí•„ìš”
                    // userCountEl.onclick = () => {
                    //     if (gameSettings.sfx) clickSound.play();
                    //     showOnlineUsers();
                    // };
                }
            }

            function updateLobbyUI() {
                if (!currentUserData || !currentUserData.profile) return;
                const profile = currentUserData.profile;
                const avatar = profile.avatar;
                
                myEquippedEffect = profile.equippedEntryEffect || null;
                myProfileAvatar.innerHTML = '';
                myProfileAvatar.classList.remove('effect-spotlight-equipped-bg');

                const avatarSet = AVATAR_SETS[avatar];
                if (avatarSet) {
                    myProfileAvatar.innerHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                } else if (avatar && (avatar.startsWith('http') || avatar.includes('.'))) {
                    myProfileAvatar.innerHTML = `<img src="${avatar}" alt="avatar">`;
                } else {
                    myProfileAvatar.textContent = avatar || 'â“';
                }

                if (myEquippedEffect) {
                    const effectOverlay = document.createElement('div');
                    effectOverlay.className = 'entry-effect-overlay';
                    if (myEquippedEffect === 'effect_sparkle') {
                        effectOverlay.classList.add('effect-sparkle-persistent');
                    } else if (myEquippedEffect === 'effect_spotlight') {
                        effectOverlay.classList.add('effect-spotlight-persistent');
                        myProfileAvatar.classList.add('effect-spotlight-equipped-bg');
                    }
                    if (effectOverlay.classList.length > 1) {
                        myProfileAvatar.appendChild(effectOverlay);
                    }
                }

                myProfileNickname.textContent = profile.nickname;
                
                const myProfilePoints = document.getElementById('my-profile-points');
                // [ìˆ˜ì •] ë ˆë²¨ê³¼ í¬ì¸íŠ¸ë¥¼ í•¨ê»˜ í‘œì‹œ
                const level = profile.level || 1;
                const points = profile.points || 0;
                myProfilePoints.innerHTML = `Lv.${level} | ğŸ’° ${points.toLocaleString()}`;
            }
            
            function listenToRooms() {
                if (roomListener) roomsRef.off('value', roomListener);
                
                const roomListWrapper = document.getElementById('room-list-wrapper');
                if (!roomListWrapper) return;

                const spinner = roomListContainer.querySelector('.spinner');
                if (spinner) spinner.remove();

                roomListener = roomsRef.orderByChild('createdAt').limitToLast(30).on('value', snapshot => {
                    roomListWrapper.innerHTML = '';
                    if (!snapshot.exists()) {
                        roomListWrapper.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>';
                        return;
                    }
                    const rooms = [];
                    const now = Date.now();
                    const oneHour = 60 * 60 * 1000;

                    snapshot.forEach(child => {
                        const room = { key: child.key, ...child.val() };
                        
                        // [ê·œì¹™ 1] í”Œë ˆì´ì–´ê°€ 0ëª…ì¸ ë°© ì‚­ì œ
                        if (!room.players || Object.keys(room.players).length === 0) {
                            console.log(`[ìœ ë ¹ë°© ì •ë¦¬] í”Œë ˆì´ì–´ê°€ 0ëª…ì¸ ${room.key} ë°©ì„ ì‚­ì œí•©ë‹ˆë‹¤.`);
                            roomsRef.child(room.key).remove(); 
                            return;
                        }

                        // [ê·œì¹™ 2] 'playing' ìƒíƒœë¡œ 1ì‹œê°„ ë„˜ì€ ë°© ì‚­ì œ
                        if (room.status === 'playing' && (now - room.createdAt > oneHour)) {
                            console.log(`[ìœ ë ¹ë°© ì •ë¦¬] 'playing' ìƒíƒœë¡œ 1ì‹œê°„ ë„˜ì€ ${room.key} ë°©ì„ ì‚­ì œí•©ë‹ˆë‹¤.`);
                            roomsRef.child(room.key).remove();
                            return;
                        }

                        // --- [20ë¶„ìœ¼ë¡œ ìˆ˜ì •ëœ ê·œì¹™] ---
                        // [ì‹ ê·œ ê·œì¹™] 'waiting' ìƒíƒœë¡œ 20ë¶„ ë„˜ì€ ë°© ì‚­ì œ
                        const twentyMinutes = 20 * 60 * 1000; // 20ë¶„
                        if (room.status === 'waiting' && (now - room.createdAt > twentyMinutes)) {
                            console.log(`[ìœ ë ¹ë°© ì •ë¦¬] 'waiting' ìƒíƒœë¡œ 20ë¶„ ë„˜ì€ ${room.key} ë°©ì„ ì‚­ì œí•©ë‹ˆë‹¤.`);
                            roomsRef.child(room.key).remove();
                            return;
                        }
                        // --- [ìˆ˜ì • ë] ---

                        rooms.push(room);
                    });
                    
                    if (rooms.length === 0) {
                        roomListWrapper.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">í™œì„±í™”ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</p>';
                        return;
                    }

                    rooms.reverse().forEach(room => {
                        const game = availableGames.find(g => g.id === room.gameType);
                        if (!game || !room.players) return;
                        
                        const playerCount = Object.keys(room.players).length;
                        const isFull = playerCount >= game.maxPlayers;
                        const isPlaying = room.status === 'playing';

                        const roomEl = document.createElement('div');
                        roomEl.className = 'room-item';
                        roomEl.innerHTML = `
                            <div class="room-info">
                                <h3>${escapeHTML(room.roomName)}</h3>
                                <p>${game.icon} ${game.name} | ${isPlaying ? 'ê²Œì„ì¤‘' : 'ëŒ€ê¸°ì¤‘'} | ${playerCount}/${game.maxPlayers}</p>
                            </div>
                            <button class="menu-btn primary join-btn" ${isFull || isPlaying ? 'disabled' : ''}>ì°¸ê°€</button>
                        `;
                        roomEl.querySelector('.join-btn').addEventListener('click', () => {
                        if (gameSettings.sfx) clickSound.play();
                            window.location.href = `ê²Œì„ë°©.html?roomId=${room.key}`;
                        });
                        roomListWrapper.appendChild(roomEl);
                    });
                });
            }
            
            createRoomBtn.addEventListener('click', () => { 
                if (gameSettings.sfx) clickSound.play();
                showModal(gameSelectModal, () => renderGameOptions('multi'));
            });

            
            function showModal(modal, onShow) { 
                modal.classList.add('active'); 
                
                if (onShow) {
                    // [ìˆ˜ì •] 50ms íƒ€ì´ë¨¸ ëŒ€ì‹ , ë Œë”ë§ì´ ì™„ë£Œë˜ì—ˆëŠ”ì§€ (ë„ˆë¹„ > 0)
                    // requestAnimationFrameìœ¼ë¡œ ê³„ì† í™•ì¸í•©ë‹ˆë‹¤.
                    function checkRender() {
                        // ëª¨ë‹¬ì˜ .modal-contentê°€ ë Œë”ë§ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        const content = modal.querySelector('.modal-content');
                        if (content && content.clientWidth > 0) {
                            // ë Œë”ë§ ì™„ë£Œ, ì½œë°± ì‹¤í–‰
                            onShow();
                        } else {
                            // ë Œë”ë§ ì „, ë‹¤ìŒ í”„ë ˆì„ì— ë‹¤ì‹œ í™•ì¸
                            requestAnimationFrame(checkRender);
                        }
                    }
                    // ë‹¤ìŒ í”„ë ˆì„ì—ì„œ í™•ì¸ ì‹œì‘
                    requestAnimationFrame(checkRender);
                }
            }
            function closeAllModals() { document.querySelectorAll('.overlay').forEach(m => m.classList.remove('active')); }

            document.querySelectorAll('[data-close]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (gameSettings.sfx) clickSound.play();
                    const modal = btn.closest('.overlay');
                    modal.classList.remove('active');

                    // [ì‹ ê·œ] íŒì—… ìª½ì§€ ëª¨ë‹¬ ë‹«ê¸°
                    if (modal.id === 'message-modal' && currentMessagesRef && currentMessageListener) {
                        currentMessagesRef.off('child_added', currentMessageListener);
                        currentMessagesRef = null;
                        currentMessageListener = null;
                        messagesLoaded = false;
                        delete messageModal.dataset.chattingWith;
                    }
                });
            });

            myProfileBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                if (!currentUserData) return;
                const profile = currentUserData.profile;
                const avatarEl = document.getElementById('profile-dashboard-avatar');
                const avatar = profile.avatar || ''; // [ìˆ˜ì •] ë„ ì²´í¬
                const avatarSet = AVATAR_SETS[avatar];
                if (avatarSet) {
                    avatarEl.innerHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                } else if (avatar.startsWith('http') || avatar.includes('.')) {
                    avatarEl.innerHTML = `<img src="${avatar}" alt="avatar">`;
                } else {
                    avatarEl.textContent = avatar || 'â“';
                }

                document.getElementById('profile-dashboard-nickname').textContent = profile.nickname;
                document.getElementById('profile-dashboard-level').textContent = profile.level || 1;
                document.getElementById('profile-points').textContent = (profile.points || 0).toLocaleString();
                
                showModal(profileModal);
            });

            document.querySelectorAll('.game-mode-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (gameSettings.sfx) clickSound.play();
                    const mode = btn.dataset.mode;
                    renderGameOptions(mode);
                });
            });

            const gameOptionsContainer = document.getElementById('game-select-options');

            function renderGameOptions(mode) {
                document.querySelectorAll('.game-mode-tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.mode === mode);
                });
                
                let gamesToShow;
                if (mode === 'multi') {
                    gamesToShow = availableGames.filter(game => !game.isSolo);
                } else {
                    gamesToShow = availableGames.filter(game => game.canSolo);
                }

                gameOptionsContainer.innerHTML = '';
                gamesToShow.forEach(game => {
                    let description = '';
                    if (mode === 'multi') {
                        description = `ìµœëŒ€ ${game.maxPlayers}ëª…`;
                    } else {
                        if (game.canSolo && !game.isSolo) {
                            description = `ìµœëŒ€ ${game.maxPlayers}ëª… | í˜¼ì/ê°™ì´`;
                        } else if (game.isSolo) {
                            description = 'í˜¼ì í•˜ê¸° ì „ìš©';
                        } else {
                            description = 'í˜¼ì í•˜ê¸°';
                        }
                        if (game.id === 'shisenSho' || game.id === 'tetris') {
                            description = 'í˜¼ì í•˜ê¸° (ì „ìš© ëª¨ë“œ)';
                        }
                    }

                    const item = document.createElement('div');
                    item.className = 'game-list-item';
                    
                    item.innerHTML = `
                        <div class="game-list-icon game-${game.id}">${game.icon}</div>
                        <div class="game-list-info">
                            <span class="game-list-name">${game.name}</span>
                            <span class="game-list-desc">${description}</span>
                        </div>
                        <div class="game-list-arrow">â€º</div>
                    `;
                    
                    item.onclick = () => {
                        if (gameSettings.sfx) clickSound.play();
                        if (game.id === 'quiz' && mode === 'solo') {
                            window.location.href = `ê²Œì„ë°©.html?roomId=solo_quiz_temp&mode=solo`;
                        }
                        else if (game.id === 'shisenSho' && mode === 'solo') {
                            // [ìˆ˜ì •] 'í˜¼ìí•˜ê¸°' ì „ìš© íŒŒì¼ë¡œ ì—°ê²°
                            window.location.href = `ì‚¬ì²œì„±í˜¼ìí•˜ê¸°.html`;
                        }
                         else if (game.id === 'candysoap' && mode === 'solo') {
                            // [ìˆ˜ì •] 'í˜¼ìí•˜ê¸°' ì „ìš© íŒŒì¼ë¡œ ì—°ê²°
                            window.location.href = `ì• ë‹ˆíŒ¡í˜¼ìí•˜ê¸°.html`;
                        }
                        else if (game.id === 'tetris' && mode === 'solo') {
                            window.location.href = `í…ŒíŠ¸ë¦¬ìŠ¤í˜¼ìí•˜ê¸°.html`;
                        }
                        else if (mode === 'solo') {
                            window.location.href = `${game.file}?mode=solo`;
                        } else {
                            createNewRoom(game.id);
                        }
                        closeAllModals();
                    };

                    gameOptionsContainer.appendChild(item);
                });
            }

            function createNewRoom(gameId) {
                const newRoomRef = roomsRef.push();
                newRoomRef.set({
                    roomName: `${currentUserData.profile.nickname}ì˜ ë°©`,
                    hostId: currentUser.uid,
                    gameType: gameId,
                    status: 'waiting',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    players: {
                        [currentUser.uid]: {
                            nickname: currentUserData.profile.nickname,
                            avatar: currentUserData.profile.avatar,
                            isHost: true
                        }
                    }
                }).then(() => {
                    window.location.href = `ê²Œì„ë°©.html?roomId=${newRoomRef.key}`;
                });
            }
            
            // --- ëŒ€ê¸°ì‹¤ ì±„íŒ… ê¸°ëŠ¥ (ìœ ì§€) ---
            function sendChatMessage() {
                const message = chatInput.value.trim();
                if (message.length === 0 || message.length > 100) {
                    chatInput.value = '';
                    return;
                }
                if (!currentUser || !currentUserData?.profile) return;

                lobbyChatRef.push({
                    uid: currentUser.uid,
                    nickname: currentUserData.profile.nickname,
                    avatar: currentUserData.profile.avatar,
                    message: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                chatInput.value = '';
                chatInput.focus();
            }

            function listenToLobbyChat() {
                lobbyChatRef.limitToLast(50).on('child_added', snapshot => {
                    const data = snapshot.val();
                    if (!data) return;

                    const messageDate = new Date(data.timestamp);
                    const dateString = messageDate.toLocaleDateString('ko-KR', {
                        year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
                    });
                    
                    if (lastMessageDate !== dateString) {
                        const dateDivider = document.createElement('div');
                        dateDivider.className = 'chat-date-divider';
                        dateDivider.textContent = dateString;
                        chatMessagesContainer.prepend(dateDivider);
                        lastMessageDate = dateString;
                    }

                    const msgEl = document.createElement('div');
                    msgEl.className = 'chat-message';
                    
                    const avatar = data.avatar || ''; // [ìˆ˜ì •] ë„ ì²´í¬
                    const avatarSet = AVATAR_SETS[avatar];
                    let avatarHTML = '';
                    if (avatarSet) {
                        avatarHTML = `<img src="${avatarSet.front}" alt="av" style="width:20px; height:20px; border-radius:50%; margin-right:4px; vertical-align:middle;">`;
                    } else if (avatar.startsWith('http') || avatar.includes('.')) {
                        avatarHTML = `<img src="${avatar}" alt="av" style="width:20px; height:20px; border-radius:50%; margin-right:4px; vertical-align:middle;">`;
                    } else {
                        avatarHTML = `<span style="margin-right:4px;">${avatar || 'â“'}</span>`;
                    }

                    const contentEl = document.createElement('div');
                    contentEl.className = 'chat-content';
                    contentEl.innerHTML = `${avatarHTML}<strong>${escapeHTML(data.nickname)}:</strong> <span>${escapeHTML(data.message)}</span>`;

                    const timeEl = document.createElement('span');
                    timeEl.className = 'chat-time';
                    timeEl.textContent = formatTime(data.timestamp);

                    if (data.uid === currentUser?.uid) {
                        msgEl.classList.add('my-message');
                        contentEl.classList.add('my-message');
                        msgEl.appendChild(timeEl);
                        msgEl.appendChild(contentEl);
                    } else {
                        msgEl.appendChild(contentEl);
                        msgEl.appendChild(timeEl);
                    }
                    
                    chatMessagesContainer.prepend(msgEl);
                    chatMessagesContainer.scrollTop = 0;
                });
            }

            chatSendBtn.addEventListener('click', sendChatMessage);
            
            // [ìˆ˜ì •] í‚¤ë³´ë“œê°€ ì˜¬ë¼ì˜¬ ë•Œ UIê°€ ë°€ë¦¬ëŠ” í˜„ìƒì„ ë§‰ê³  ì±„íŒ…ì°½ì´ ë³´ì´ë„ë¡ ìˆ˜ì •
            chatInput.addEventListener('focus', () => {
                const lobbyPanel = document.querySelector('.lobby-panel');
                const bottomActions = document.getElementById('lobby-bottom-actions');

                // 1. í‚¤ë³´ë“œê°€ í™œì„±í™”ë˜ë©´, í•˜ë‹¨ 'ë°© ëª©ë¡/ë°© ë§Œë“¤ê¸°' ë²„íŠ¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
                //    ì´ë ‡ê²Œ í•˜ë©´ ì±„íŒ… ì…ë ¥ì°½ì´ ê·¸ ìë¦¬ë¥¼ ì°¨ì§€í•˜ê²Œ ë©ë‹ˆë‹¤.
                bottomActions.style.display = 'none';

                // 2. ë·°í¬íŠ¸(ë³´ì´ëŠ” ì˜ì—­)ê°€ ì¤„ì–´ë“  ë†’ì´ë¡œ ì „ì²´ íŒ¨ë„ì˜ ë†’ì´ë¥¼ ê³ ì •í•©ë‹ˆë‹¤.
                //    ì´ë ‡ê²Œ í•˜ë©´ í‚¤ë³´ë“œê°€ ì˜¬ë¼ì™€ë„ ì „ì²´ ë ˆì´ì•„ì›ƒì´ ë°€ë¦¬ì§€ ì•Šê³ ,
                //    ë‚´ë¶€ í”Œë ‰ìŠ¤(flex)ê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ì—¬ ì±„íŒ…ì°½ì´ ë³´ì…ë‹ˆë‹¤.
                lobbyPanel.style.height = window.innerHeight + 'px';

                // 3. ì±„íŒ… ë©”ì‹œì§€ë¥¼ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤. (column-reverseì´ë¯€ë¡œ scrollTop = 0)
                setTimeout(() => {
                    chatMessagesContainer.scrollTop = 0;
                }, 100); 
            });

            chatInput.addEventListener('blur', () => {
                const lobbyPanel = document.querySelector('.lobby-panel');
                const bottomActions = document.getElementById('lobby-bottom-actions');

                // 1. í‚¤ë³´ë“œê°€ ì‚¬ë¼ì§€ë©´, ìˆ¨ê²¼ë˜ í•˜ë‹¨ ë²„íŠ¼ì„ ë‹¤ì‹œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                bottomActions.style.display = 'flex';

                // 2. ê³ ì •í–ˆë˜ íŒ¨ë„ ë†’ì´ë¥¼ ì›ë˜ì˜ 100%ë¡œ ë³µêµ¬í•©ë‹ˆë‹¤.
                lobbyPanel.style.height = '100%';
            });
   
            const toggleChatBtn = document.getElementById('toggle-chat-btn');
            const lobbyPanel = document.querySelector('.lobby-panel');
            
            toggleChatBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                const isActive = lobbyPanel.classList.toggle('chat-active');
                
                if (isActive) {
                    toggleChatBtn.textContent = 'ğŸ“œ ë°© ëª©ë¡';
                    toggleChatBtn.classList.remove('secondary');
                    toggleChatBtn.classList.add('accent');
                } else {
                    toggleChatBtn.textContent = 'ğŸ’¬ ì±„íŒ…';
                    toggleChatBtn.classList.remove('accent');
                    toggleChatBtn.classList.add('secondary');
                }
            });
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.isComposing) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });

            // --- í”„ë¡œí•„/ì„¤ì • ëª¨ë‹¬ (ìœ ì§€) ---
            function showAvatarSelectModal() {
                if (!currentUserData) return;
                if (gameSettings.sfx) clickSound.play();
                
                const profile = currentUserData.profile;
                const ownedAvatars = profile.ownedAvatars || {};
                const currentAvatarValue = profile.avatar;

                selectedAvatarForChange = currentAvatarValue;
                avatarSelectGrid.innerHTML = '';

                // avatar.jsì˜ 'characters' ë³€ìˆ˜ ì‚¬ìš©
                const myAvatarList = [...(window.characters || [])]; 
               // avatar.jsì˜ 'avatarShopItems' ë³€ìˆ˜ ì‚¬ìš©
                (window.avatarShopItems || []).forEach(item => { 
                    // [ìˆ˜ì •] êµ¬ë§¤í–ˆê±°ë‚˜(ownedAvatars) ë˜ëŠ” ê°€ê²©ì´ 0ì›(item.price === 0)ì¸ ì•„ì´í…œ
                    if (ownedAvatars[item.id] || item.price === 0) {
                        myAvatarList.push(item);
                    }
                });

                const createAvatarOption = (item) => {
                    const avatarValue = (AVATAR_SETS[item.id]) ? item.id : item.url;
                    const charOption = document.createElement('div');
                    charOption.className = 'char-option';
                    
                    const isImage = item.url.startsWith('http') || item.url.startsWith('.');
                    if (isImage) {
                        const img = document.createElement('img');
                        img.src = item.url;
                        img.alt = item.name;
                        charOption.appendChild(img);
                    } else {
                        charOption.textContent = item.url;
                        charOption.style.fontSize = '2.5em';
                        charOption.style.padding = '0';
                    }
                    
                    if (avatarValue === currentAvatarValue) {
                        charOption.classList.add('selected');
                    }

                    charOption.addEventListener('click', () => {
                        if (gameSettings.sfx) clickSound.play();
                        avatarSelectGrid.querySelector('.selected')?.classList.remove('selected');
                        charOption.classList.add('selected');
                        selectedAvatarForChange = avatarValue;
                    });
                    
                    return charOption;
                };

                myAvatarList.forEach(item => {
                    avatarSelectGrid.appendChild(createAvatarOption(item));
                });
                
                showModal(avatarSelectModal);
            }

            function handleSaveAvatar() {
                if (gameSettings.sfx) clickSound.play();
                const newAvatar = selectedAvatarForChange;
                const oldAvatar = currentUserData.profile.avatar;

                if (newAvatar === oldAvatar) {
                    closeAllModals();
                    return;
                }

                usersRef.child(currentUser.uid).child('profile/avatar').set(newAvatar)
                    .then(() => {
                        localStorage.setItem('userAvatar', newAvatar);
                        currentUserData.profile.avatar = newAvatar;
                        updateLobbyUI();
                        
                        const avatarEl = document.getElementById('profile-dashboard-avatar');
                        const avatarSet = AVATAR_SETS[newAvatar];
                        if (avatarSet) {
                            avatarEl.innerHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                        } else if (newAvatar.startsWith('http') || newAvatar.includes('.')) {
                            avatarEl.innerHTML = `<img src="${newAvatar}" alt="avatar">`;
                        } else {
                            avatarEl.textContent = newAvatar;
                        }
                        closeAllModals();
                        showToast('ì•„ë°”íƒ€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    })
                    .catch(error => {
                        console.error("ì•„ë°”íƒ€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error);
                        showToast('ì•„ë°”íƒ€ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
            }

            openAvatarSelectBtn.addEventListener('click', showAvatarSelectModal);
            saveAvatarBtn.addEventListener('click', handleSaveAvatar);

            openSettingsBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                
                // [ì‹ ê·œ] í‚¤íŒ¨ë“œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
                loadTetrisKeypadSettings();
                updateKeypadSelectorUI();

                sfxToggle.checked = gameSettings.sfx;
                bgmToggle.checked = gameSettings.bgm;
                vibrationToggle.checked = gameSettings.vibration;
                showModal(gameSettingsModal);
            });

            function createToggleListener(key) {
                return function(event) {
                    // [ìˆ˜ì •] ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•˜ê³ 
                    gameSettings[key] = event.target.checked;
                    localStorage.setItem('gameSettings', JSON.stringify(gameSettings));

                    // [ìˆ˜ì •] ì €ì¥ëœ ìµœì‹  ì„¤ì • ê¸°ì¤€ìœ¼ë¡œ ì†Œë¦¬ë¥¼ ì¬ìƒ
                    if (gameSettings.sfx) clickSound.play();
                };
            }
            sfxToggle.addEventListener('change', createToggleListener('sfx'));
            bgmToggle.addEventListener('change', createToggleListener('bgm'));
            vibrationToggle.addEventListener('change', createToggleListener('vibration'));

            

            logoutBtn.addEventListener('click', () => {
                if (currentUser) {
                    presenceRef.child(currentUser.uid).remove();
                }
                if (gameSettings.sfx) clickSound.play();
                sessionStorage.removeItem('invitedRoomId');
                auth.signOut();
                closeAllModals();
            });

            function checkDailyLogin(uid, profile) {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                const lastLogin = profile.lastLogin || 0;
                const lastLoginDate = new Date(lastLogin).getTime();

                if (lastLoginDate < today) {
                    console.log("[ë°ì¼ë¦¬ ë³´ë„ˆìŠ¤] ì§€ê¸‰ ëŒ€ìƒì…ë‹ˆë‹¤.");
                    const bonusPoints = 100;
                    const newPoints = (profile.points || 0) + bonusPoints;

                    usersRef.child(uid).child('profile').update({
                        points: newPoints,
                        lastLogin: firebase.database.ServerValue.TIMESTAMP
                    })
                    .then(() => {
                        currentUserData.profile.points = newPoints;
                        currentUserData.profile.lastLogin = Date.now();
                        updateLobbyUI();
                        showToast(`ğŸ‰ì ‘ì† ë³´ìƒ! +${bonusPoints}P`);
                    })
                    .catch(error => {
                        console.error("ë°ì¼ë¦¬ ë¡œê·¸ì¸ ë³´ë„ˆìŠ¤ ì§€ê¸‰ ì‹¤íŒ¨:", error);
                    });
                } else {
                    console.log("[ë°ì¼ë¦¬ ë³´ë„ˆìŠ¤] ì˜¤ëŠ˜ ì´ë¯¸ ì§€ê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤.");
                }
            }

            // [ì‹ ê·œ] 4. ìª½ì§€ ëª¨ë‹¬ ì—´ê¸° (íŒì—…ìš©)
            function openMessageModal(targetUid, targetNickname) {
                messageModal.dataset.chattingWith = targetUid;
                if (currentMessagesRef && currentMessageListener) {
                    currentMessagesRef.off('child_added', currentMessageListener);
                }

                closeAllModals(); // ë‹¤ë¥¸ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                
                messageModal.querySelector('#message-modal-nickname').textContent = `${escapeHTML(targetNickname)}ë‹˜ê³¼ ëŒ€í™”`;
                const messageInput = messageModal.querySelector('#message-input');
                const messageSendBtn = messageModal.querySelector('#message-send-btn');
                const messageHistory = messageModal.querySelector('#message-history');
                messageInput.value = '';
                messagesLoaded = false;

                messageInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.isComposing) {
                        e.preventDefault();
                        messageSendBtn.click();
                    }
                };
                
                messageHistory.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';
                
                const myUid = currentUser.uid;
                const chatId = [myUid, targetUid].sort().join('_');
                currentMessagesRef = db.ref(`messages/${chatId}`);

                messageSendBtn.onclick = () => {
                    const message = messageInput.value.trim();
                    if (message === '') return;
                    
                    messageInput.value = '';
                    messageInput.focus();
                    
                    const messageData = {
                        senderUid: myUid,
                        message: message,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    currentMessagesRef.push(messageData)
                        .then(() => {
                            db.ref(`user_inboxes/${targetUid}/${myUid}`).set({
                                lastMessage: message,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        })
                        .catch(error => {
                            console.error("ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨:", error);
                            showToast("ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            messageInput.value = message;
                        });
                };

                currentMessagesRef.orderByChild('timestamp').limitToLast(50).once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        messageHistory.innerHTML = '<p style="text-align:center; color:#888; padding: 40px;">ì•„ì§ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        messagesLoaded = true;
                    }
                });

                currentMessageListener = (snapshot) => {
                    if (!messagesLoaded) {
                        messageHistory.innerHTML = '';
                        messagesLoaded = true;
                    }
                    const data = snapshot.val();
                    if (!data) return;
                    const isMe = data.senderUid === myUid;
                    const msgEl = createMessageBubble(data.message, data.timestamp, isMe);
                    messageHistory.prepend(msgEl);
                };
                
                currentMessagesRef.orderByChild('timestamp').limitToLast(50).on('child_added', currentMessageListener);

                showModal(messageModal);
                setTimeout(() => messageInput.focus(), 300);
            }

            // [ì‹ ê·œ] 5. ìª½ì§€ ë§í’ì„  DOM ìƒì„±
            function createMessageBubble(message, timestamp, isMe) {
                const msgEl = document.createElement('div');
                msgEl.className = 'msg-bubble';
                
                const contentEl = document.createElement('div');
                contentEl.className = 'msg-content';
                contentEl.textContent = escapeHTML(message);

                const timeEl = document.createElement('span');
                timeEl.className = 'msg-time';
                timeEl.textContent = formatTime(timestamp);

                if (isMe) {
                    msgEl.classList.add('my-message');
                    contentEl.classList.add('my-message');
                    msgEl.appendChild(timeEl);
                    msgEl.appendChild(contentEl);
                } else {
                    msgEl.appendChild(contentEl);
                    msgEl.appendChild(timeEl);
                }
                return msgEl;
            }
// [ì‹ ê·œ] ì´ˆëŒ€ ìˆ˜ë½/ê±°ì ˆ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
            inviteAcceptBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                if (currentInvitationData && currentInvitationData.room_id) {
                    // ì´ˆëŒ€ì— ì‘í–ˆìœ¼ë¯€ë¡œ, Firebaseì—ì„œ ì´ˆëŒ€ì¥ ì‚­ì œ
                    currentInvitationRef.child(currentInvitationData.key).remove();
                    
                    // í•´ë‹¹ ê²Œì„ë°©ìœ¼ë¡œ ì´ë™
                    window.location.href = `ê²Œì„ë°©.html?roomId=${currentInvitationData.room_id}`;
                }
                closeAllModals();
            });

            inviteDeclineBtn.addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                if (currentInvitationData) {
                    // ê±°ì ˆí–ˆìœ¼ë¯€ë¡œ, Firebaseì—ì„œ ì´ˆëŒ€ì¥ ì‚­ì œ
                    currentInvitationRef.child(currentInvitationData.key).remove();
                }
                closeAllModals();
                currentInvitationData = null;
            });

        });

        
    </script>



    <div id="keypad-custom-modal" class="overlay">

        <div class="modal-content">

            <div class="modal-header">

                <button class="back-btn" data-close>â€¹</button>

                <h2>í‚¤íŒ¨ë“œ ì»¤ìŠ¤í…€</h2>

            </div>

            <div class="modal-body" style="padding: 0; overflow: hidden; max-height: 70vh; background: #333;">

                <p style="color: white; text-align: center; padding: 10px 0; font-size: 0.9em; background: #222;">

                    ë²„íŠ¼ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”.

                </p>

              <div id="keypad-preview-area">

                    <div id="tetris-keypad-clone">

                        <div class="touch-btn draggable-btn pos-down" data-key="btnDown">â–¼</div>

                        <div class="touch-btn draggable-btn pos-left" data-key="btnLeft">â—€</div>

                        <div class="touch-btn draggable-btn pos-right" data-key="btnRight">â–¶</div>

                       

                        <div class="touch-btn draggable-btn pos-hold" data-key="btnHold">HOLD</div>

                        <div class="touch-btn draggable-btn pos-rotate" data-key="btnRotate">â†»</div>

                        <div class="touch-btn draggable-btn pos-drop" data-key="btnDrop">DROP</div>

                    </div>

                </div>

                </div>

            <div class="modal-footer">

                <button id="reset-keypad-btn" class="menu-btn light">ì´ˆê¸°í™”</button>

                <button id="save-keypad-btn" class="menu-btn secondary">ì €ì¥</button>

            </div>

            <div id="pwa-install-modal" class="overlay">

        <div class="modal-content" style="max-width: 380px;">

            <div class="modal-body">

                <h3 style="font-size: 1.4em; margin-bottom: 15px;">ğŸ“² ì•±(App) ì„¤ì¹˜</h3>

                <p style="font-size: 1em; color: #333; line-height: 1.5;">

                    í™ˆ í™”ë©´ì— ì•±ì„ ì„¤ì¹˜í•˜ì—¬<br>ë” ë¹ ë¥´ê³  ì¾Œì í•˜ê²Œ ì ‘ì†í•˜ì„¸ìš”!

                </p>

            </div>

            <div class="modal-footer">

                <button id="pwa-install-later-btn" class="menu-btn secondary">ë‚˜ì¤‘ì—</button>

                <button id="pwa-install-confirm-btn" class="menu-btn primary">ì„¤ì¹˜</button>

            </div>

        </div>

    </div>

        </div>

    </div>


<div id="invite-received-modal" class="overlay">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-body" style="padding: 30px 20px 20px; text-align: center;">
                <h3 id="invite-modal-title" style="font-size: 1.3em; margin-bottom: 10px;">...</h3>
                <p id="invite-modal-message" style="font-size: 1.0em; color: #333; line-height: 1.5; margin-bottom: 20px;">...</p>
            </div>
            <div class="modal-footer" style="padding: 20px;">
                <button id="invite-decline-btn" class="menu-btn secondary">ê±°ì ˆ</button>
                <button id="invite-accept-btn" class="menu-btn primary">ìˆ˜ë½</button>
            </div>
        </div>
    </div>
</body>
</html>
