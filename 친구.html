<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>ì¹œêµ¬</title>
    
    <link rel="manifest" href="manifest.json">
    <link href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/GmarketSansMedium.woff" as="font" type="font/woff" crossorigin>
    <style>
        /* ëŒ€ê¸°ì‹¤.htmlì˜ ëª¨ë“  <style> ë‚´ìš©ì„ ì—¬ê¸°ì— ë³µì‚¬í•©ë‹ˆë‹¤. */
        :root {
            --bg-color: #FFFBEB;
            --primary-color: #FF6B6B;
            --secondary-color: #4ECDC4;
            --accent-color: #FFD93D;
            --text-color-dark: #574141;
            --text-color-light: #ffffff;
            --danger-color: #F76363;
            --panel-bg: #FFFFFF;
            --panel-border: #F0EAD2;
            --panel-shadow: #E4DCCF;
            --font-main: 'GmarketSans', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body {
            width: 100%; height: 100%; overflow: hidden;
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color-dark);
            -webkit-user-select: none; user-select: none;
            touch-action: manipulation;
        }
        .view {
            width: 100%; height: 100%; 
            display: flex; flex-direction: column;
        }
        .spinner {
            border: 5px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top: 5px solid var(--accent-color);
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ì•„ì¼€ì´ë“œ ìŠ¤íƒ€ì¼ ë²„íŠ¼ (ëŒ€ê¸°ì‹¤.htmlê³¼ ë™ì¼) */
        .menu-btn {
            width: 100%; padding: 16px; font-size: 1.25em; font-weight: 900;
            font-family: var(--font-main);
            border-radius: 16px; border: none; cursor: pointer;
            transition: all 0.1s ease-out;
            border-bottom: 5px solid;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.1);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .menu-btn:active { transform: translateY(3px); border-bottom-width: 2px; }
        .menu-btn.primary { background-color: var(--primary-color); color: var(--text-color-light); border-bottom-color: #C04A4A; }
        .menu-btn.secondary { background-color: var(--secondary-color); color: var(--text-color-light); border-bottom-color: #379A93; }
        .menu-btn.accent { background-color: var(--accent-color); color: var(--text-color-dark); border-bottom-color: #D1B030; text-shadow: none; }
        .menu-btn.light { background-color: #F8F9FA; color: var(--text-color-dark); border-bottom-color: #BDBDBD; }
        .menu-btn.danger { background-color: var(--danger-color); color: var(--text-color-light); border-bottom-color: #A94442; }
        .menu-btn:disabled { background-color: #BDBDBD !important; color: #757575 !important; border-bottom-color: #8D8D8D !important; cursor: not-allowed; transform: none; }


        /* í˜ì´ì§€ í—¤ë” (ë­í‚¹.htmlê³¼ ë™ì¼) */
        .page-header {
            width: 100%; padding: 10px 12px; flex-shrink: 0;
            background: #FFFAE0;
            border-bottom: 3px solid var(--panel-border);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 8px;
        }
        .page-header h1 {
            font-size: 1.3em;
            color: var(--text-color-dark);
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }
        .back-btn {
            background: none; border: none; color: var(--text-color-dark);
            font-size: 2.0em; cursor: pointer; padding: 0 10px;
            text-decoration: none;
            font-weight: 700;
            line-height: 1;
        }

        /* ------------------------- */
        /* == ì¹œêµ¬ ê´€ë¦¬ ì»¨í…ì¸  == */
        /* ------------------------- */
        /* (ë­í‚¹.htmlì˜ íƒ­ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) */
        #friend-tabs {
            display: flex;
            overflow-x: auto; /* [ì‹ ê·œ] íƒ­ì´ ë§ì•„ì§ˆ ê²½ìš° ìŠ¤í¬ë¡¤ */
            padding: 10px 12px;
            background-color: #FFFAE0;
            border-bottom: 3px solid var(--panel-border);
            flex-shrink: 0;
            gap: 8px;
        }
        .tab-btn {
            min-width: 80px; /* [ì‹ ê·œ] ìµœì†Œ ë„ˆë¹„ */
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 700;
            border-radius: 12px;
            border: 3px solid var(--panel-border);
            background: white;
            color: #888;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom-width: 4px;
            position: relative; /* ë±ƒì§€ ê¸°ì¤€ì  */
        }
        .tab-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: #C04A4A;
            border-bottom-color: #C04A4A;
        }
        /* [ì‹ ê·œ] ì ‘ì†ì íƒ­ í™œì„± ìƒ‰ìƒ */
        .tab-btn[data-tab="online-users"].active {
             background: var(--secondary-color);
             border-color: #379A93;
             border-bottom-color: #379A93;
        }


        /* íƒ­ ë±ƒì§€ (ì¹œêµ¬ ìš”ì²­ ìˆ˜) */
        .tab-btn .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75em;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* íƒ­ ì»¨í…ì¸  ì˜ì—­ */
        .tab-content {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .tab-content.active {
            display: block; /* í™œì„±í™”ëœ íƒ­ë§Œ ë³´ì„ */
        }
        
        /* 'ì¹œêµ¬ ì°¾ê¸°' íƒ­ ìŠ¤íƒ€ì¼ */
        #friend-search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #friend-search-input {
            flex-grow: 1;
            border: 3px solid var(--text-color-dark);
            border-radius: 12px;
            padding: 12px;
            font-size: 1em;
            font-family: var(--font-main);
            min-width: 0;
        }
        #friend-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        #friend-search-btn {
            flex-shrink: 0;
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1em;
            padding: 0 20px;
            border: none; border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            border-bottom: 4px solid #C04A4A;
            cursor: pointer;
        }
        #friend-search-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }

        /* ìœ ì € ëª©ë¡ (ëŒ€ê¸°ì‹¤.html ì ‘ì†ì ëª©ë¡ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) */
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .user-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background-color: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 16px;
            box-shadow: 4px 4px 0px 0px var(--panel-shadow);
        }
        .user-list-avatar {
            width: 44px; height: 44px; font-size: 2.2em;
            display: flex; justify-content: center; align-items: center;
            border-radius: 12px; border: 3px solid var(--text-color-dark);
            background-color: var(--panel-bg);
            overflow: hidden; flex-shrink: 0;
        }
        .user-list-avatar img { width: 100%; height: 100%; object-fit: contain; }
        
        .user-list-nickname {
            font-weight: 700;
            font-size: 1.0em;
            flex-grow: 1; min-width: 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* [ì‹ ê·œ] 'ë‚˜' ìì‹ ì„ ê°•ì¡°í•˜ëŠ” ìŠ¤íƒ€ì¼ */
        .user-list-item.is-me {
            background-color: #FFF8E1; /* ì—°í•œ ë…¸ë€ìƒ‰ ë°°ê²½ */
        }
        .user-list-item.is-me .user-list-nickname {
            color: var(--primary-color); /* ê°•ì¡°ìƒ‰ */
        }
        
        .user-item-actions {
            display: flex; gap: 8px; flex-shrink: 0;
        }
        .user-action-btn {
            /* (ë²„íŠ¼ ìŠ¤íƒ€ì¼ì€ .menu-btn ì¬ì‚¬ìš©) */
            font-size: 0.9em;
            padding: 10px 12px;
            min-width: 60px;
            width: auto;
            border-radius: 12px;
            border-bottom-width: 4px;
        }

        /* [ì‹ ê·œ] ì ‘ì†ì/ì¹œêµ¬ì°¾ê¸° ë²„íŠ¼ */
        .user-action-btn.add-friend {
            /* .menu-btn.primary */
            background-color: var(--primary-color); 
            color: var(--text-color-light); 
            border-bottom-color: #C04A4A;
        }
        .user-action-btn.send-message {
            /* .menu-btn.accent */
            background-color: var(--accent-color); 
            color: var(--text-color-dark); 
            border-bottom-color: #D1B030;
        }


        /* ------------------------- */
        /* == 1:1 ìª½ì§€ ëª¨ë‹¬ (ì‹ ê·œ) == */
        /* ------------------------- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 200; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .overlay.active { display: flex; }
        .modal-content {
            background: var(--panel-bg);
            border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 90%; max-width: 400px; /* ìª½ì§€ ëª¨ë‹¬ ë„ˆë¹„ */
            overflow: hidden;
            border: 4px solid var(--text-color-dark);
            box-shadow: 8px 8px 0px 0px var(--text-color-dark);
        }
        .modal-header {
            padding: 15px 20px;
            background-color: var(--secondary-color);
            color: white;
            border-bottom: 4px solid #379A93;
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-header h2 {
            font-size: 1.3em;
            flex-grow: 1; text-align: center; margin: 0;
        }
        /* ëª¨ë‹¬ìš© ë’¤ë¡œê°€ê¸° ë²„íŠ¼ */
        .modal-back-btn {
            background: none; border: none; color: white;
            font-size: 2.5em; cursor: pointer; padding: 0 10px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            line-height: 1;
        }

        #message-modal .modal-body {
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 60vh; /* ëª¨ë‹¬ ë†’ì´ ì§€ì • */
            max-height: 500px;
        }
        #message-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column-reverse; /* ìƒˆ ë©”ì‹œì§€ê°€ ì•„ë˜ì— ì˜¤ë„ë¡ */
            background-color: var(--bg-color);
        }
        #message-input-area {
            display: flex;
            padding: 10px;
            border-top: 3px solid var(--panel-border);
            gap: 8px;
            background-color: #FFFAE0;
        }
        #message-input {
            flex-grow: 1;
            border: 2px solid var(--text-color-dark);
            border-radius: 12px;
            padding: 12px;
            font-size: 1em;
            font-family: var(--font-main);
            min-width: 0;
        }
        #message-send-btn {
            flex-shrink: 0;
            font-family: var(--font-main);
            font-weight: 700;
            font-size: 1em;
            padding: 0 20px;
            border: none; border-radius: 12px;
            background-color: var(--primary-color);
            color: white;
            border-bottom: 4px solid #C04A4A;
            cursor: pointer;
        }
        #message-send-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        /* ìª½ì§€ ë§í’ì„  */
        .msg-bubble {
            margin-bottom: 8px;
            max-width: 90%;
            align-self: flex-start;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .msg-content {
            padding: 6px 12px;
            border-radius: 12px;
            background-color: var(--panel-bg);
            border: 2px solid var(--panel-border);
            word-wrap: break-word;
        }
        .msg-time {
            font-size: 0.75em;
            color: #888;
            flex-shrink: 0;
            margin-bottom: 2px;
        }
        .msg-bubble.my-message {
            align-self: flex-end;
        }
        .msg-content.my-message {
            background-color: var(--accent-color);
            border-color: #D1B030;
        }

        /* ------------------------- */
        /* == í† ìŠ¤íŠ¸ ì•Œë¦¼ (ëŒ€ê¸°ì‹¤.htmlê³¼ ë™ì¼) == */
        /* ------------------------- */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; gap: 10px; pointer-events: none;
        }
        .toast-message {
            background-color: rgba(40, 40, 40, 0.85); color: white;
            padding: 10px 20px; border-radius: 20px;
            font-size: 0.9em; font-weight: 700;
            animation: toast-fade 3s ease-out forwards;
        }
        @keyframes toast-fade {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        @keyframes toast-fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }

        /* [ì¶”ê°€] ë°›ì€ ìª½ì§€í•¨ ìŠ¤íƒ€ì¼ */
        .message-list { display: flex; flex-direction: column; gap: 12px; }
        .message-list-item {
            background-color: var(--panel-bg);
            border: 3px solid var(--panel-border);
            border-radius: 16px;
            box-shadow: 4px 4px 0px 0px var(--panel-shadow);
        }
        .message-list-item.is-unread {
            background-color: #FFF8E1;
            border-color: var(--accent-color);
        }
        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 2px dashed var(--panel-border);
        }
        .message-avatar {
            width: 36px; height: 36px; font-size: 1.8em;
            display: flex; justify-content: center; align-items: center;
            border-radius: 10px; border: 3px solid var(--text-color-dark);
            background-color: var(--panel-bg);
            overflow: hidden; flex-shrink: 0;
        }
        .message-avatar img { width: 100%; height: 100%; object-fit: contain; }
        .message-sender {
            font-weight: 700;
            font-size: 1.0em;
            flex-grow: 1; min-width: 0;
        }
        .message-time {
            font-size: 0.8em;
            color: #777;
            flex-shrink: 0;
        }
        .message-content {
            padding: 15px 12px;
            font-size: 0.95em;
            line-height: 1.4;
            word-break: break-word;
        }
        .message-actions {
            display: flex;
            gap: 8px;
            padding: 0 12px 12px;
        }
        .message-actions .menu-btn {
            font-size: 0.9em;
            padding: 10px 12px;
            min-width: 60px;
            width: auto;
            border-radius: 12px;
            border-bottom-width: 4px;
            flex: 1;
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <audio id="click-sound" src="https://blog.kakaocdn.net/dna/dC0WAE/dJMb84DsZw6/AAAAAAAAAAAAAAAAAAAAAC8XpuPuNVEsdp6Ia-d35XR-m3FCZxObUR5uFI1tk2iv/%EB%B2%84%ED%8A%BC%EC%82%AC%EC%9A%B4%EB%93%9C.mp3?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1761922799&allow_ip=&allow_referer=&signature=RdbjxdP75HLHSpBIhymVkYpUOA0%D&attach=1&knm=tfile.mp3" preload="auto"></audio>
    
    <div id="friend-view" class="view">
        <div class="page-header">
            <a href="ëŒ€ê¸°ì‹¤.html" class="back-btn" id="back-btn">â€¹</a>
            <h1>ğŸ‘¥ ì¹œêµ¬</h1>
            <div style="width: 40px; flex-shrink: 0;"></div>
        </div>

       <div id="friend-tabs">
            <button class="tab-btn active" data-tab="online-users">ì ‘ì†ì</button>
            <button class="tab-btn" data-tab="list">ì¹œêµ¬ ëª©ë¡</button>
            <button class="tab-btn" data-tab="requests">ë°›ì€ ìš”ì²­</button>
            <button class="tab-btn" data-tab="messages">ë°›ì€ ìª½ì§€</button>
            <button class="tab-btn" data-tab="search">ì¹œêµ¬ ì°¾ê¸°</button>
        </div>

        <div id="online-users-content" class="tab-content active">
            <div class="user-list" id="online-users-container">
                <div class="spinner"></div>
            </div>
        </div>

        <div id="list-content" class="tab-content">
            <div class="user-list" id="friend-list-container">
                <div class="spinner"></div>
            </div>
        </div>
        
        <div id="requests-content" class="tab-content">
            <div class="user-list" id="friend-requests-container">
                <div class="spinner"></div>
            </div>
        </div>
        
        <div id="messages-content" class="tab-content">
            <div class="message-list" id="messages-container">
                <div class="spinner"></div>
            </div>
        </div>

        <div id="search-content" class="tab-content">
            <form id="friend-search-form">
                <input type="text" id="friend-search-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                <button type="submit" id="friend-search-btn">ê²€ìƒ‰</button>
            </form>
            <div class="user-list" id="friend-search-results-container">
                </div>
        </div>
    </div>

    <div id="message-modal" class="overlay">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-back-btn" data-close>â€¹</button>
                <h2 id="message-modal-nickname">...</h2>
                <div style="width: 40px;"></div>
            </div>
            <div class="modal-body">
                <div id="message-history">
                    <div class="spinner" style="margin: 20px auto;"></div>
                </div>
                <div id="message-input-area">
                    <input type="text" id="message-input" placeholder="ìª½ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <button id="message-send-btn">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

    <script src="ì•„ë°”íƒ€.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        // --- í—¬í¼ í•¨ìˆ˜ (ëŒ€ê¸°ì‹¤.htmlê³¼ ë™ì¼) ---
        function showToast(message, duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'toast-fade-out 0.5s ease-out forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, duration - 500);
        }

        
        // [ì¶”ê°€] ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const seconds = Math.floor((now - timestamp) / 1000);

            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "ë…„ ì „";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "ë‹¬ ì „";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "ì¼ ì „";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "ì‹œê°„ ì „";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "ë¶„ ì „";
            return "ë°©ê¸ˆ ì „";
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        // [ì‹ ê·œ] ì‹œê°„ í¬ë§· í•¨ìˆ˜
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'ì˜¤í›„' : 'ì˜¤ì „';
            const formattedHours = (hours % 12) || 12; // 12-hour format
            return `${ampm} ${formattedHours}:${minutes}`;
        }

        document.addEventListener('contextmenu', event => event.preventDefault());
        
        document.addEventListener('keydown', event => {
            if (event.key === 'F12' ||
                (event.ctrlKey && event.shiftKey && ['I', 'J', 'C'].includes(event.key.toUpperCase())) ||
                (event.ctrlKey && event.key.toUpperCase() === 'U')) {
            event.preventDefault();
            }
        });

        const defaultSettings = { sfx: true, bgm: true, vibration: true };
        let gameSettings = JSON.parse(localStorage.getItem('gameSettings')) || defaultSettings;

        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCmNAKmgF_L3o0QyOGh_oFAq_rMRtUyklw",
                authDomain: "goodluck-7c14b.firebaseapp.com",
                databaseURL: "https://goodluck-7c14b-default-rtdb.firebaseio.com",
                projectId: "goodluck-7c14b",
                storageBucket: "goodluck-7c14b.appspot.com",
                messagingSenderId: "858281658455",
                appId: "1:858281658455:web:9131280a459be983933b12"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const auth = firebase.auth();
            const usersRef = db.ref('users');
            const presenceRef = db.ref('status');
            
            const clickSound = document.getElementById('click-sound');
            const backBtn = document.getElementById('back-btn');
            
            const tabsContainer = document.getElementById('friend-tabs');
            const tabContents = document.querySelectorAll('.tab-content');
            
            const onlineUsersContainer = document.getElementById('online-users-container');
            const friendListContainer = document.getElementById('friend-list-container');
            const friendRequestsContainer = document.getElementById('friend-requests-container');
            const friendSearchForm = document.getElementById('friend-search-form');
            const friendSearchInput = document.getElementById('friend-search-input');
            const friendSearchResultsContainer = document.getElementById('friend-search-results-container');
            
            // [ì‹ ê·œ] ë°›ì€ ìª½ì§€í•¨
            const messagesContainer = document.getElementById('messages-container');
            
            const messageModal = document.getElementById('message-modal');

            let currentUser, currentUserData;
            let myFriendIds = {};
            let myPresenceRef = null;
            
            let messageInboxRef = null;
            let messageInboxListener = null;

            let currentMessagesRef = null;
            let currentMessageListener = null;
            let messagesLoaded = false;
            let lastMessageTimestamp = 0;

            // [ì‹ ê·œ] ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
            let friendListRef = null;
            let friendListListener = null;
            let friendRequestRef = null;
            let friendRequestListener = null;

            backBtn.addEventListener('click', (e) => {
                if (gameSettings.sfx) clickSound.play();
            });

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    
                    myPresenceRef = presenceRef.child(user.uid);
                    myPresenceRef.set(true);
                    myPresenceRef.onDisconnect().remove();

                    usersRef.child(user.uid).on('value', snapshot => {
                        if (snapshot.exists()) {
                            currentUserData = snapshot.val();
                            
                            // [ìˆ˜ì •] Firebase ê·œì¹™ì— ë§ëŠ” ì¹œêµ¬ ëª©ë¡ ê²½ë¡œ
                            db.ref(`friends/${currentUser.uid}`).on('value', (friendSnap) => {
                                myFriendIds = friendSnap.val() || {};
                                
                                // í˜ì´ì§€ê°€ ì²˜ìŒ ë¡œë“œë  ë•Œë§Œ íƒ­ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                                if (!window.friendPageInitialized) {
                                    initFriendPage();
                                    window.friendPageInitialized = true;
                                }
                                
                                // ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ í˜„ì¬ í™œì„±í™”ëœ íƒ­ ìƒˆë¡œê³ ì¹¨
                                refreshActiveTab();
                            });
                        }
                    });

                    // [ìˆ˜ì •] ìª½ì§€ ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ (ê²½ë¡œ ìˆ˜ì •)
                    const myInboxRef = db.ref(`user_inboxes/${user.uid}`);
                    myInboxRef.once('value', (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            Object.values(data).forEach(msg => {
                                if (msg.timestamp > lastMessageTimestamp) {
                                    lastMessageTimestamp = msg.timestamp;
                                }
                            });
                        }
                        const startTimestamp = lastMessageTimestamp === 0 ? 0 : lastMessageTimestamp + 1;
                        myInboxRef.orderByChild('timestamp').startAt(startTimestamp).on('child_added', (snap) => handleNewMessageAlert(snap, user.uid));
                        myInboxRef.on('child_changed', (snap) => handleNewMessageAlert(snap, user.uid));
                    });

                } else {
                    window.location.replace('index.html');
                }
            });

            // [ì‹ ê·œ] ìª½ì§€ ì•Œë¦¼ í•¸ë“¤ëŸ¬
            async function handleNewMessageAlert(snapshot, myUid) {
                const messageData = snapshot.val();
                const senderUid = snapshot.key;

                if (messageData.timestamp <= lastMessageTimestamp) return;
                lastMessageTimestamp = messageData.timestamp;

                if (messageModal.classList.contains('active') && messageModal.dataset.chattingWith === senderUid) {
                    return; 
                }

                try {
                    const profileSnap = await usersRef.child(senderUid).child('profile').once('value');
                    if (profileSnap.exists()) {
                        const nickname = escapeHTML(profileSnap.val().nickname);
                        showToast(`âœ‰ï¸ ${nickname}ë‹˜ì—ê²Œ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!`);
                    }
                } catch (error) {
                    console.error("ìª½ì§€ ë°œì‹ ì í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:", error);
                }
            }
            
            function initFriendPage() {
                setupTabListeners();
                setupSearchFormListener();

                
                
                loadOnlineUsersList();
                listenToFriends();
                listenToFriendRequests();
                listenToMessages();
            }
            
            function setupTabListeners() {
                tabsContainer.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (gameSettings.sfx) clickSound.play();
                        
                        const tabName = e.currentTarget.dataset.tab;
                        
                        tabsContainer.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                        tabContents.forEach(c => c.classList.remove('active'));
                        
                        e.currentTarget.classList.add('active');
                        document.getElementById(`${tabName}-content`).classList.add('active');
                        
                        if (tabName === 'online-users') {
                            loadOnlineUsersList();
                        } else if (tabName === 'list') {
                            listenToFriends();
                        } else if (tabName === 'requests') {
                            listenToFriendRequests();
                        } else if (tabName === 'messages') {
                            listenToMessages();
                        }
                    });
                });
            }

            function refreshActiveTab() {
    const activeTab = tabsContainer.querySelector('.tab-btn.active');
    if (!activeTab) return;
    
    const tabName = activeTab.dataset.tab;
    
    // âœ… ì ‘ì†ì ëª©ë¡ë§Œ ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨
    if (tabName === 'online-users') {
        loadOnlineUsersList();
    }
    // âœ… ë‚˜ë¨¸ì§€ëŠ” Firebase ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë¯€ë¡œ
    //    ìë™ìœ¼ë¡œ UIê°€ ê°±ì‹ ë¨ (ì¤‘ë³µ í˜¸ì¶œ ë¶ˆí•„ìš”!)
}

            // [ì‹ ê·œ] 0. ì ‘ì†ì ëª©ë¡ ë¡œë“œ
            function loadOnlineUsersList() {
                onlineUsersContainer.innerHTML = '<div class="spinner"></div>';
                
                presenceRef.once('value', async (presenceSnap) => {
                    if (!presenceSnap.exists()) {
                        onlineUsersContainer.innerHTML = '<p style="text-align: center;">ì ‘ì† ì¤‘ì¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    const uids = Object.keys(presenceSnap.val());
                    const profilePromises = uids.map(uid => usersRef.child(uid).child('profile').once('value'));
                    
                    try {
                        const profileSnapshots = await Promise.all(profilePromises);
                        onlineUsersContainer.innerHTML = '';
                        
                        profileSnapshots.forEach((profileSnap, index) => {
                            const profile = profileSnap.val();
                            const uid = uids[index];
                            if (!profile) return;
                            
                            const itemEl = createUserListItem(uid, profile, 'online');
                            onlineUsersContainer.appendChild(itemEl);
                        });

                        if (onlineUsersContainer.innerHTML === '') {
                            onlineUsersContainer.innerHTML = '<p style="text-align: center;">ì ‘ì† ì¤‘ì¸ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    } catch (error) {
                        console.error("ì ‘ì†ì í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:", error);
                        onlineUsersContainer.innerHTML = '<p style="text-align: center;">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                    }
                });
            }
            
            // [ìˆ˜ì •] 1. ì¹œêµ¬ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ (ê²½ë¡œ ë° ì¤‘ë³µ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì •)
            function listenToFriends() {
                friendListContainer.innerHTML = '<div class="spinner"></div>';
                
                // [ìˆ˜ì •] ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë¶€ì°© ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
                if (friendListRef && friendListListener) {
                    friendListRef.off('value', friendListListener);
                }

                // [ìˆ˜ì •] ì˜¬ë°”ë¥¸ ê²½ë¡œë¡œ ìˆ˜ì •
                friendListRef = db.ref(`friends/${currentUser.uid}`);
                friendListListener = friendListRef.on('value', snapshot => {
                    if (!snapshot.exists()) {
                        friendListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    const friendIds = Object.keys(snapshot.val());
                    const promises = friendIds.map(uid => usersRef.child(uid).child('profile').once('value'));
                    
                    Promise.all(promises).then(results => {
                        friendListContainer.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
                        results.forEach((profileSnapshot, index) => {
                            if (profileSnapshot.exists()) {
                                const friendProfile = profileSnapshot.val();
                                const friendUid = friendIds[index];
                                const itemEl = createUserListItem(friendUid, friendProfile, 'friend');
                                friendListContainer.appendChild(itemEl);
                            }
                        });
                        // [ì‹ ê·œ] ì¹œêµ¬ê°€ í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨ ë“±ìœ¼ë¡œ 0ëª…ì¼ ê²½ìš°
                        if (friendListContainer.innerHTML === '') {
                             friendListContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ì¹œêµ¬ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    });
                });
            }
            
            // [ìˆ˜ì •] 2. ì¹œêµ¬ ìš”ì²­ ë¦¬ìŠ¤ë„ˆ (ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ìˆ˜ì •)
            function listenToFriendRequests() {
                friendRequestsContainer.innerHTML = '<div class="spinner"></div>';
                
                // [ìˆ˜ì •] ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ë¶€ì°© ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
                if (friendRequestRef && friendRequestListener) {
                    friendRequestRef.off('value', friendRequestListener);
                }

                friendRequestRef = db.ref(`friend_requests/${currentUser.uid}`);
                friendRequestListener = friendRequestRef.on('value', async (snapshot) => {
                    const requestBadge = tabsContainer.querySelector('[data-tab="requests"] .badge');
                    if (!snapshot.exists()) {
                        friendRequestsContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        if (requestBadge) requestBadge.remove();
                        return;
                    }
                    
                    const requests = snapshot.val();

                    const requestUids = Object.keys(requests);
                    
                    const count = requestUids.length;
                    if (requestBadge) {
                        requestBadge.textContent = count > 9 ? '9+' : count;
                    } else {
                        const newBadge = document.createElement('span');
                        newBadge.className = 'badge';
                        newBadge.textContent = count > 9 ? '9+' : count;
                        tabsContainer.querySelector('[data-tab="requests"]').appendChild(newBadge);
                    }

                    const profilePromises = requestUids.map(uid => usersRef.child(uid).child('profile').once('value'));
                    const profileSnapshots = await Promise.all(profilePromises);

                    friendRequestsContainer.innerHTML = '';
                    profileSnapshots.forEach((profileSnap, index) => {
                        if (profileSnap.exists()) {
                            const uid = requestUids[index];
                            const profile = profileSnap.val();
                            const itemEl = createUserListItem(uid, profile, 'request');
                            friendRequestsContainer.appendChild(itemEl);
                        }
                    });
                });
            }
            
            // 3. ì¹œêµ¬ ì°¾ê¸° í¼ ë¦¬ìŠ¤ë„ˆ (ê²½ë¡œ ìˆ˜ì • ì—†ìŒ - users/.. ê²€ìƒ‰)
            function setupSearchFormListener() {
                friendSearchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (gameSettings.sfx) clickSound.play();
                    
                    const searchTerm = friendSearchInput.value.trim();
                    if (searchTerm.length < 2) {
                        showToast('ë‹‰ë„¤ì„ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }
                    
                    if (searchTerm === currentUserData.profile.nickname) {
                        showToast('ìê¸° ìì‹ ì€ ê²€ìƒ‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    friendSearchResultsContainer.innerHTML = '<div class="spinner"></div>';
                    
                    usersRef.orderByChild('profile/nickname').equalTo(searchTerm).once('value', snapshot => {
                        if (!snapshot.exists()) {
                            friendSearchResultsContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                            return;
                        }
                        
                        friendSearchResultsContainer.innerHTML = '';
                        snapshot.forEach(child => {
                            const foundUid = child.key;
                            const foundProfile = child.val().profile;
                            
                            if (foundUid === currentUser.uid) return;
                            
                            const itemEl = createUserListItem(foundUid, foundProfile, 'search');
                            friendSearchResultsContainer.appendChild(itemEl);
                        });
                        
                        if (friendSearchResultsContainer.innerHTML === '') {
                             friendSearchResultsContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        }
                    });
                });
            }
            
            // [ìˆ˜ì •] ê³µí†µ ìœ ì € ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„± (4ê°€ì§€ íƒ€ì…)
            function createUserListItem(uid, profile, type) {
                const itemEl = document.createElement('div');
                itemEl.className = 'user-list-item';
                
                const avatar = profile.avatar || '';
                const avatarSet = AVATAR_SETS[avatar];
                let avatarHTML = '';
                if (avatarSet) {
                    avatarHTML = `<img src="${avatarSet.front}" alt="avatar">`;
                } else if (avatar && (avatar.startsWith('http') || avatar.includes('.'))) {
                    avatarHTML = `<img src="${avatar}" alt="avatar">`;
                } else {
                    avatarHTML = escapeHTML(avatar || 'â“');
                }
                
                let actionsHTML = '';
                const isMe = (uid === currentUser.uid);
                
                if (isMe) {
                    itemEl.classList.add('is-me');
                } else if (type === 'friend') {
                    actionsHTML = `
                        <button class="menu-btn user-action-btn send-message" data-action="message" data-uid="${uid}" data-nickname="${escapeHTML(profile.nickname)}">ìª½ì§€</button>
                        <button class="menu-btn user-action-btn danger" data-action="remove" data-uid="${uid}">ì‚­ì œ</button>
                    `;
                } else if (type === 'request') {
                    actionsHTML = `
                        <button class="menu-btn user-action-btn secondary" data-action="accept" data-uid="${uid}">ìˆ˜ë½</button>
                        <button class="menu-btn user-action-btn light" data-action="decline" data-uid="${uid}">ê±°ì ˆ</button>
                    `;
                } else { // 'search' ë˜ëŠ” 'online'
                    const isFriend = !!myFriendIds[uid];
                    if (isFriend) {
                        actionsHTML = `
                            <button class="menu-btn user-action-btn send-message" data-action="message" data-uid="${uid}" data-nickname="${escapeHTML(profile.nickname)}">ìª½ì§€</button>
                            <button class="menu-btn user-action-btn light" disabled>ì¹œêµ¬</button>
                        `;
                    } else {
                        actionsHTML = `
                            <button class="menu-btn user-action-btn send-message" data-action="message" data-uid="${uid}" data-nickname="${escapeHTML(profile.nickname)}">ìª½ì§€</button>
                            <button class="menu-btn user-action-btn add-friend" data-action="add" data-uid="${uid}">ì¶”ê°€</button>
                        `;
                    }
                }
                
                itemEl.innerHTML = `
                    <div class="user-list-avatar">${avatarHTML}</div>
                    <div class="user-list-nickname">${escapeHTML(profile.nickname)} ${isMe ? '(ë‚˜)' : ''}</div>
                    <div class="user-item-actions">${actionsHTML}</div>
                `;
                
                // ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                itemEl.querySelector('[data-action="remove"]')?.addEventListener('click', (e) => handleRemoveFriend(e, profile.nickname));
                itemEl.querySelector('[data-action="accept"]')?.addEventListener('click', (e) => handleAcceptRequest(e, profile));
                itemEl.querySelector('[data-action="decline"]')?.addEventListener('click', (e) => handleDeclineRequest(e));
                itemEl.querySelector('[data-action="add"]')?.addEventListener('click', (e) => handleAddFriend(e, profile));
                itemEl.querySelector('[data-action="message"]')?.addEventListener('click', (e) => {
                    if (gameSettings.sfx) clickSound.play();
                    const targetUid = e.currentTarget.dataset.uid;
                    const targetNickname = e.currentTarget.dataset.nickname;
                    openMessageModal(targetUid, targetNickname);
                });
                
                return itemEl;
            }
            
          // [ì¶”ê°€] 4. ë°›ì€ ìª½ì§€í•¨ ë¦¬ìŠ¤ë„ˆ
            function listenToMessages() {
                const messagesContainer = document.getElementById('messages-container');
                messagesContainer.innerHTML = '<div class="spinner"></div>';
                
                if (messageInboxRef && messageInboxListener) {
                    messageInboxRef.off('value', messageInboxListener);
                }

                messageInboxRef = db.ref(`user_inboxes/${currentUser.uid}`);
                
                messageInboxListener = messageInboxRef.orderByChild('timestamp').on('value', async (snapshot) => {
                    const messageBadge = tabsContainer.querySelector('[data-tab="messages"] .badge');
                    
                    if (!snapshot.exists()) {
                        messagesContainer.innerHTML = '<p style="text-align:center; color:#888; padding: 50px 0;">ë°›ì€ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                        if (messageBadge) messageBadge.remove();
                        return;
                    }
                    
                    // [ìˆ˜ì •] ëª©ë¡ ì¤‘ë³µ ë²„ê·¸ í•´ê²°
                    messagesContainer.innerHTML = '';
                    let unreadCount = 0;
                    
                    const messages = [];
                    snapshot.forEach(child => {
                        messages.push({ senderUid: child.key, ...child.val() });
                    });
                    messages.reverse(); 

                    const senderUids = [...new Set(messages.map(msg => msg.senderUid))];
                    const profilePromises = senderUids.map(uid => usersRef.child(uid).child('profile').once('value'));
                    const profileSnapshots = await Promise.all(profilePromises);
                    
                    const profiles = {};
                    profileSnapshots.forEach((snap, index) => {
                        if(snap.exists()) profiles[senderUids[index]] = snap.val();
                    });

                    messages.forEach(msg => {
                        const senderProfile = profiles[msg.senderUid] || { nickname: 'ì•Œìˆ˜ì—†ìŒ', avatar: 'â“' };
                        const itemEl = createMessageListItem(msg.senderUid, senderProfile, msg);
                        messagesContainer.appendChild(itemEl);
                    });

                    // ë±ƒì§€ì— ì•ˆ ì½ì€ ìª½ì§€ ìˆ˜ í‘œì‹œ (ì¼ë‹¨ ì „ì²´ ê°œìˆ˜ë¡œ)
                    const count = messages.length;
                    if (count > 0) {
                        if (messageBadge) {
                            messageBadge.textContent = count > 9 ? '9+' : count;
                        } else {
                            const newBadge = document.createElement('span');
                            newBadge.className = 'badge';
                            newBadge.textContent = count > 9 ? '9+' : count;
                            tabsContainer.querySelector('[data-tab="messages"]').appendChild(newBadge);
                        }
                    } else {
                        if (messageBadge) messageBadge.remove();
                    }
                });
            }
            
            // [ì¶”ê°€] 5. ìª½ì§€ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ìƒì„±
            function createMessageListItem(senderUid, senderProfile, msgData) {
                const itemEl = document.createElement('div');
                itemEl.className = 'message-list-item';

                const avatar = senderProfile.avatar || '';
                const avatarSet = AVATAR_SETS[avatar];
                let avatarHTML = '';
                if (avatarSet) { avatarHTML = `<img src="${avatarSet.front}" alt="av">`; }
                else if (avatar.startsWith('http') || avatar.includes('.')) { avatarHTML = `<img src="${avatar}" alt="av">`; }
                else { avatarHTML = escapeHTML(avatar || 'â“'); }

                itemEl.innerHTML = `
                    <div class="message-header">
                        <div class="message-avatar">${avatarHTML}</div>
                        <span class="message-sender">${escapeHTML(senderProfile.nickname)}</span>
                        <span class="message-time">${formatTimeAgo(msgData.timestamp)}</span>
                    </div>
                    <div class="message-content">
                        ${escapeHTML(msgData.lastMessage)}
                    </div>
                    <div class="message-actions">
                        <button class="menu-btn user-action-btn secondary" data-action="reply">ë‹µì¥</button>
                        <button class="menu-btn user-action-btn light" data-action="delete">ì‚­ì œ</button>
                    </div>
                `;
                
                // ë‹µì¥ ë²„íŠ¼
                itemEl.querySelector('[data-action="reply"]').addEventListener('click', () => {
                    openMessageModal(senderUid, senderProfile.nickname);
                });
                
                // ì‚­ì œ ë²„íŠ¼
                itemEl.querySelector('[data-action="delete"]').addEventListener('click', () => {
                    if (gameSettings.sfx) clickSound.play();
                    if (confirm('ì´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ìƒëŒ€ë°©ì—ê² ìœ ì§€ë©ë‹ˆë‹¤)')) {
                        db.ref(`user_inboxes/${currentUser.uid}/${senderUid}`).remove();
                        // .on('value') ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ ëª©ë¡ì„ ê°±ì‹ í•©ë‹ˆë‹¤.
                    }
                });

                return itemEl;
            }

            // --- ì¹œêµ¬ ê´€ë¦¬ ì•¡ì…˜ í•¸ë“¤ëŸ¬ (ê²½ë¡œ ìˆ˜ì •) ---
            
            // [ìˆ˜ì •] ì¹œêµ¬ ì¶”ê°€ (ê²½ë¡œ: friend_requests, ë°ì´í„°: TIMESTAMP)
            function handleAddFriend(e, targetProfile) {
                if (gameSettings.sfx) clickSound.play();
                const targetUid = e.currentTarget.dataset.uid;
                e.currentTarget.disabled = true;
                e.currentTarget.textContent = 'ìš”ì²­ë¨';
                
                // [ìˆ˜ì •] Firebase ê·œì¹™ì— ë§ê²Œ ê²½ë¡œ ë° ë°ì´í„° ìˆ˜ì •
                db.ref(`friend_requests/${targetUid}/${currentUser.uid}`).set(
                    firebase.database.ServerValue.TIMESTAMP
                ).then(() => {
                    showToast(`${targetProfile.nickname}ë‹˜ì—ê²Œ ì¹œêµ¬ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.`);
                }).catch((err) => {
                     showToast(`ìš”ì²­ ì‹¤íŒ¨: ${err.message}`);
                     e.currentTarget.disabled = false;
                     e.currentTarget.textContent = 'ì¶”ê°€';
                });
            }
            
            // [ìˆ˜ì •] ì¹œêµ¬ ì‚­ì œ (ê²½ë¡œ: friends)
            function handleRemoveFriend(e, friendNickname) {
                if (gameSettings.sfx) clickSound.play();
                // [ìˆ˜ì •] confirm()ì€ iframe í™˜ê²½ì—ì„œ ì‘ë™í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, window.confirm() ì‚¬ìš©
                if (!window.confirm(`${friendNickname}ë‹˜ì„ ì¹œêµ¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                const friendUid = e.currentTarget.dataset.uid;
                
                const updates = {};
                updates[`/friends/${currentUser.uid}/${friendUid}`] = null;
                updates[`/friends/${friendUid}/${currentUser.uid}`] = null;
                db.ref().update(updates).then(() => {
                    showToast(`${friendNickname}ë‹˜ì„ ì¹œêµ¬ì—ì„œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.`);
                    // 'on' ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ UIë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.
                });
            }
            
            // [ìˆ˜ì •] ì¹œêµ¬ ìˆ˜ë½ (ê²½ë¡œ: friends, friend_requests)
            function handleAcceptRequest(e, requesterProfile) {
                if (gameSettings.sfx) clickSound.play();
                const requesterUid = e.currentTarget.dataset.uid;
                
                const updates = {};
                updates[`/friends/${currentUser.uid}/${requesterUid}`] = true;
                updates[`/friends/${requesterUid}/${currentUser.uid}`] = true;
                updates[`/friend_requests/${currentUser.uid}/${requesterUid}`] = null;
                
                db.ref().update(updates).then(() => {
                    showToast(`${requesterProfile.nickname}ë‹˜ì˜ ì¹œêµ¬ ìš”ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.`);
                });
            }
            
            // [ìˆ˜ì •] ì¹œêµ¬ ê±°ì ˆ (ê²½ë¡œ: friend_requests)
            function handleDeclineRequest(e) {
                if (gameSettings.sfx) clickSound.play();
                const requesterUid = e.currentTarget.dataset.uid;
                
                db.ref(`friend_requests/${currentUser.uid}/${requesterUid}`).remove().then(() => {
                    showToast('ì¹œêµ¬ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.');
                });
            }

            // [ì‹ ê·œ] ìª½ì§€ ëª¨ë‹¬ ì—´ê¸° (í†µí•©ëŒ€ê¸°ì‹¤.htmlì—ì„œ ë³µì‚¬)
            function openMessageModal(targetUid, targetNickname) {
                messageModal.dataset.chattingWith = targetUid;
                if (currentMessagesRef && currentMessageListener) {
                    currentMessagesRef.off('child_added', currentMessageListener);
                }

                messageModal.querySelector('#message-modal-nickname').textContent = `${escapeHTML(targetNickname)}ë‹˜ê³¼ ëŒ€í™”`;
                const messageInput = messageModal.querySelector('#message-input');
                const messageSendBtn = messageModal.querySelector('#message-send-btn');
                const messageHistory = messageModal.querySelector('#message-history');
                messageInput.value = '';
                messagesLoaded = false;

                messageInput.onkeydown = (e) => {
                    if (e.key === 'Enter' && !e.isComposing) {
                        e.preventDefault();
                        messageSendBtn.click();
                    }
                };
                
                messageHistory.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';
                
                const myUid = currentUser.uid;
                const chatId = [myUid, targetUid].sort().join('_');
                currentMessagesRef = db.ref(`messages/${chatId}`);

                messageSendBtn.onclick = () => {
                    const message = messageInput.value.trim();
                    if (message === '') return;
                    
                    messageInput.value = '';
                    messageInput.focus();
                    
                    const messageData = {
                        senderUid: myUid,
                        message: message,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };

                    currentMessagesRef.push(messageData)
                        .then(() => {
                            db.ref(`user_inboxes/${targetUid}/${myUid}`).set({
                                lastMessage: message,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                        })
                        .catch(error => {
                            console.error("ìª½ì§€ ì „ì†¡ ì‹¤íŒ¨:", error);
                            showToast("ìª½ì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                            messageInput.value = message;
                        });
                };

                currentMessagesRef.orderByChild('timestamp').limitToLast(50).once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        messageHistory.innerHTML = '<p style="text-align:center; color:#888; padding: 40px;">ì•„ì§ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        messagesLoaded = true;
                    }
                });

                currentMessageListener = (snapshot) => {
                    if (!messagesLoaded) {
                        messageHistory.innerHTML = '';
                        messagesLoaded = true;
                    }
                    
                    const data = snapshot.val();
                    if (!data) return;
                    
                    const isMe = data.senderUid === myUid;
                    const msgEl = createMessageBubble(data.message, data.timestamp, isMe);
                    
                    messageHistory.prepend(msgEl);
                };
                
                currentMessagesRef.orderByChild('timestamp').limitToLast(50).on('child_added', currentMessageListener);

                messageModal.classList.add('active');
                setTimeout(() => messageInput.focus(), 300);
            }

            // [ì‹ ê·œ] ìª½ì§€ ë§í’ì„  DOM ìƒì„±
            function createMessageBubble(message, timestamp, isMe) {
                const msgEl = document.createElement('div');
                msgEl.className = 'msg-bubble';
                
                const contentEl = document.createElement('div');
                contentEl.className = 'msg-content';
                contentEl.textContent = escapeHTML(message);

                const timeEl = document.createElement('span');
                timeEl.className = 'msg-time';
                timeEl.textContent = formatTime(timestamp);

                if (isMe) {
                    msgEl.classList.add('my-message');
                    contentEl.classList.add('my-message');
                    msgEl.appendChild(timeEl);
                    msgEl.appendChild(contentEl);
                } else {
                    msgEl.appendChild(contentEl);
                    msgEl.appendChild(timeEl);
                }
                return msgEl;
            }

            // [ì‹ ê·œ] ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
            messageModal.querySelector('[data-close]').addEventListener('click', () => {
                if (gameSettings.sfx) clickSound.play();
                messageModal.classList.remove('active');
                if (currentMessagesRef && currentMessageListener) {
                    currentMessagesRef.off('child_added', currentMessageListener);
                    currentMessagesRef = null;
                    currentMessageListener = null;
                    messagesLoaded = false;
                    delete messageModal.dataset.chattingWith;
                }
            });

        });
    </script>
</body>
</html>